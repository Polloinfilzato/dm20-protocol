---
name: Content extraction - spells, monsters, feats, items
status: completed
created: 2026-02-02T20:05:44Z
updated: 2026-02-02T20:11:56Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/26
depends_on: [25]
parallel: false
conflicts_with: []
---

# Task: Content extraction - spells, monsters, feats, items

## Description

Extend the `ContentExtractor` to handle additional content types: spells, monsters, feats, and items. These have simpler structures than classes/races but each has unique parsing requirements.

## Acceptance Criteria

- [ ] Implement spell extraction with all standard fields
- [ ] Implement monster stat block extraction
- [ ] Implement feat extraction
- [ ] Implement magic item extraction
- [ ] Handle table extraction for stat blocks (using pdfplumber if needed)
- [ ] Update `extract_content` MCP tool to support all types
- [ ] Unit tests for each content type

## Technical Details

### Files to Modify

```
src/gamemaster_mcp/library/extractors/
└── content.py          # UPDATE: Add extraction methods
```

### Spell Parsing

```python
SPELL_PATTERNS = {
    "level": r"(\d+)(?:st|nd|rd|th)?[- ]level|cantrip",
    "school": r"(abjuration|conjuration|divination|enchantment|evocation|illusion|necromancy|transmutation)",
    "casting_time": r"Casting Time:\s*(.+)",
    "range": r"Range:\s*(.+)",
    "components": r"Components:\s*([VSM,\s]+)(?:\((.+)\))?",
    "duration": r"Duration:\s*(.+)",
    "classes": r"Classes?:\s*(.+)",
}

async def extract_spell(self, spell_name: str) -> SpellDefinition:
    entry = self._find_entry(spell_name, ContentType.SPELL)
    text = self._extract_text(self._get_pages_for_entry(entry))
    return SpellDefinition(
        index=slugify(spell_name),
        name=spell_name,
        level=self._parse_spell_level(text),
        school=self._parse_spell_school(text),
        casting_time=self._extract_field(text, "casting_time"),
        range=self._extract_field(text, "range"),
        components=self._parse_components(text),
        duration=self._extract_field(text, "duration"),
        description=self._extract_description(text),
        classes=self._parse_spell_classes(text),
    )
```

### Monster Stat Block Parsing

```python
MONSTER_PATTERNS = {
    "size_type": r"(Tiny|Small|Medium|Large|Huge|Gargantuan)\s+(aberration|beast|celestial|construct|dragon|elemental|fey|fiend|giant|humanoid|monstrosity|ooze|plant|undead)",
    "armor_class": r"Armor Class\s+(\d+)(?:\s*\((.+)\))?",
    "hit_points": r"Hit Points\s+(\d+)\s*\((.+)\)",
    "speed": r"Speed\s+(.+)",
    "abilities": r"STR\s+(\d+).+DEX\s+(\d+).+CON\s+(\d+).+INT\s+(\d+).+WIS\s+(\d+).+CHA\s+(\d+)",
    "challenge": r"Challenge\s+(\d+(?:/\d+)?)\s*\((.+)\s*XP\)",
}

async def extract_monster(self, monster_name: str) -> MonsterDefinition:
    entry = self._find_entry(monster_name, ContentType.MONSTER)
    text = self._extract_text(self._get_pages_for_entry(entry))

    # Try table extraction for stat block if regex fails
    if not self._has_stat_block(text):
        text = self._extract_with_pdfplumber(entry)

    return self._parse_monster(text, monster_name)
```

### Feat Parsing

```python
FEAT_PATTERNS = {
    "prerequisite": r"Prerequisite:\s*(.+)",
}

async def extract_feat(self, feat_name: str) -> FeatDefinition:
    entry = self._find_entry(feat_name, ContentType.FEAT)
    text = self._extract_text(self._get_pages_for_entry(entry))
    return FeatDefinition(
        index=slugify(feat_name),
        name=feat_name,
        prerequisite=self._extract_field(text, "prerequisite"),
        description=self._extract_description(text),
    )
```

### Item Parsing

```python
ITEM_PATTERNS = {
    "rarity": r"(common|uncommon|rare|very rare|legendary|artifact)",
    "type": r"(Wondrous item|Weapon|Armor|Ring|Rod|Staff|Wand|Potion|Scroll)",
    "attunement": r"requires attunement(?:\s+by\s+(.+))?",
}

async def extract_item(self, item_name: str) -> ItemDefinition:
    entry = self._find_entry(item_name, ContentType.ITEM)
    text = self._extract_text(self._get_pages_for_entry(entry))
    return ItemDefinition(
        index=slugify(item_name),
        name=item_name,
        rarity=self._parse_rarity(text),
        type=self._parse_item_type(text),
        requires_attunement=self._check_attunement(text),
        description=self._extract_description(text),
    )
```

### Optional: pdfplumber for Tables

```python
def _extract_with_pdfplumber(self, entry: TOCEntry) -> str:
    """Use pdfplumber for complex table extraction."""
    import pdfplumber

    with pdfplumber.open(self.pdf_path) as pdf:
        page = pdf.pages[entry.page - 1]
        tables = page.extract_tables()
        # Convert tables to text format
        ...
```

## Dependencies

- [ ] Task #24 (ContentExtractor base implementation)

## Effort Estimate

- Size: M
- Hours: 4-6
- Parallel: false (builds on #24)

## Definition of Done

- [ ] Spell extraction working with all fields
- [ ] Monster stat block extraction working
- [ ] Feat extraction working
- [ ] Item extraction working
- [ ] Table extraction fallback implemented
- [ ] All content types tested
- [ ] Performance acceptable (< 30s per item)
