---
name: Content extraction - classes and races
status: completed
created: 2026-02-02T20:05:44Z
updated: 2026-02-02T20:11:56Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/25
depends_on: [23, 24]
parallel: true
conflicts_with: [26]
---

# Task: Content extraction - classes and races

## Description

Implement the `ContentExtractor` class that extracts full content from PDF pages and converts it to `CustomSource` JSON format. This task focuses on the two most complex content types: classes (with subclasses, levels, features) and races (with subraces, traits).

## Acceptance Criteria

- [ ] Create `ContentExtractor` class in `src/gamemaster_mcp/library/extractors/content.py`
- [ ] Extract class definitions from PDF pages
- [ ] Parse class features by level
- [ ] Extract subclass information
- [ ] Extract race definitions from PDF pages
- [ ] Parse racial traits and ability bonuses
- [ ] Extract subrace information
- [ ] Output in `CustomSource` JSON format
- [ ] Save extracted content to `library/extracted/{source_id}/`
- [ ] Implement `extract_content` MCP tool
- [ ] Handle multi-page content correctly
- [ ] Unit tests with sample content

## Technical Details

### Files to Create/Modify

```
src/gamemaster_mcp/library/extractors/
├── __init__.py         # UPDATE: Export ContentExtractor
└── content.py          # NEW: ContentExtractor class

src/gamemaster_mcp/
└── main.py             # UPDATE: Add extract_content tool
```

### ContentExtractor Interface

```python
class ContentExtractor:
    def __init__(self, pdf_path: Path, index: LibraryIndex):
        self.pdf_path = pdf_path
        self.index = index

    async def extract_class(self, class_name: str) -> ClassDefinition:
        """Extract a class definition from the PDF."""
        entry = self._find_entry(class_name, ContentType.CLASS)
        pages = self._get_pages_for_entry(entry)
        text = self._extract_text(pages)
        return self._parse_class(text, entry)

    async def extract_race(self, race_name: str) -> RaceDefinition:
        """Extract a race definition from the PDF."""
        ...

    def _find_entry(self, name: str, content_type: ContentType) -> TOCEntry: ...
    def _get_pages_for_entry(self, entry: TOCEntry) -> range: ...
    def _extract_text(self, pages: range) -> str: ...
    def _parse_class(self, text: str, entry: TOCEntry) -> ClassDefinition: ...
    def _parse_race(self, text: str, entry: TOCEntry) -> RaceDefinition: ...
```

### Class Parsing Patterns

```python
CLASS_PATTERNS = {
    "hit_die": r"Hit Dice?:\s*(\d+d\d+)",
    "primary_ability": r"Primary Ability:\s*(.+)",
    "saving_throws": r"Saving Throws?:\s*(.+)",
    "armor_proficiencies": r"Armor:\s*(.+)",
    "weapon_proficiencies": r"Weapons?:\s*(.+)",
    "level_feature": r"(\d+)(?:st|nd|rd|th)\s+Level:\s*(.+)",
}
```

### Race Parsing Patterns

```python
RACE_PATTERNS = {
    "ability_score": r"Ability Score Increase\.?\s*(.+)",
    "size": r"Size\.?\s*(Small|Medium|Large)",
    "speed": r"Speed\.?\s*(\d+)\s*(?:feet|ft)",
    "trait": r"([A-Z][a-z\s]+)\.?\s+(.+?)(?=\n[A-Z]|\Z)",
}
```

### Output Format (CustomSource compatible)

```json
{
  "$schema": "gamemaster-mcp/rulebook-v1",
  "name": "Dragon Knight (Tome of Heroes)",
  "version": "extracted-2026-02-02",
  "metadata": {
    "source_pdf": "tome-of-heroes",
    "source_page": 47,
    "extracted_at": "2026-02-02T15:00:00Z"
  },
  "content": {
    "classes": [{
      "index": "dragon-knight",
      "name": "Dragon Knight",
      "hit_die": "d10",
      "primary_ability": "Strength or Charisma",
      "saving_throws": ["Constitution", "Charisma"],
      "proficiencies": {
        "armor": ["light", "medium", "heavy", "shields"],
        "weapons": ["simple", "martial"]
      },
      "levels": {
        "1": {"features": ["Draconic Bloodline", "Dragon Aspect"]},
        "2": {"features": ["Fighting Style", "Dragon Breath"]},
        ...
      }
    }]
  }
}
```

### MCP Tool

```python
@mcp.tool
async def extract_content(
    source_id: str,
    content_name: str,
    content_type: Literal["class", "race", "spell", "monster", "feat", "item"]
) -> str:
    """
    Extract specific content from a library PDF.

    Args:
        source_id: The source identifier (e.g., "tome-of-heroes")
        content_name: Name of the content to extract (e.g., "Dragon Knight")
        content_type: Type of content to extract

    Returns confirmation with extracted content summary.
    """
    ...
```

## Dependencies

- [ ] Task #22 (TOCExtractor for page locations)
- [ ] Task #23 (IndexStore for loading indexes)

## Effort Estimate

- Size: L
- Hours: 6-8
- Parallel: true (can run with #25 after dependencies met)

## Definition of Done

- [ ] Class extraction working for well-formatted PDFs
- [ ] Race extraction working for well-formatted PDFs
- [ ] Output compatible with CustomSource loader
- [ ] Extracted files saved to correct location
- [ ] MCP tool accessible and working
- [ ] Performance: < 30s per extraction
- [ ] Unit tests with real PDF content
