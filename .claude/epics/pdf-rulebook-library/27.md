---
name: Campaign bindings and enable/disable MCP tools
status: completed
created: 2026-02-02T20:05:44Z
updated: 2026-02-02T20:11:56Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/27
depends_on: [24]
parallel: true
conflicts_with: []
---

# Task: Campaign bindings and enable/disable MCP tools

## Description

Implement the campaign binding system that tracks which library content is enabled for each campaign. Create MCP tools to enable/disable library sources and view current bindings.

## Acceptance Criteria

- [ ] Create `LibraryBindings` class in `src/gamemaster_mcp/library/bindings.py`
- [ ] Store bindings in `{campaign}/rulebooks/library-bindings.json`
- [ ] Implement `enable_library_source` MCP tool
- [ ] Implement `disable_library_source` MCP tool
- [ ] Implement `list_enabled_library` MCP tool
- [ ] Support enabling entire source or specific content
- [ ] Load bindings when campaign loads
- [ ] Save bindings on change
- [ ] Unit tests for bindings

## Technical Details

### Files to Create/Modify

```
src/gamemaster_mcp/library/
├── bindings.py         # NEW: LibraryBindings class
└── manager.py          # UPDATE: Integrate bindings

src/gamemaster_mcp/
├── storage.py          # UPDATE: Load/save bindings
└── main.py             # UPDATE: Add MCP tools
```

### LibraryBindings Class

```python
@dataclass
class SourceBinding:
    source_id: str
    enabled: bool = True
    content_filter: dict[ContentType, list[str] | Literal["*"]] = field(default_factory=dict)

@dataclass
class LibraryBindings:
    campaign_id: str
    updated_at: datetime
    sources: dict[str, SourceBinding] = field(default_factory=dict)

    def enable_source(self, source_id: str, content: list[str] | None = None) -> None:
        """Enable a library source for this campaign."""
        if source_id not in self.sources:
            self.sources[source_id] = SourceBinding(source_id=source_id)
        self.sources[source_id].enabled = True
        if content:
            # Enable specific content only
            ...
        self.updated_at = datetime.now(timezone.utc)

    def disable_source(self, source_id: str) -> None:
        """Disable a library source for this campaign."""
        if source_id in self.sources:
            self.sources[source_id].enabled = False
        self.updated_at = datetime.now(timezone.utc)

    def is_content_enabled(self, source_id: str, content_type: ContentType, content_name: str) -> bool:
        """Check if specific content is enabled."""
        ...

    def get_enabled_sources(self) -> list[str]:
        """Get list of enabled source IDs."""
        return [s.source_id for s in self.sources.values() if s.enabled]
```

### Persistence Format

```json
{
  "campaign_id": "my_campaign",
  "updated_at": "2026-02-02T16:00:00Z",
  "sources": {
    "tome-of-heroes": {
      "source_id": "tome-of-heroes",
      "enabled": true,
      "content_filter": {
        "classes": ["dragon-knight", "spell-blade"],
        "races": "*",
        "spells": "*"
      }
    },
    "deep-magic": {
      "source_id": "deep-magic",
      "enabled": true,
      "content_filter": {
        "spells": "*"
      }
    }
  }
}
```

### MCP Tools

```python
@mcp.tool
async def enable_library_source(
    source_id: str,
    content_type: Literal["all", "class", "race", "spell", "monster", "feat", "item"] = "all",
    content_names: list[str] | None = None
) -> str:
    """
    Enable a library source for the current campaign.

    Args:
        source_id: The source to enable (e.g., "tome-of-heroes")
        content_type: Type of content to enable ("all" for everything)
        content_names: Specific items to enable (None for all of type)

    Returns confirmation of enabled content.
    """
    ...

@mcp.tool
async def disable_library_source(source_id: str) -> str:
    """
    Disable a library source for the current campaign.

    Args:
        source_id: The source to disable

    Returns confirmation.
    """
    ...

@mcp.tool
async def list_enabled_library() -> str:
    """
    List all library content enabled for the current campaign.

    Returns formatted list of enabled sources and content.
    """
    ...
```

### Integration with Storage

```python
# In DnDStorage
def _load_library_bindings(self) -> LibraryBindings | None:
    bindings_path = self.campaign_dir / "rulebooks" / "library-bindings.json"
    if bindings_path.exists():
        data = json.loads(bindings_path.read_text())
        return LibraryBindings(**data)
    return None

def _save_library_bindings(self, bindings: LibraryBindings) -> None:
    bindings_path = self.campaign_dir / "rulebooks" / "library-bindings.json"
    bindings_path.parent.mkdir(parents=True, exist_ok=True)
    bindings_path.write_text(json.dumps(asdict(bindings), default=str))
```

## Dependencies

- [ ] Task #23 (IndexStore for source validation)

## Effort Estimate

- Size: M
- Hours: 4-6
- Parallel: true (independent of extraction tasks)

## Definition of Done

- [ ] Bindings persist to JSON
- [ ] Bindings load with campaign
- [ ] Enable/disable tools working
- [ ] Content filtering working
- [ ] List tool shows correct state
- [ ] Unit tests passing
