---
name: Markdown file support
status: completed
created: 2026-02-02T20:05:44Z
updated: 2026-02-02T20:11:56Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/29
depends_on: [23, 25]
parallel: true
conflicts_with: []
---

# Task: Markdown file support

## Description

Extend the library system to support Markdown files in addition to PDFs. Markdown is commonly used for homebrew content and is simpler to parse. The system should auto-detect file type and use appropriate extractors.

## Acceptance Criteria

- [ ] Create `MarkdownExtractor` class for TOC extraction from headers
- [ ] Extend `ContentExtractor` to parse Markdown content
- [ ] Auto-detect file type (PDF vs Markdown) in `scan_library`
- [ ] Support `.md` files in `library/pdfs/` folder
- [ ] Index Markdown files by header structure
- [ ] Extract content sections by header boundaries
- [ ] Unit tests for Markdown processing

## Technical Details

### Files to Create/Modify

```
src/gamemaster_mcp/library/extractors/
├── toc.py              # UPDATE: Add MarkdownTOCExtractor
└── content.py          # UPDATE: Add Markdown parsing
```

### MarkdownTOCExtractor

```python
class MarkdownTOCExtractor:
    """Extract TOC from Markdown header structure."""

    def __init__(self, md_path: Path):
        self.md_path = md_path

    async def extract(self) -> LibraryIndex:
        content = self.md_path.read_text()
        headers = self._extract_headers(content)
        toc = self._build_toc_tree(headers)

        return LibraryIndex(
            source_id=slugify(self.md_path.stem),
            filename=self.md_path.name,
            indexed_at=datetime.now(timezone.utc),
            file_hash=self._calculate_hash(),
            total_pages=0,  # Not applicable for Markdown
            toc=toc,
            content_summary=self._count_content_types(toc),
        )

    def _extract_headers(self, content: str) -> list[tuple[int, str, int]]:
        """Extract headers with level, title, and line number."""
        headers = []
        for i, line in enumerate(content.split("\n")):
            if match := re.match(r"^(#{1,6})\s+(.+)", line):
                level = len(match.group(1))
                title = match.group(2).strip()
                headers.append((level, title, i))
        return headers

    def _build_toc_tree(self, headers: list) -> list[TOCEntry]:
        """Convert flat header list to hierarchical TOC."""
        ...

    def _identify_content_type(self, title: str) -> ContentType | None:
        """Same logic as PDF extractor."""
        ...
```

### Markdown Content Extraction

```python
class MarkdownContentExtractor:
    """Extract content from Markdown files."""

    def __init__(self, md_path: Path, index: LibraryIndex):
        self.md_path = md_path
        self.index = index
        self._content = md_path.read_text()
        self._lines = self._content.split("\n")

    def _get_section(self, entry: TOCEntry) -> str:
        """Extract text between this header and the next same-level header."""
        start_line = entry.page  # We store line number in page field for MD
        end_line = self._find_section_end(start_line, entry.level)
        return "\n".join(self._lines[start_line:end_line])

    def _find_section_end(self, start: int, level: int) -> int:
        """Find where this section ends."""
        for i, line in enumerate(self._lines[start + 1:], start=start + 1):
            if match := re.match(r"^(#{1,6})\s+", line):
                if len(match.group(1)) <= level:
                    return i
        return len(self._lines)

    async def extract_class(self, class_name: str) -> ClassDefinition:
        """Extract class from Markdown section."""
        entry = self._find_entry(class_name, ContentType.CLASS)
        section = self._get_section(entry)
        return self._parse_class_md(section, class_name)

    def _parse_class_md(self, section: str, name: str) -> ClassDefinition:
        """Parse class definition from Markdown format."""
        # Markdown homebrew often uses tables and lists
        hit_die = self._extract_from_table(section, "Hit Die")
        features = self._extract_features_from_md(section)
        ...
```

### Auto-Detection in LibraryManager

```python
class LibraryManager:
    def scan_library(self) -> list[Path]:
        """Scan for both PDF and Markdown files."""
        files = []
        for pattern in ["*.pdf", "*.md"]:
            files.extend(self.pdfs_dir.glob(pattern))
        return sorted(files)

    def get_extractor(self, file_path: Path) -> TOCExtractorBase:
        """Get appropriate extractor based on file type."""
        if file_path.suffix.lower() == ".pdf":
            return TOCExtractor(file_path)
        elif file_path.suffix.lower() == ".md":
            return MarkdownTOCExtractor(file_path)
        else:
            raise ValueError(f"Unsupported file type: {file_path.suffix}")

    def get_content_extractor(self, file_path: Path, index: LibraryIndex):
        """Get appropriate content extractor based on file type."""
        if file_path.suffix.lower() == ".pdf":
            return ContentExtractor(file_path, index)
        elif file_path.suffix.lower() == ".md":
            return MarkdownContentExtractor(file_path, index)
        ...
```

### Example Markdown Format

```markdown
# Homebrew Classes

## Magus

A class that blends martial prowess with arcane power.

### Hit Points

- **Hit Dice:** 1d8 per magus level
- **Hit Points at 1st Level:** 8 + your Constitution modifier

### Proficiencies

- **Armor:** Light armor
- **Weapons:** Simple weapons, longswords, rapiers
- **Saving Throws:** Intelligence, Constitution

### Class Features

#### 1st Level: Arcane Blade

You learn to infuse your weapon attacks with magical energy...

#### 2nd Level: Spellstrike

When you cast a spell that requires an attack roll...
```

## Dependencies

- [ ] Task #22 (Base TOC extraction patterns)
- [ ] Task #24 (Base content extraction patterns)

## Effort Estimate

- Size: M
- Hours: 4-6
- Parallel: true (can work alongside PDF extraction)

## Definition of Done

- [ ] Markdown files detected in library scan
- [ ] TOC extracted from header structure
- [ ] Content extraction works for all types
- [ ] Search includes Markdown sources
- [ ] Unit tests with sample Markdown fixtures
- [ ] Integration with existing library flow
