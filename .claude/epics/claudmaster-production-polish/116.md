---
name: End-to-End Integration Test Suite
status: open
created: 2026-02-15T01:33:47Z
updated: 2026-02-15T01:39:36Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/116
depends_on: []
parallel: true
conflicts_with: []
---

# Task: End-to-End Integration Test Suite

## Description
Create a comprehensive integration test suite that validates the full Claudmaster game loop under realistic conditions using MockLLMClient. These tests exercise the complete pipeline — from player input through intent classification, agent routing, parallel execution, response aggregation, and session updates — catching integration issues that unit tests miss.

## Acceptance Criteria
- [ ] Exploration flow test: player input → EXPLORATION intent → Narrator + Arbiter routing → aggregated response
- [ ] Combat flow test: `start_combat` → initiative rolls → turn-by-turn resolution → `end_combat` → XP calculation
- [ ] Social/roleplay flow test: NPC interaction → Arbiter resolution → consistency engine tracking
- [ ] Session lifecycle test: start session → multi-turn play → save → load → resume → verify state continuity
- [ ] Error scenario tests: agent timeout → fallback; invalid input → clarification; missing campaign → helpful error
- [ ] All tests pass with `pytest` using MockLLMClient (no real API calls)
- [ ] Tests are in `tests/claudmaster/test_integration_e2e.py`

## Technical Details
- Use existing `MockLLMClient` from `llm_client.py` for deterministic responses
- Use existing async test patterns from `test_manual_integration.py` as reference
- Test the full Orchestrator pipeline: `classify_intent()` → `_get_agents_for_intent()` → `process_player_input()` → `_aggregate_responses()`
- Verify state changes propagate correctly through `ClaudmasterSession`
- Test agent timeout handling (configure short timeouts for test)
- Validate `ErrorMessageFormatter` produces in-character messages for each error type

## Dependencies
- [ ] None — uses existing test infrastructure

## Effort Estimate
- Size: M
- Hours: 4-6
- Parallel: true (only creates new test files)

## Definition of Done
- [ ] Code implemented
- [ ] 5+ end-to-end scenarios passing
- [ ] Tests run in < 30 seconds (no API calls)
- [ ] No flaky tests (deterministic MockLLMClient responses)
