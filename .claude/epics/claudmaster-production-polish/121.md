---
name: RAG Activation — ModuleKeeper Wiring + Library Vector Search
status: open
created: 2026-02-15T01:33:47Z
updated: 2026-02-15T01:39:36Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/121
depends_on: [119, 120]
parallel: false
conflicts_with: [118, 119, 120]
---

# Task: RAG Activation — ModuleKeeper Wiring + Library Vector Search

## Description
Activate the fully-implemented but unwired ChromaDB/RAG infrastructure. This task has two parts: (A) wire the existing ModuleKeeperAgent into Claudmaster sessions so it provides contextual lore during gameplay, and (B) upgrade LibrarySearch from TF-IDF keyword matching to ChromaDB vector embeddings for semantic rulebook retrieval. Both must degrade gracefully when chromadb/sentence-transformers are not installed.

## Acceptance Criteria

### Part A: ModuleKeeper Wiring
- [ ] ModuleKeeperAgent is registered during `start_claudmaster_session()` (resolve existing TODO)
- [ ] Orchestrator routes EXPLORATION and QUESTION intents to ModuleKeeper
- [ ] VectorStoreManager initializes with campaign-specific storage path
- [ ] Adventure module content is indexed on first session start (skip if already indexed)
- [ ] ModuleKeeper provides contextual NPC/location/plot info during gameplay

### Part B: Library Vector Search
- [ ] `scan_library()` generates ChromaDB embeddings alongside existing index files
- [ ] `ask_books()` uses vector similarity search instead of TF-IDF when chromadb is available
- [ ] `search_library()` uses vector similarity with metadata filtering by content_type
- [ ] Per-source collections in ChromaDB (namespace: `library_{source_id}`)
- [ ] Conceptual queries (e.g., "tanky frontline build") find semantically relevant sections

### Part C: Graceful Degradation
- [ ] System detects chromadb/sentence-transformers availability at import time
- [ ] Falls back to existing TF-IDF search silently when RAG deps not installed
- [ ] One-time log warning about optional deps for better search
- [ ] All public APIs work identically regardless of backend
- [ ] Tests pass both with and without chromadb installed

## Technical Details

### Part A — ModuleKeeper Wiring
- Resolve TODO in `tools/session_tools.py`: register ModuleKeeperAgent in SessionManager
- Add ModuleKeeper to `orchestrator.py` `_get_agents_for_intent()` for EXPLORATION, QUESTION
- Use existing `VectorStoreManager` from `claudmaster/vector_store.py`
- Use existing `ModuleIndexer` from `claudmaster/module_indexer.py` for content indexing
- Storage path: `{campaign_path}/claudmaster_sessions/vector_store/`

### Part B — Library Vector Search
- Extend `VectorStoreManager` usage to `library/search.py` (or create `library/vector_search.py`)
- Reuse `ModuleIndexer` chunking logic for library content (500 char chunks, 100 char overlap)
- During `scan_library()`: after building TOC index, also chunk and embed content into ChromaDB
- Collection naming: `library_{source_id}` (e.g., `library_tome-of-heroes`)
- Replace scoring in `LibrarySearch._score_entry()` with ChromaDB `collection.query()`
- Keep `LibrarySearch` as fallback class; create `VectorLibrarySearch` as upgrade

### Part C — Degradation
- Existing try/except pattern in `vector_store.py` already handles missing deps
- Add similar pattern in `library/search.py`: `try: from ..claudmaster.vector_store import VectorStoreManager`
- `LibraryManager` chooses search backend at init time based on available deps

## Dependencies
- [ ] #119 — Onboarding flow (session_tools.py modifications must be stable)
- [ ] #120 — Session recap (session_tools.py modifications must be stable)

## Effort Estimate
- Size: L
- Hours: 6-8
- Parallel: false (modifies session_tools.py, orchestrator.py, library/search.py)

## Definition of Done
- [ ] ModuleKeeper active during Claudmaster sessions
- [ ] Library search uses vector embeddings when chromadb available
- [ ] Graceful fallback to TF-IDF when chromadb not installed
- [ ] Tests for both RAG and fallback paths
- [ ] Indexing performance < 60s per PDF
- [ ] Search query time < 2s
