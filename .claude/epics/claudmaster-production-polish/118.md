---
name: Error UX Hardening
status: open
created: 2026-02-15T01:33:47Z
updated: 2026-02-15T01:39:36Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/118
depends_on: [116]
parallel: false
conflicts_with: [119, 120, 121]
---

# Task: Error UX Hardening

## Description
Ensure every player-facing code path wraps errors with `ErrorMessageFormatter` to produce in-character messages that maintain D&D immersion. No raw Python exceptions, stacktraces, or technical error messages should ever reach the player. Add timeout fallback responses and input validation for edge cases.

## Acceptance Criteria
- [ ] `player_action()` in `action_tools.py` wraps all exceptions with `ErrorMessageFormatter`
- [ ] `start_claudmaster_session()` in `session_tools.py` wraps all exceptions with in-character messages
- [ ] Agent timeout produces degraded but functional response (not an error)
- [ ] Empty/ambiguous player input triggers in-character clarification request
- [ ] Missing campaign data produces helpful in-character message with guidance
- [ ] Zero raw Python errors can reach player output (verified by integration tests)
- [ ] All existing tests continue to pass

## Technical Details
- `ErrorMessageFormatter` already exists in `recovery/error_messages.py` — extend its coverage
- Wrap `player_action()` return path with try/except → `ErrorMessageFormatter.format()`
- Wrap `start_claudmaster_session()` similarly
- For agent timeouts: catch `AgentTimeoutError` → generate fallback narrative from available agent responses
- For ambiguous input: detect low-confidence intent classification (< 0.3) → ask for clarification in-character
- For empty input: return DM prompt ("The DM looks at you expectantly...")
- Files modified: `tools/action_tools.py`, `tools/session_tools.py`, `recovery/error_messages.py`

## Dependencies
- [ ] #116 — Integration tests reveal which error paths need hardening

## Effort Estimate
- Size: M
- Hours: 4-6
- Parallel: false (modifies `session_tools.py` and `action_tools.py` — shared with #119, #120, #121)

## Definition of Done
- [ ] Code implemented
- [ ] All error paths produce in-character messages
- [ ] Integration tests from #116 validate error handling
- [ ] No raw Python errors in any player-facing response
- [ ] Tests written and passing
