---
name: Tests and validation with real adventure data
status: completed
created: 2026-02-16T00:51:33Z
updated: 2026-02-16T15:30:00Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/130
depends_on: [126, 127, 128, 129]
parallel: false
conflicts_with: []
---

# Task: Tests and validation with real adventure data

## Description

Write comprehensive tests for the entire adventure module integration pipeline. Includes unit tests for each component (models, index, discovery, parser, integration), integration tests for the full flow, and validation against real 5e.tools adventure data (Strixhaven SCC-CK as primary reference).

Create test fixtures by caching sample adventure JSON files so tests can run offline.

## Acceptance Criteria

- [ ] Test fixtures created:
  - `tests/fixtures/adventures/adventures_index_sample.json` — Subset of adventures.json with ~10 representative entries (including Strixhaven, CoS, LMoP)
  - `tests/fixtures/adventures/adventure-scc-ck-sample.json` — Real SCC-CK adventure content (smallest Strixhaven at ~242KB)
  - Fixtures committed to repo for offline CI testing
- [ ] Unit tests for `adventures/models.py`:
  - `AdventureIndexEntry` construction from raw JSON
  - `StorylineGroup` multi-part detection
  - Field validation (missing level, missing storyline, etc.)
- [ ] Unit tests for `adventures/index.py`:
  - Cache hit/miss logic
  - Cache expiration (7-day TTL)
  - Download failure with existing cache → use cache
  - Download failure without cache → error
  - Index parsing from raw JSON
- [ ] Unit tests for `adventures/discovery.py`:
  - Keyword search: exact name match, partial match, storyline match
  - Level range filtering: min only, max only, both, adventures without level data
  - Multi-part grouping: Strixhaven (4 parts), single-adventure storylines
  - Empty query → returns all storyline categories
  - Theme keyword mapping: "vampire" → Ravenloft results
  - Spoiler-free output: verify no chapter content in results
- [ ] Unit tests for `adventures/parser.py`:
  - Section parsing → ModuleElement chapters
  - Nested entries → section hierarchy
  - `insetReadaloud` → read_aloud dict
  - `{@creature Name|Source}` → NPCReference
  - `{@area Name|ID}` → LocationReference
  - Table rendering
  - Unknown entry types → skipped gracefully
  - Markup stripping: zero `{@...}` tags in output
- [ ] Unit tests for campaign integration:
  - Module binding creates correct ModuleBinding
  - Chapter 1 population creates correct entities
  - Spoiler boundary: only Ch.1 NPCs/locations created
  - Graceful degradation without ChromaDB
- [ ] Integration test:
  - Full flow: `discover_adventures("strixhaven")` → select SCC-CK → `load_adventure("SCC-CK", "Test Campaign")` → verify campaign with entities
  - Verify ModuleStructure has chapters, NPCs, locations, read_aloud
  - Verify all text is markup-free
- [ ] All tests pass in CI (no network dependencies — use fixtures)

## Technical Details

### Test file structure
```
tests/
├── fixtures/
│   └── adventures/
│       ├── adventures_index_sample.json
│       └── adventure-scc-ck-sample.json
├── test_adventure_models.py
├── test_adventure_index.py
├── test_adventure_discovery.py
├── test_adventure_parser.py
└── test_adventure_integration.py
```

### Fixture creation approach
1. Download real `adventures.json` and extract ~10 entries (representative mix)
2. Download real `adventure-scc-ck.json` (smallest Strixhaven, ~242KB)
3. Commit both as fixtures — they're small enough and provide realistic test data
4. Tests mock the HTTP client to return fixtures instead of making network calls

### Key test patterns
- Use `pytest` with `tmp_path` for cache directory isolation
- Mock `httpx` responses using fixtures
- Use `monkeypatch` to simulate ChromaDB availability/unavailability
- Parametrize parser tests across different entry types

### Files affected
- NEW: `tests/fixtures/adventures/adventures_index_sample.json`
- NEW: `tests/fixtures/adventures/adventure-scc-ck-sample.json`
- NEW: `tests/test_adventure_models.py`
- NEW: `tests/test_adventure_index.py`
- NEW: `tests/test_adventure_discovery.py`
- NEW: `tests/test_adventure_parser.py`
- NEW: `tests/test_adventure_integration.py`

## Dependencies

- [ ] Task #126 — Adventure data models and index cache
- [ ] Task #127 — Adventure discovery and search
- [ ] Task #128 — Adventure content parser
- [ ] Task #129 — Campaign integration and load_adventure tool

## Effort Estimate

- Size: M
- Hours: 5
- Parallel: false — needs all other tasks completed first (tests validate the whole pipeline)
