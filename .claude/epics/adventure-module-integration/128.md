---
name: Adventure content parser — 5etools entries to ModuleStructure
status: completed
created: 2026-02-16T00:51:33Z
updated: 2026-02-16T15:30:00Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/128
depends_on: [126]
parallel: true
conflicts_with: []
---

# Task: Adventure content parser — 5etools entries to ModuleStructure

## Description

Implement the core parser that downloads individual adventure JSON files from 5e.tools and converts the recursive entry format into dm20-protocol's `ModuleStructure` model. This is the main engineering effort of the epic — the 5etools adventure format uses a rich, recursive entry system with many types (sections, read-aloud text, tables, stat blocks, etc.) that must be mapped to chapters, NPCs, encounters, locations, and read-aloud text.

## Acceptance Criteria

- [ ] `adventures/parser.py` contains `AdventureParser` class that:
  - Downloads `adventure-{id}.json` from 5e.tools mirror on demand
  - Caches downloaded files in `{storage_dir}/adventures/cache/content/`
  - Parses the `data` array of sections into `ModuleStructure`
- [ ] Chapter extraction:
  - Top-level `section` entries → `ModuleElement` with `content_type=CHAPTER`
  - Nested `entries` → child `ModuleElement` with `content_type=SECTION`
  - Hierarchical structure preserved (chapters contain sections contain subsections)
- [ ] NPC extraction:
  - `{@creature Name|Source}` references → `NPCReference` with chapter/location context
  - `statblock` and `statblockInline` entries → `NPCReference`
  - Deduplication: same NPC appearing multiple times → single reference with first occurrence
- [ ] Encounter extraction:
  - Sections with combat-related content → `EncounterReference` with type detection
  - Tables with "encounter" in caption → `EncounterReference`
  - Encounter type inference: combat (has creatures), social (has dialogue/persuasion), exploration (has traps/puzzles)
- [ ] Location extraction:
  - Sections with keyed areas (numbered locations like "1. Cave Mouth") → `LocationReference`
  - `{@area Name|ID}` references → `LocationReference` with parent/sub-location hierarchy
  - Location hierarchy: dungeon > room, town > building, etc.
- [ ] Read-aloud text extraction:
  - `insetReadaloud` entries → stored in `ModuleStructure.read_aloud` dict keyed by section ID
  - All read-aloud text has markup fully stripped
- [ ] Markup stripping:
  - Uses shared `_convert_5etools_markup()` from `fivetools_utils.py`
  - Extends with adventure-specific tags if needed: `{@area}`, `{@adventure}`, `{@book}`
  - Zero `{@...}` tags in any output text
- [ ] Graceful handling:
  - Unknown entry types logged and skipped (not errors)
  - Missing fields handled with sensible defaults
  - Works with all 98 adventures in the 5e.tools index (no crashes on edge cases)

## Technical Details

### 5e.tools entry type mapping

| 5e.tools Type | Action | dm20 Target |
|--------------|--------|-------------|
| `section` (top-level) | Parse as chapter | `ModuleElement(CHAPTER)` |
| `entries` (nested) | Parse as subsection | `ModuleElement(SECTION)` |
| `insetReadaloud` | Extract text | `read_aloud[section_id]` |
| `inset` | Extract as DM note | Append to section content |
| `table` | Render as text | Append to section content |
| `list` | Render as text | Append to section content |
| `statblock` | Extract creature name | `NPCReference` |
| `statblockInline` | Extract creature data | `NPCReference` |
| `image`, `gallery` | Skip | — |
| `flowchart`, `flowBlock` | Skip | — |
| `quote` | Render as text | Append to section content |
| string | Direct text | Append to section content |

### Recursive parsing strategy
```python
def _parse_entry(entry, context: ParserContext) -> None:
    if isinstance(entry, str):
        context.append_text(strip_markup(entry))
    elif isinstance(entry, dict):
        entry_type = entry.get("type", "")
        handler = self._handlers.get(entry_type, self._handle_unknown)
        handler(entry, context)
    # Recurse into entries[], items[], rows[] etc.
```

### ParserContext tracks:
- Current chapter and section hierarchy
- Accumulated NPCs, encounters, locations
- Read-aloud text collection
- Current page number for references

### Cache structure
```
{storage_dir}/adventures/cache/
├── adventures.json          # Index (from Task #126)
├── metadata.json            # Index metadata
└── content/                 # Individual adventure files
    ├── adventure-cos.json
    ├── adventure-scc-ck.json
    └── ...
```

### Files affected
- NEW: `src/dm20_protocol/adventures/parser.py`
- USES: `src/dm20_protocol/rulebooks/sources/fivetools_utils.py` (from Task #126)
- USES: `src/dm20_protocol/claudmaster/models/module.py` (ModuleStructure)

## Dependencies

- [ ] Task #126 — Adventure data models, index cache, and shared markup utilities

## Effort Estimate

- Size: L
- Hours: 10
- Parallel: true — can run in parallel with Task #127 (both depend only on #126)
