---
name: Adventure data models and index cache
status: closed
created: 2026-02-16T00:51:33Z
updated: 2026-02-16T01:13:30Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/126
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Adventure data models and index cache

## Description

Create the foundational data models and index download/cache system for the adventure module integration. This task establishes the `src/dm20_protocol/adventures/` package with Pydantic models for adventure index entries and a cache layer that downloads `adventures.json` from the 5e.tools GitHub mirror.

Also extend `ModuleStructure` with a `read_aloud` field for storing boxed read-aloud text keyed by section ID.

## Acceptance Criteria

- [ ] New package `src/dm20_protocol/adventures/` created with `__init__.py`
- [ ] `adventures/models.py` contains `AdventureIndexEntry`, `StorylineGroup`, and `AdventureSearchResult` Pydantic models
- [ ] `adventures/index.py` contains `AdventureIndex` class that:
  - Downloads `adventures.json` from `https://raw.githubusercontent.com/5etools-mirror-3/5etools-src/main/data/adventures.json`
  - Caches locally in `{storage_dir}/adventures/cache/adventures.json`
  - Validates cache freshness (7-day TTL, configurable)
  - Parses JSON into list of `AdventureIndexEntry`
  - Handles download failures gracefully (use cache if available, error if not)
- [ ] `ModuleStructure` in `claudmaster/models/module.py` extended with `read_aloud: dict[str, list[str]]` field (default empty dict)
- [ ] Retry logic follows existing `FiveToolsSource` patterns (exponential backoff, 3 retries)
- [ ] Extract `_convert_5etools_markup()` and `_render_entries()` from `rulebooks/sources/fivetools.py` into a shared utility at `rulebooks/sources/fivetools_utils.py` so both rulebook and adventure code can import them

## Technical Details

### AdventureIndexEntry model fields (from 5e.tools schema)
- `id: str` — Short identifier (e.g., "CoS", "SCC-CK")
- `name: str` — Full name (e.g., "Curse of Strahd")
- `source: str` — Source identifier
- `storyline: str` — Category/storyline (e.g., "Ravenloft", "Strixhaven")
- `level_start: int | None` — From `level.start`
- `level_end: int | None` — From `level.end`
- `group: str` — Navbar grouping
- `published: str` — ISO date
- `chapter_count: int` — Derived from `len(contents)`
- `contents: list[dict]` — Raw TOC structure (for later use)

### Cache directory structure
```
{storage_dir}/adventures/cache/
├── adventures.json       # Raw index file
└── metadata.json         # Download timestamp, etag
```

### Files affected
- NEW: `src/dm20_protocol/adventures/__init__.py`
- NEW: `src/dm20_protocol/adventures/models.py`
- NEW: `src/dm20_protocol/adventures/index.py`
- NEW: `src/dm20_protocol/rulebooks/sources/fivetools_utils.py`
- MODIFY: `src/dm20_protocol/rulebooks/sources/fivetools.py` (import from utils)
- MODIFY: `src/dm20_protocol/claudmaster/models/module.py` (add read_aloud field)

## Dependencies

- [ ] No task dependencies — this is the foundation task
- [ ] Requires `httpx` (already in project dependencies)

## Effort Estimate

- Size: S
- Hours: 3
- Parallel: true — no dependencies, can start immediately
