---
name: Campaign integration, module binding, and load_adventure MCP tool
status: open
created: 2026-02-16T00:51:33Z
updated: 2026-02-16T00:56:08Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/129
depends_on: [126, 128]
parallel: false
conflicts_with: []
---

# Task: Campaign integration, module binding, and load_adventure MCP tool

## Description

Wire the adventure parser output to campaign creation, module binding, VectorStore RAG indexing, and Chapter 1 entity population. Expose the `load_adventure` MCP tool that orchestrates the full flow: download → parse → create campaign → bind module → index → populate.

This task also integrates with `start_claudmaster_session(module_id=...)` so that the ModuleKeeper agent has access to adventure content during gameplay.

## Acceptance Criteria

- [ ] `adventures/tools.py` (or integrated in `main.py`) contains `load_adventure` MCP tool:
  - Parameters: `adventure_id: str`, `campaign_name: str | None`, `populate_chapter_1: bool = True`
  - Downloads and parses adventure (via `AdventureParser` from Task #128)
  - Creates campaign with adventure name as setting description
  - Binds module to campaign via `CampaignModuleManager.bind_module()`
  - Returns summary of created campaign with entity counts
- [ ] VectorStore indexing (when ChromaDB available):
  - Chunks adventure text by section for RAG
  - Uses existing `ModuleIndexer` or `VectorStoreManager` patterns
  - Metadata per chunk: chapter, section name, content type (narrative, read_aloud, encounter, etc.)
  - Silently skipped if ChromaDB not installed
- [ ] Chapter 1 auto-population (when `populate_chapter_1=True`):
  - Creates starting location from Chapter 1's first location via `create_location()`
  - Creates NPCs from Chapter 1's NPC references via `create_npc()` (only Ch.1 — no spoilers)
  - Creates initial quest from adventure hook via `create_quest()`
  - Sets `game_state.current_location` to starting location
- [ ] Claudmaster session integration:
  - When `start_claudmaster_session(module_id="SCC-CK")` is called, the module is available
  - ModuleKeeper agent can query adventure content via VectorStore
  - Session state includes `module_info` with adventure name and loaded status
- [ ] Graceful degradation:
  - Without ChromaDB: campaign + binding + population works, no RAG
  - Without internet: uses cached adventure JSON if available, clear error if not
  - If campaign already exists: warn and offer to bind module to existing campaign

## Technical Details

### Full orchestration flow
```python
async def load_adventure(adventure_id, campaign_name=None, populate_chapter_1=True):
    # 1. Parse adventure
    parser = AdventureParser(storage_dir)
    module = await parser.parse(adventure_id)

    # 2. Create or load campaign
    if campaign_name:
        campaign = create_campaign(name=campaign_name, setting=module.metadata.get("intro"))
    else:
        campaign = get_current_campaign()

    # 3. Bind module
    manager = CampaignModuleManager(campaign_path)
    manager.bind_module(module_id=adventure_id, source_id="5etools", set_active=True)

    # 4. VectorStore indexing (optional)
    if HAS_CHROMADB:
        indexer = ModuleIndexer(campaign_path)
        await indexer.index_module(module)

    # 5. Populate Chapter 1 entities
    if populate_chapter_1 and module.chapters:
        ch1 = module.chapters[0]
        for loc in [l for l in module.locations if l.chapter == ch1.name][:3]:
            create_location(name=loc.name, ...)
        for npc in [n for n in module.npcs if n.chapter == ch1.name][:5]:
            create_npc(name=npc.name, ...)
        create_quest(title=f"{module.title} - Chapter 1", ...)
        update_game_state(current_location=first_location)
```

### Spoiler boundary enforcement
- Only Chapter 1 NPCs/locations/quests are created as campaign entities
- Full adventure is indexed in VectorStore (ModuleKeeper controls revelation)
- `ModuleProgress` tracking starts at Chapter 1

### Files affected
- NEW: `src/dm20_protocol/adventures/tools.py` (or additions to `main.py`)
- MODIFY: `src/dm20_protocol/main.py` (register `load_adventure` tool)
- USES: `src/dm20_protocol/claudmaster/module_binding.py` (CampaignModuleManager)
- USES: `src/dm20_protocol/claudmaster/module_indexer.py` (VectorStore indexing)
- USES: `src/dm20_protocol/claudmaster/tools/session_tools.py` (Claudmaster integration)

## Dependencies

- [ ] Task #126 — Adventure data models and index cache
- [ ] Task #128 — Adventure content parser

## Effort Estimate

- Size: M
- Hours: 6
- Parallel: false — depends on parser output from #128
