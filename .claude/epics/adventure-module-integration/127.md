---
name: Adventure discovery, search, and MCP tool
status: completed
created: 2026-02-16T00:51:33Z
updated: 2026-02-16T15:30:00Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/127
depends_on: [126]
parallel: true
conflicts_with: []
---

# Task: Adventure discovery, search, and MCP tool

## Description

Implement the adventure discovery system that lets users search and browse available D&D adventures by theme, keyword, level range, or storyline. Expose it as the `discover_adventures` MCP tool. This task builds on the index cache from Task #126 and adds the search/filter/presentation layer.

Key capability: users who don't know what adventures exist can ask open-ended questions like "something with vampires" or "a magic school adventure" and get relevant, spoiler-free results.

## Acceptance Criteria

- [ ] `adventures/discovery.py` implements search logic:
  - Keyword search on `name` and `storyline` fields (case-insensitive, partial match)
  - Level range filtering (`level_min`, `level_max`)
  - Storyline filter (exact or partial match)
  - Multi-part adventure detection: group adventures sharing the same `storyline`
  - Results sorted by relevance (exact name match > storyline match > partial match)
- [ ] Spoiler-free presentation format:
  - Shows: adventure name, storyline, level range, chapter count
  - Does NOT show: plot details, NPC names, chapter content, twists
  - Multi-part adventures grouped with sequential numbering and "Recommended: Start with #1" note
- [ ] `discover_adventures` MCP tool registered in `main.py` with parameters:
  - `query: str = ""` — Keyword search (theme, name, etc.)
  - `level_min: int | None = None` — Minimum level filter
  - `level_max: int | None = None` — Maximum level filter
  - `storyline: str | None = None` — Filter by storyline
  - `limit: int = 10` — Maximum results
- [ ] Tool returns formatted markdown text with adventure listings
- [ ] Empty query with no filters returns a summary of all storyline categories
- [ ] Works fully offline once index is cached

## Technical Details

### Search algorithm
1. Load index from cache (or download if not cached)
2. Apply filters: level range, storyline
3. Apply keyword search on remaining entries
4. Group by storyline → `StorylineGroup` objects
5. Sort groups by match relevance
6. Format as spoiler-free markdown

### Multi-part detection
Adventures with the same `storyline` AND different `id` values form a group. Sort by `level_start` for chronological order. Known multi-part storylines:
- Strixhaven (4), Tales from the Yawning Portal (7), Keys from the Golden Vault (13), Ghosts of Saltmarsh (7), Tyranny of Dragons (2)

### Keyword-to-storyline mapping (enhance discoverability)
Build a small static dictionary mapping common themes to storylines:
- "vampire", "gothic", "horror" → "Ravenloft"
- "school", "magic school", "university" → "Strixhaven"
- "dragon", "cult" → "Tyranny of Dragons"
- "heist", "theft" → "Keys from the Golden Vault"
- "space", "spelljammer" → "Spelljammer"
- "undead", "death" → "Ravenloft", "Vecna"
- etc.

### Files affected
- NEW: `src/dm20_protocol/adventures/discovery.py`
- MODIFY: `src/dm20_protocol/main.py` (register `discover_adventures` tool)

## Dependencies

- [ ] Task #126 — Adventure data models and index cache

## Effort Estimate

- Size: M
- Hours: 5
- Parallel: true — can run in parallel with Task #128 (both depend only on #126)
