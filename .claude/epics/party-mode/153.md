---
name: Host Slash Commands
status: closed
created: 2026-02-17T16:54:33Z
updated: 2026-02-17T19:05:23Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/155
depends_on: [149, 150]
parallel: true
conflicts_with: []
---

# Task: Host Slash Commands

## Description

Create the Claude Code slash commands that the host uses to manage Party Mode. These commands are the host's interface to start/stop the web server, process player actions, and monitor the session.

The most critical command is `/dm:party-next` which reads the next action from the queue, presents it to Claude for processing through the normal game loop, and writes the response back to the response queue.

## Acceptance Criteria

- [ ] `/dm:party-mode` — starts web server, generates tokens + QR codes, displays connection info (IP, port, player list)
- [ ] `/dm:party-stop` — sends disconnect to all WebSocket clients, stops server, displays summary
- [ ] `/dm:party-next` — reads next pending action, formats it for Claude to process, writes response to queue
- [ ] `/dm:party-auto` — enters a loop: polls queue, auto-processes actions, stops on user interrupt
- [ ] `/dm:party-status` — displays: connected players, pending actions count, queue stats, server uptime
- [ ] `/dm:party-kick <player>` — disconnects player, invalidates token, removes from connection manager
- [ ] `/dm:party-token <player>` — generates new token + QR for specified player, invalidates old one
- [ ] All commands provide clear terminal output with formatting (not raw JSON)
- [ ] `/dm:party-mode` shows QR codes in terminal (as file paths to generated PNGs)
- [ ] `/dm:party-next` presents the action in a way that Claude naturally processes it through the game loop
- [ ] Error handling: graceful messages when server not running, no pending actions, player not found, etc.

## Technical Details

### New Files

```
.claude/commands/dm/
├── party-mode.md       # Start Party Mode
├── party-stop.md       # Stop Party Mode
├── party-next.md       # Process next action
├── party-auto.md       # Auto-process loop
├── party-status.md     # Show status
├── party-kick.md       # Kick player
└── party-token.md      # Refresh token
```

### `/dm:party-mode` Flow

```
1. Check: is a campaign loaded? If not → error
2. Check: is Party Mode already running? If yes → show status
3. Read PCRegistry.get_all_active() → list of PCs
4. Call auth.generate_tokens(pc_list) → {player_id: token}
5. Call auth.generate_qr(host_ip, port, token) for each player → QR PNGs
6. Call server.start_party_server(port=8080) → background thread
7. Display:
   Party Mode active on http://{ip}:{port}
   Players:
     Thorin  → QR: {path}/qr-thorin.png
     Elara   → QR: {path}/qr-elara.png
   Observer → http://{ip}:{port}/play?token={obs_token}
```

### `/dm:party-next` Flow

This is the critical bridge command. It must present the player's action in a way that Claude's DM game loop processes it naturally:

```
1. Call action_queue.pop() → {player_id, text, action_id}
2. If no pending actions → "No pending actions. Use /dm:party-status to check."
3. Format output:

   --- Party Mode: Player Action ---
   Player: Thorin (player_id: thorin)
   Action: "I approach the table with my hand on my axe"
   ---
   Process this action through the game loop. When done, the response will be
   sent to all connected players via the Party Mode web server.

4. Claude processes the action using /dm:action flow
5. The response is captured and written to ResponseQueue
6. Action marked as resolved
```

### `/dm:party-auto` Flow

```
1. Enter loop:
   a. Check action_queue for pending actions
   b. If found → process like /dm:party-next
   c. If empty → wait 2 seconds, check again
   d. After processing → check for more
2. Display: "Auto-processing active. Press Ctrl+C or type /dm:party-stop to end."
3. On each action: display brief summary of who did what
```

### `/dm:party-status` Output

```
Party Mode Status
═══════════════════════
Server: http://192.168.1.42:8080 (running for 1h 23m)

Connected Players (3/4):
  ● Thorin  — connected (phone, last active 2m ago)
  ● Elara   — connected (desktop, last active 30s ago)
  ○ Vex     — disconnected (last seen 15m ago)
  ● Observer — connected (1 viewer)

Action Queue:
  Pending: 2 actions
  Processing: 0
  Resolved: 47 (this session)

Next pending: Elara — "I cast Detect Magic on the door" (queued 30s ago)
```

## Dependencies

- [ ] Task #149 (Web Server Core) — server start/stop, auth token management
- [ ] Task #150 (Action Queue) — queue.pop(), queue.get_pending_count(), response writing

## Effort Estimate

- Size: M
- Hours: 6-8h
- Parallel: true (can run in parallel with Task #154 Combat Turn Coordination, after deps met)

## Definition of Done

- [ ] All 7 slash commands work correctly
- [ ] `/dm:party-mode` starts server and shows QR paths
- [ ] `/dm:party-next` presents action to Claude and captures response
- [ ] `/dm:party-auto` processes multiple actions in sequence
- [ ] Error handling covers all edge cases (no campaign, server not running, empty queue, etc.)
- [ ] Commands display clean, formatted output
