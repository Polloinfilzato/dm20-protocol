---
name: Action Queue and Response Pipeline
status: open
created: 2026-02-17T16:54:33Z
updated: 2026-02-17T17:07:59Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/152
depends_on: [149]
parallel: true
conflicts_with: []
---

# Task: Action Queue and Response Pipeline

## Description

Build the data flow pipeline that bridges player browsers to the host's Claude Code session. Player actions are queued via the web server; the host processes them via `/dm:party-next`; responses are written back and filtered per player role before delivery.

The queue system uses in-memory deques for fast access with JSONL file persistence for crash recovery and debugging.

## Acceptance Criteria

- [ ] `ActionQueue` class: thread-safe, in-memory deque + JSONL persistence
- [ ] `ActionQueue.push(player_id, text)` → creates action with unique ID, status `pending`, timestamp
- [ ] `ActionQueue.pop()` → returns next `pending` action, sets status to `processing`
- [ ] `ActionQueue.resolve(action_id, response)` → marks action `resolved`, writes to response queue
- [ ] `ActionQueue.get_status(action_id)` → returns current status
- [ ] `ActionQueue.get_pending_count()` → returns number of pending actions
- [ ] `ResponseQueue` class: append-only with per-player filtering
- [ ] `ResponseQueue.push(response)` → stores response with visibility tags (public, private per player, dm_only)
- [ ] `ResponseQueue.get_for_player(player_id, since_timestamp)` → returns filtered responses
- [ ] Response filtering uses `PermissionResolver` + `OutputFilter` to strip DM-only and other-player-private content
- [ ] `POST /action` endpoint wired to `ActionQueue.push()`
- [ ] Action status endpoint: `GET /action/{action_id}/status` returns current status
- [ ] JSONL files created in `{campaign_dir}/party/` directory
- [ ] Queue survives web server restart (reads existing JSONL on startup)
- [ ] Thread-safe: concurrent pushes from multiple WebSocket handlers don't corrupt data
- [ ] Unit tests for queue operations, thread safety, JSONL persistence, and response filtering
- [ ] `bridge.py` module with `format_response()` that applies OutputFilter to create per-player views

## Technical Details

### New Files

```
src/dm20_protocol/party/
├── queue.py             # ActionQueue, ResponseQueue classes
└── bridge.py            # format_response(), get_character_view(), get_combat_state()
```

### Action Queue Schema

```json
{
  "id": "act_001",
  "player_id": "thorin",
  "text": "I approach the table with my hand on my axe",
  "timestamp": "2026-02-17T20:15:00Z",
  "status": "pending"
}
```

Status transitions: `pending` → `processing` → `resolved`

### Response Queue Schema

```json
{
  "id": "res_001",
  "action_id": "act_001",
  "narrative": "Thorin approaches the hooded figure...",
  "private": {
    "thorin": "You notice a dagger under his cloak"
  },
  "dm_only": "The figure is actually the BBEG in disguise",
  "timestamp": "2026-02-17T20:15:30Z"
}
```

### Key Implementation Notes

- **Thread safety**: Use `threading.Lock` around deque operations and file writes
- **JSONL persistence**: Append-only writes. On startup, read existing file and rebuild in-memory state (skip `resolved` actions older than current session)
- **Response filtering**: `bridge.format_response(raw_response, player_id)` calls `OutputFilter` to produce a player-specific view. DM_ONLY fields are stripped for all non-DM players. Private fields are included only for the matching player.
- **Bridge module**: Thin adapter between queue data and existing dm20 systems. No business logic — delegates to `PermissionResolver`, `OutputFilter`, `PrivateInfoManager`.

### Integration Points

- `PermissionResolver.check_permission()` → validates player can submit actions
- `OutputFilter` → filters response content by role
- `PrivateInfoManager.get_pending_messages()` → includes pending DM whispers in response
- `server.py` routes → `POST /action` calls `queue.push()`

## Dependencies

- [ ] Task #149 (Web Server Core) — needs routes and server infrastructure
- [ ] No external dependencies

## Effort Estimate

- Size: M
- Hours: 6-8h
- Parallel: true (can run in parallel with Task #151 Player Web UI)

## Definition of Done

- [ ] Actions flow: browser POST → queue → pending status → pop → processing → resolve → response queue
- [ ] Response filtering correctly strips private/dm_only content per player
- [ ] JSONL files persist and are readable after restart
- [ ] Thread safety verified under concurrent access
- [ ] All tests pass
