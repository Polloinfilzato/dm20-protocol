---
name: Combat Turn Coordination
status: open
created: 2026-02-17T16:54:33Z
updated: 2026-02-17T17:07:59Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/156
depends_on: [151, 152]
parallel: true
conflicts_with: []
---

# Task: Combat Turn Coordination

## Description

Add combat-specific UI and coordination logic so that when combat is active, each player's browser shows the initiative order, knows whose turn it is, and gates action input accordingly. Supports two modes: turn-based (default) where only the active player can submit actions, and simultaneous (optional) where all players submit at once for group checks or surprise rounds.

## Acceptance Criteria

- [ ] When combat starts, all browsers receive `combat_state` event with initiative order
- [ ] Active player's browser shows "YOUR TURN" banner and enables action input
- [ ] Non-active players see "Waiting for {player}..." and have action input disabled
- [ ] Initiative order displayed as a sidebar/overlay showing all combatants with HP and AC
- [ ] Current turn highlighted in initiative order
- [ ] When turn advances (via `/dm:party-next` processing), all browsers update
- [ ] When combat ends, all browsers return to normal exploration mode
- [ ] **Simultaneous mode**: DM can trigger a simultaneous round where all players submit actions
- [ ] Simultaneous mode shows a countdown timer (configurable, default 5 min)
- [ ] Simultaneous mode collects all actions, then DM resolves in initiative order
- [ ] Simultaneous mode: "Waiting for: Thorin, Vex" updates as players submit
- [ ] Combat state reads from existing `TurnManager` — no duplication of turn logic
- [ ] `bridge.get_combat_state(player_id)` returns current combat state filtered for the player
- [ ] Tests: combat start → turn gating → turn advance → combat end cycle

## Technical Details

### Modified Files

```
src/dm20_protocol/party/
├── bridge.py            # Add get_combat_state(), is_players_turn()
├── server.py            # Add combat event broadcasting
└── static/
    ├── app.js           # Add combat UI logic, turn gating
    └── style.css        # Add combat overlay styles
```

### Combat State WebSocket Message

```json
{
  "type": "combat_state",
  "data": {
    "active": true,
    "mode": "turn_based",
    "current_turn": "thorin",
    "round": 3,
    "initiative": [
      {"id": "thorin", "name": "Thorin", "initiative": 18, "hp": 45, "max_hp": 52, "ac": 18, "conditions": []},
      {"id": "goblin_1", "name": "Goblin Archer", "initiative": 15, "hp": 7, "max_hp": 7, "ac": 13, "conditions": []},
      {"id": "elara", "name": "Elara", "initiative": 12, "hp": 32, "max_hp": 32, "ac": 15, "conditions": ["concentrating"]}
    ],
    "your_turn": true
  }
}
```

The `your_turn` field is set per-player by `bridge.get_combat_state(player_id)`.

### Turn Gating (app.js)

```javascript
function handleCombatState(data) {
  if (data.active) {
    showInitiativeOrder(data.initiative);
    if (data.your_turn) {
      showYourTurnBanner();
      enableActionInput();
    } else {
      showWaitingBanner(data.current_turn);
      disableActionInput();
    }
  } else {
    hideInitiativeOrder();
    hideCombatBanners();
    enableActionInput(); // back to exploration mode
  }
}
```

### Simultaneous Mode

Triggered by a special response from the DM (e.g., "Everyone roll for initiative" or group check). The server sends:

```json
{
  "type": "combat_state",
  "data": {
    "active": true,
    "mode": "simultaneous",
    "prompt": "The floor collapses! Everyone make a DEX save!",
    "timeout_seconds": 300,
    "submitted": ["elara"],
    "waiting_for": ["thorin", "vex"]
  }
}
```

All players can submit. As each submits, the `waiting_for` list updates for everyone. When all submit or timeout expires, DM resolves.

### Integration with TurnManager

`bridge.get_combat_state()` reads from the existing `TurnManager`:
- `turn_manager.get_current_turn()` → active combatant
- `turn_manager.get_initiative_order()` → full list
- `turn_manager.is_combat_active()` → bool

No combat logic is duplicated — the web layer is purely presentational.

## Dependencies

- [ ] Task #151 (Player Web UI) — needs the frontend infrastructure for combat overlay
- [ ] Task #152 (WebSocket Real-Time Push) — needs broadcast mechanism for combat events
- [ ] Existing `TurnManager` in `src/dm20_protocol/claudmaster/turn_manager.py`

## Effort Estimate

- Size: M
- Hours: 6-8h
- Parallel: true (can run in parallel with Task #153 Host Slash Commands)

## Definition of Done

- [ ] Initiative order displays correctly during combat
- [ ] Turn gating works: only active player can submit
- [ ] Simultaneous mode collects actions from all players
- [ ] Combat start/end transitions smoothly
- [ ] No combat logic duplicated — reads from existing TurnManager
- [ ] Tests cover full combat lifecycle
