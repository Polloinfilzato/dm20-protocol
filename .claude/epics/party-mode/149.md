---
name: Web Server Core + Authentication
status: open
created: 2026-02-17T16:54:33Z
updated: 2026-02-17T17:07:59Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/151
depends_on: []
parallel: false
conflicts_with: []
---

# Task: Web Server Core + Authentication

## Description

Build the foundational web server and authentication system for Party Mode. This is the base layer that all other tasks depend on.

The Starlette web server runs inside the same Python process as the MCP server, in a dedicated background thread with its own asyncio event loop. It serves the player UI, handles WebSocket connections, and authenticates players via session tokens encoded in QR codes.

## Acceptance Criteria

- [ ] Starlette app with routes: `GET /play`, `POST /action`, `GET /character/{player_id}`, `GET /status`, `WS /ws`
- [ ] Background thread lifecycle: `start_party_server(port, host)` / `stop_party_server()` functions
- [ ] Server starts without blocking or interfering with MCP stdio transport
- [ ] Per-player session token generation from `PCRegistry.get_all_active()`
- [ ] Token validation middleware rejects invalid/expired tokens on all endpoints
- [ ] QR code PNG generation via `qrcode` package (one QR per player + one OBSERVER QR)
- [ ] `refresh_token(player_id)` invalidates old token and generates new one
- [ ] WebSocket connection manager tracks connected clients per `player_id`
- [ ] `GET /status` returns server health, connected players, uptime
- [ ] `GET /play?token=xxx` serves static `index.html` (placeholder for Task 3)
- [ ] `GET /character/{player_id}` returns character JSON with permission check via `PermissionResolver`
- [ ] Server gracefully shuts down (closes all WebSocket connections, releases port)
- [ ] `qrcode` added to `pyproject.toml` dependencies
- [ ] Unit tests for token generation, validation, refresh, and QR generation
- [ ] Integration test: start server → connect WebSocket → validate token → disconnect → stop server

## Technical Details

### New Files

```
src/dm20_protocol/party/
├── __init__.py          # Package init, exports start/stop functions
├── server.py            # Starlette app, routes, WebSocket handler, background thread
├── auth.py              # Token generation, validation, QR code creation
└── static/
    └── index.html       # Placeholder page (replaced by Task 3)
```

### Key Implementation Notes

- **Background thread**: Use `threading.Thread(daemon=True)` running `uvicorn.Server` with a new `asyncio` event loop. The thread must not touch the main thread's event loop.
- **Token format**: `secrets.token_urlsafe(6)` → 8-char alphanumeric string. Stored in a dict: `{token: player_id}`.
- **QR code**: `qrcode.make(f"http://{host_ip}:{port}/play?token={token}")` → PNG bytes. Save to `{campaign_dir}/party/qr-{player_id}.png`.
- **Host IP detection**: Use `socket.gethostbyname(socket.gethostname())` for LAN IP, fallback to `127.0.0.1`.
- **Connection manager**: Dict of `{player_id: set[WebSocket]}` — a player may have multiple tabs open.
- **Permission check on /character**: Call `PermissionResolver.check_permission(player_id, "get_character", character_id)` before returning data.

### Integration Points

- `PCRegistry.get_all_active()` → list of PCs to generate tokens for
- `PermissionResolver` → validate token's player_id has access to requested resources
- `StorageManager.get_character()` → character data for `/character` endpoint

## Dependencies

- [ ] No task dependencies (foundational)
- [ ] `qrcode[pil]>=7.0` Python package (new dependency)
- [ ] `starlette` and `uvicorn` (already bundled with `fastmcp>=2.9.0`)

## Effort Estimate

- Size: L
- Hours: 10-12h
- Parallel: false (all other tasks depend on this)

## Definition of Done

- [ ] Web server starts and stops cleanly in background thread
- [ ] MCP stdio transport works normally while web server is running
- [ ] Token auth works end-to-end (generate → QR → validate → reject invalid)
- [ ] WebSocket connects and stays alive
- [ ] All unit and integration tests pass
- [ ] No new dependencies beyond `qrcode[pil]`
