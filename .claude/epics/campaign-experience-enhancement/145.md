---
name: Party Knowledge System and MCP Tool
status: open
created: 2026-02-16T23:42:01Z
updated: 2026-02-16T23:45:39Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/145
depends_on: [143]
parallel: true
conflicts_with: []
---

# Task: Party Knowledge System and MCP Tool

## Description
Build the PartyKnowledge system as a filtered view over the existing FactDatabase and NPC Knowledge Tracker. Tracks what the party knows about the world (facts, NPCs, locations, quest details) and exposes it via a `party_knowledge` MCP tool. Integrates bidirectionally with NPC knowledge — NPCs can tell the party things, and the party can share info with NPCs.

## Acceptance Criteria
- [ ] `PartyKnowledge` class that provides a filtered view over FactDatabase facts tagged as party-known
- [ ] Method to mark a fact as known by the party: `learn_fact(fact_id, source, method)` where method is "told_by_npc", "observed", "investigated", "read", etc.
- [ ] Method to query party knowledge: `knows_about(topic)` returns relevant known facts
- [ ] Method to check if party knows a specific fact: `party_knows(fact_id)` → bool
- [ ] Bidirectional NPC integration: when NPC shares info, `learn_fact()` is called; party can share facts with NPCs via `share_with_npc(npc_id, fact_id)`
- [ ] `party_knowledge` MCP tool: query what the party knows about a topic (NPC, location, quest, general lore)
- [ ] Knowledge sources tracked: who told them, when, where (leveraging existing Fact.source field)
- [ ] Unit tests for knowledge acquisition, querying, and NPC bidirectional flow

## Technical Details
- **New file**: `dm20_protocol/consistency/party_knowledge.py` — PartyKnowledge class
- **Modified file**: `dm20_protocol/main.py` — Register `party_knowledge` MCP tool
- **Modified file**: `dm20_protocol/consistency/fact_database.py` — Add `party_known` tag support to Fact model (or use existing tags field)
- **Modified file**: `dm20_protocol/consistency/npc_knowledge.py` — Add `share_with_party()` method that calls PartyKnowledge.learn_fact()
- **Pattern**: PartyKnowledge wraps FactDatabase rather than duplicating data. A fact becomes "party-known" by adding a "party_known" tag.
- **Query**: `knows_about(topic)` does tag + content search across party-known facts

## Dependencies
- [ ] #143 — Discovery models needed for knowledge-discovery integration points

## Effort Estimate
- Size: M
- Hours: 8-10
- Parallel: true (different files from #144, can run in parallel with it)

## Definition of Done
- [ ] Party can learn facts from NPC interactions and direct observation
- [ ] party_knowledge MCP tool returns relevant facts with source attribution
- [ ] NPC bidirectional flow works: NPC tells party → party knows; party tells NPC → NPC knows
- [ ] No duplicate data: PartyKnowledge is a view over FactDatabase, not a copy
- [ ] Unit tests passing with > 90% coverage
