---
name: Role System and PermissionResolver
status: open
created: 2026-02-16T23:42:01Z
updated: 2026-02-16T23:45:39Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/146
depends_on: [143]
parallel: true
conflicts_with: []
---

# Task: Role System and PermissionResolver

## Description
Implement the PlayerRole enum (DM, PLAYER, OBSERVER), permission matrix, and PermissionResolver that validates MCP tool calls against the caller's role and entity ownership. Add `player_id` optional parameter to sensitive MCP tools. The system is entirely opt-in — when no player_id is provided, all calls are treated as single-player DM mode with full access.

## Acceptance Criteria
- [ ] `PlayerRole` enum: DM (full access), PLAYER (own character + shared state), OBSERVER (read-only)
- [ ] Permission matrix: maps (role, tool_name) → allowed/denied/conditional (conditional = ownership check)
- [ ] `PermissionResolver` class with `check_permission(player_id, tool_name, target_entity_id)` → bool
- [ ] Character ownership enforcement: PLAYER role can only modify characters where `player_name` matches
- [ ] `player_id` optional parameter added to sensitive MCP tools (update_character, add_item, use_spell_slot, etc.)
- [ ] Single-player bypass: when `player_id` is None, permission check is skipped entirely (zero overhead)
- [ ] DM can grant/revoke temporary permissions via `grant_permission(player_id, permission, duration)`
- [ ] Role assignment: `set_player_role(player_id, role)` stored in campaign game state
- [ ] PCState model extended with `role: PlayerRole` field (default: PLAYER)
- [ ] Unit tests for every (role, tool) combination in the permission matrix

## Technical Details
- **New file**: `dm20_protocol/permissions.py` — PlayerRole, PermissionMatrix, PermissionResolver
- **Modified file**: `dm20_protocol/main.py` — Add `player_id` optional param to ~15 sensitive tools, call PermissionResolver before execution
- **Modified file**: `claudmaster/pc_tracking.py` — Add `role` field to PCState model
- **Permission matrix**: Defined as a dict `{tool_name: {role: "allow"|"deny"|"own"}}` where "own" means ownership check
- **Middleware approach**: A helper function `check_and_execute(player_id, tool_name, target, action_fn)` wraps tool logic
- **Zero overhead**: `if player_id is None: return action_fn()` — no dict lookups in single-player mode

## Dependencies
- [ ] #143 — Discovery concepts needed for permission scope (what can players see based on discovery)

## Effort Estimate
- Size: L
- Hours: 10-12
- Parallel: true (different files from #144/#145)

## Definition of Done
- [ ] All role/tool combinations tested and documented
- [ ] Single-player mode has zero overhead (benchmarked < 1ms)
- [ ] Character ownership correctly enforced for PLAYER role
- [ ] DM temporary grants work with expiration
- [ ] No regressions in existing single-player tests
- [ ] Unit tests passing with > 95% coverage (security-critical)
