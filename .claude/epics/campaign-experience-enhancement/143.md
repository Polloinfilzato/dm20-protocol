---
name: Discovery Models and DiscoveryTracker
status: completed
created: 2026-02-16T23:42:01Z
updated: 2026-02-16T23:45:39Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/143
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Discovery Models and DiscoveryTracker

## Description
Create the DiscoveryLevel enum, DiscoveryState model, and DiscoveryTracker manager for tracking what the party has discovered about locations and their features. Follows the same persistence pattern as LocationStateManager (JSON file in campaign directory). Includes feature-level granularity where each location's notable_features can have individual discovery levels.

## Acceptance Criteria
- [ ] `DiscoveryLevel` enum: UNDISCOVERED, GLIMPSED, EXPLORED, FULLY_MAPPED
- [ ] `FeatureDiscovery` model: feature_name, discovery_level, discovered_by (character), discovered_session, discovery_method (e.g., "perception check", "investigation", "told by NPC")
- [ ] `LocationDiscovery` model: location_id, overall_level, feature_discoveries (list of FeatureDiscovery), first_visited, last_visited
- [ ] `DiscoveryTracker` manager class with methods:
  - `discover_location(location_id, level)` — Set/upgrade location discovery
  - `discover_feature(location_id, feature_name, level, method)` — Reveal a specific feature
  - `get_discovery_state(location_id)` — Get current discovery for a location
  - `get_visible_features(location_id)` — Return only features at GLIMPSED or above
  - `is_fully_explored(location_id)` — Check if all features are FULLY_MAPPED
- [ ] Persistence to `discovery_state.json` in campaign's split-storage directory
- [ ] Graceful defaults: locations without discovery data treated as EXPLORED (backward compatibility)
- [ ] Integration point: `get_location` MCP tool can optionally filter by discovery state
- [ ] Unit tests for all DiscoveryTracker methods, persistence round-trip, backward compatibility

## Technical Details
- **New file**: `dm20_protocol/consistency/discovery.py` — All discovery models and tracker
- **Modified file**: `dm20_protocol/storage.py` — Load/save discovery_state.json, initialize DiscoveryTracker on campaign load
- **Pattern**: Follow `LocationStateManager` pattern in `consistency/location_state.py` for persistence and API style
- **Backward compatibility**: `get_discovery_state()` returns EXPLORED for locations not in the tracker (existing campaigns work unchanged)
- **Feature mapping**: Each Location's `notable_features` list items map to FeatureDiscovery entries

## Dependencies
- [ ] None — standalone task (parallel with Phase 1)

## Effort Estimate
- Size: M
- Hours: 8-10
- Parallel: true (no shared files with #141/#142)

## Definition of Done
- [ ] All models validate correctly with Pydantic
- [ ] DiscoveryTracker persists and loads discovery_state.json
- [ ] Backward compatibility: old campaigns without discovery data work seamlessly
- [ ] Discovery levels can only upgrade (UNDISCOVERED → GLIMPSED → EXPLORED → FULLY_MAPPED), never downgrade
- [ ] Unit tests passing with > 90% coverage
- [ ] Integration with storage.py for automatic load/save on campaign operations
