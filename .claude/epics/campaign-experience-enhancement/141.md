---
name: CompendiumPack Model and Export
status: completed
created: 2026-02-16T23:42:01Z
updated: 2026-02-16T23:45:39Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/141
depends_on: []
parallel: true
conflicts_with: []
---

# Task: CompendiumPack Model and Export

## Description
Create the CompendiumPack Pydantic model with metadata and entity collections, plus the PackSerializer that extracts entities from a Campaign and produces a portable JSON pack file. Includes selective export by entity type, location filter, or tag, and full campaign backup.

## Acceptance Criteria
- [ ] `CompendiumPack` Pydantic model with metadata (name, version, author, description, tags, system_version, schema_version) and entity collections (npcs, locations, quests, items, encounters)
- [ ] `PackMetadata` model with creation timestamp, entity counts, source campaign name
- [ ] `PackSerializer` class that extracts entities from a Campaign object using `model_dump(mode='json')`
- [ ] Selective export: by entity type (e.g., only NPCs), by location filter (e.g., NPCs in "Waterdeep"), by tags
- [ ] Full campaign backup: export all entities + game state + sessions as a single pack
- [ ] Inter-entity relationships preserved (NPC→Location references kept intact)
- [ ] `export_pack` MCP tool registered via `@mcp.tool` decorator
- [ ] Pack saved as single `.json` file to `{storage_dir}/packs/` directory
- [ ] Unit tests for model validation, serialization round-trip, selective filtering

## Technical Details
- **New file**: `dm20_protocol/compendium.py` — CompendiumPack, PackMetadata, PackSerializer classes
- **Modified file**: `dm20_protocol/main.py` — Register `export_pack` MCP tool
- **Modified file**: `dm20_protocol/storage.py` — Add `get_packs_dir()` method for pack storage path
- **Pattern**: Follow existing `model_dump(mode='json')` pattern used throughout models.py
- **Selective export**: Use filter functions that take Campaign + criteria → filtered entity lists
- **Full backup**: Special mode that includes game_state, sessions, world_notes alongside entities

## Dependencies
- [ ] None — standalone task

## Effort Estimate
- Size: M
- Hours: 8-10
- Parallel: true (no shared files with Phase 2/3 tasks)

## Definition of Done
- [ ] CompendiumPack and PackMetadata models validate correctly
- [ ] PackSerializer produces valid JSON packs from test campaigns
- [ ] Selective export filters work for type, location, and tag criteria
- [ ] Full campaign backup includes all data
- [ ] export_pack MCP tool accessible and functional
- [ ] Unit tests passing with > 90% coverage on compendium.py
- [ ] Entity relationships preserved in exported packs
