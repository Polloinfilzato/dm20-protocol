---
name: Output Filtering and Multi-User Session Coordination
status: completed
created: 2026-02-16T23:42:01Z
updated: 2026-02-16T23:45:39Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/147
depends_on: [144, 146]
parallel: false
conflicts_with: []
---

# Task: Output Filtering and Multi-User Session Coordination

## Description
Wire the existing PrivateInfo system into MCP tool output to strip DM-only content from player-visible responses. Implement session participant tracking, turn-based notifications, and DM private messages. This is the capstone task that ties permissions, discovery, and private info together into a coherent multi-user experience.

## Acceptance Criteria
- [ ] MCP tool responses filtered by caller's role: PLAYER sees only PUBLIC + PARTY info, DM sees everything
- [ ] `get_npc` strips bio/secret fields for PLAYER callers (only shows public description)
- [ ] `get_location` combines discovery filter + permission filter (players see only discovered + public info)
- [ ] PrivateInfo system's `InfoVisibility` levels enforced in tool output (PUBLIC, PARTY, PRIVATE, DM_ONLY, SUBSET)
- [ ] Session participant tracking: who's connected, who's active, last action time
- [ ] Turn-based notification: when combat or structured play is active, "It's [player]'s turn" context
- [ ] DM can send private messages to individual players via `send_private_message(player_id, content)` MCP tool
- [ ] Shared narrative visible to all; private info visible only to relevant player via response tagging
- [ ] Integration with existing `PrivateInfoManager.get_visible_info(pc_id)` for per-player filtering
- [ ] Integration tests: same tool call returns different content for DM vs PLAYER vs OBSERVER

## Technical Details
- **New file**: `dm20_protocol/output_filter.py` — OutputFilter class that wraps tool responses
- **Modified file**: `dm20_protocol/main.py` — Apply OutputFilter to tool responses when player_id is present
- **Modified file**: `claudmaster/private_info.py` — Wire `get_visible_info()` into output pipeline
- **Modified file**: `claudmaster/pc_tracking.py` — Add participant tracking methods (join_session, leave_session, heartbeat)
- **Output filter pattern**: `filter_response(raw_response, player_id, role)` → filtered string/dict
- **NPC filtering**: For PLAYER role, `get_npc` returns only: name, description, race, occupation, attitude, location (strips: bio, notes, stats, relationships marked as DM_ONLY)
- **Private messages**: Stored via existing `PrivateMessage` model, delivered tagged with recipient

## Dependencies
- [ ] #144 — Narrator discovery integration (for discovery-filtered location descriptions)
- [ ] #146 — PermissionResolver (for role-based access checks)

## Effort Estimate
- Size: L
- Hours: 10-12
- Parallel: false (capstone task, depends on #144 and #146)

## Definition of Done
- [ ] Same MCP tool call returns appropriately filtered content per role
- [ ] DM-only fields completely hidden from PLAYER and OBSERVER roles
- [ ] Private messages delivered only to intended recipients
- [ ] Session participant tracking reflects actual connection state
- [ ] All existing single-player tests still pass (no regressions)
- [ ] Integration tests cover DM/PLAYER/OBSERVER output for key tools
- [ ] Unit tests passing with > 90% coverage
