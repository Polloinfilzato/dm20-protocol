---
name: Narrator Discovery Integration and Perception Updates
status: completed
created: 2026-02-16T23:42:01Z
updated: 2026-02-16T23:45:39Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/144
depends_on: [143]
parallel: false
conflicts_with: []
---

# Task: Narrator Discovery Integration and Perception Updates

## Description
Integrate the DiscoveryTracker with the Narrator agent so that scene descriptions respect what the party has actually discovered. The narrator receives only visible features plus sensory hints for hidden elements. Also implement the mechanism where perception/investigation check results update discovery levels.

## Acceptance Criteria
- [ ] Narrator agent's scene description templates receive discovery context (visible features, hidden feature hints)
- [ ] When generating a location description, narrator queries DiscoveryTracker for visible features
- [ ] Undiscovered features produce sensory hints ("You notice a cold draft from the north wall...") rather than explicit descriptions
- [ ] GLIMPSED features get vague descriptions; EXPLORED features get full descriptions; FULLY_MAPPED includes DM-level detail
- [ ] Perception/Investigation check results call `DiscoveryTracker.discover_feature()` to upgrade discovery levels
- [ ] First visit to a location auto-sets it to GLIMPSED and reveals "obvious" features
- [ ] `get_location` MCP tool has optional `discovery_filter` parameter (default: true in multi-user, false in single-player)
- [ ] Integration tests verifying narrator output varies by discovery state

## Technical Details
- **Modified file**: `claudmaster/agents/narrator.py` — Inject discovery context into SCENE_DESCRIPTION_TEMPLATE
- **Modified file**: `dm20_protocol/main.py` — Update `get_location` to optionally filter by discovery
- **New helper**: Discovery context builder function that takes location + discovery state → filtered context dict for narrator
- **Template changes**: Add `{discovery_context}` placeholder in scene templates with instructions like "Only describe the following visible features: ..."
- **Perception flow**: When a skill check tool resolves perception/investigation, it calls discovery tracker to upgrade relevant features
- **Hint generation**: A simple mapping from feature type → sensory hint template (e.g., hidden_passage → "draft of air", trap → "slight discoloration")

## Dependencies
- [ ] #143 — DiscoveryTracker must exist and be integrated with storage

## Effort Estimate
- Size: L
- Hours: 10-12
- Parallel: false (depends on #143)

## Definition of Done
- [ ] Narrator generates different descriptions for the same location at different discovery levels
- [ ] Sensory hints for undiscovered features are atmospheric and non-spoiling
- [ ] Perception checks correctly upgrade feature discovery
- [ ] First-visit auto-discovery works correctly
- [ ] get_location respects discovery filter when enabled
- [ ] Integration tests cover all discovery level → description mapping scenarios
