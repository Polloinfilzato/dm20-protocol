---
name: Pack Import with Conflict Resolution and MCP Tools
status: completed
created: 2026-02-16T23:42:01Z
updated: 2026-02-16T23:45:39Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/142
depends_on: [141]
parallel: false
conflicts_with: []
---

# Task: Pack Import with Conflict Resolution and MCP Tools

## Description
Build the PackImporter that loads a CompendiumPack JSON file into the current campaign with conflict resolution (skip, overwrite, rename). Includes preview/dry-run mode, selective import, ID regeneration, relationship re-linking, pack validation, and the remaining MCP tools (import_pack, list_packs, validate_pack).

## Acceptance Criteria
- [ ] `PackImporter` class that validates and imports pack JSON into current campaign
- [ ] Conflict resolution modes: `skip` (keep existing), `overwrite` (replace), `rename` (add suffix)
- [ ] Preview/dry-run mode: shows what would be imported without making changes
- [ ] Selective import: choose which entity types or specific entities to import
- [ ] ID regeneration: new UUIDs for all imported entities to avoid collisions
- [ ] Relationship re-linking: after ID regeneration, update NPC→Location and other cross-references
- [ ] Pack validation: schema check against CompendiumPack model, version compatibility check
- [ ] `import_pack` MCP tool with `file_path`, `conflict_mode`, `preview`, `entity_filter` parameters
- [ ] `list_packs` MCP tool to browse packs in `{storage_dir}/packs/` directory
- [ ] `validate_pack` MCP tool to check pack integrity without importing
- [ ] Support importing from file path
- [ ] Unit tests for import scenarios: clean import, conflicts, selective import, validation failures

## Technical Details
- **Modified file**: `dm20_protocol/compendium.py` — Add PackImporter, PackValidator classes
- **Modified file**: `dm20_protocol/main.py` — Register `import_pack`, `list_packs`, `validate_pack` MCP tools
- **ID regeneration**: Generate new UUIDs, build old→new ID mapping, apply to all cross-references
- **Re-linking strategy**: After ID regen, scan all entity fields that reference other entity IDs/names and update them
- **Conflict detection**: Match by name (case-insensitive) since IDs will differ between campaigns
- **Validation**: Use Pydantic's `model_validate()` for schema check + custom version compatibility logic

## Dependencies
- [ ] #141 — CompendiumPack model and PackSerializer must exist

## Effort Estimate
- Size: M
- Hours: 8-10
- Parallel: false (depends on #141)

## Definition of Done
- [ ] PackImporter handles all three conflict modes correctly
- [ ] Preview mode returns accurate diff without side effects
- [ ] ID regeneration produces unique IDs with correct cross-references
- [ ] All three MCP tools (import_pack, list_packs, validate_pack) functional
- [ ] Round-trip test: export → import → export produces equivalent packs
- [ ] Validation catches malformed packs with clear error messages
- [ ] Unit tests passing with > 90% coverage
