---
name: Claudmaster Integration — Wire Terminology into Player Action Pipeline
status: open
created: 2026-02-12T16:51:04Z
updated: 2026-02-12T16:56:34Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/96
depends_on: [89, 90, 91, 92]
parallel: false
conflicts_with: []
---

# Task: Claudmaster Integration — Wire Terminology into Player Action Pipeline

## Description

Integrate the bilingual terminology system into the Claudmaster AI DM pipeline. Wire `TermResolver` and `StyleTracker` into the `player_action()` flow so that:
1. Player input is scanned for known terms
2. Language preferences are tracked per-category
3. Style preferences are injected into the narrator agent's prompt context
4. The AI DM naturally mirrors the player's language style

Also ensure `TermResolver.index_from_rulebook()` is called when a Claudmaster session starts (after rulebooks are loaded).

## Acceptance Criteria

- [ ] `TermResolver` initialized and loaded (YAML + rulebook indexing) when Claudmaster session starts
- [ ] `StyleTracker` initialized per session (fresh for each new session, preserved on resume)
- [ ] Player input scanned via `resolve_in_text()` on every `player_action()` call
- [ ] Resolved terms' variants observed via `StyleTracker.observe()`
- [ ] `StyleTracker.preferences_summary()` injected into narrator agent context before response generation
- [ ] Style context format suitable for LLM consumption (e.g., "Player prefers: spells in English, skills in Italian")
- [ ] `StyleTracker` state preserved when session is paused and restored on resume
- [ ] E2E test: Italian spell input → tracked as IT preference → narrator context shows "spells: it"
- [ ] E2E test: English skill input → tracked as EN preference → narrator context shows "skills: en"
- [ ] E2E test: Mixed input → correct per-category preferences
- [ ] No performance impact on player_action latency (term scanning is O(n) on input length, lookups are O(1))
- [ ] Graceful degradation: if terminology system fails, player_action still works normally

## Technical Details

### Integration Point: Session Start
In `claudmaster/tools/action_tools.py` or session initialization:
```python
# When session starts / resumes
term_resolver = TermResolver()
term_resolver.load_yaml(Path("src/dm20_protocol/terminology/data/core_terms.yaml"))
if rulebook_manager:
    term_resolver.index_from_rulebook(rulebook_manager)

style_tracker = StyleTracker()  # Fresh per session (or restore from saved state)
```

### Integration Point: player_action()
In `claudmaster/tools/action_tools.py:player_action()`:
```python
# After receiving player input, before processing
matches = term_resolver.resolve_in_text(player_input)
for original_text, term_entry in matches:
    style_tracker.observe(term_entry, original_text)
```

### Integration Point: Narrator Agent
In `claudmaster/agents/narrator.py` or wherever the narrator prompt is assembled:
```python
# Add to narrator context
style_prefs = style_tracker.preferences_summary()
if style_prefs:
    style_hint = format_style_hint(style_prefs)
    # Inject into narrator system prompt or context
```

### Style Hint Format
```
Player language preferences:
- Spells: uses English names (e.g., "Fireball" not "Palla di Fuoco")
- Skills: uses Italian names (e.g., "Furtività" not "Stealth")
- Combat: mixed, slight Italian preference
Mirror their style naturally in your responses.
```

### Session State Persistence
The `StyleTracker._observations` dict should be:
- Serializable (it's just `dict[str, dict[str, int]]`)
- Saved with session state on pause
- Restored from session state on resume
- Reset on new session

### Files Affected
- Modified: `src/dm20_protocol/claudmaster/tools/action_tools.py` (player_action integration)
- Modified: `src/dm20_protocol/claudmaster/agents/narrator.py` (style context injection)
- Modified: `src/dm20_protocol/claudmaster/session.py` (or equivalent — session init + state persistence)
- New: `tests/test_terminology_integration_e2e.py`

## Dependencies

- [ ] Task #89 (TermResolver)
- [ ] Task #90 (core_terms.yaml)
- [ ] Task #91 (StyleTracker)
- [ ] Task #92 (index_from_rulebook)
- [ ] Claudmaster module (existing)

## Effort Estimate

- Size: M
- Hours: 3-4
- Parallel: false (depends on all previous tasks)

## Definition of Done

- [ ] Terminology system wired into Claudmaster pipeline
- [ ] E2E tests passing
- [ ] Session state persistence working
- [ ] No regressions in existing Claudmaster tests
- [ ] No performance degradation
- [ ] Documentation updated (CHANGELOG.md)
