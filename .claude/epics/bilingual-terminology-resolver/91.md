---
name: StyleTracker — Per-Category Language Preference Tracking
status: open
created: 2026-02-12T16:51:04Z
updated: 2026-02-12T16:56:34Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/94
depends_on: [89]
parallel: false
conflicts_with: []
---

# Task: StyleTracker — Per-Category Language Preference Tracking

## Description

Build the `StyleTracker` class that observes which language variant (Italian or English) a player uses for each term category and tracks per-category language preferences. The tracker produces a summary dictionary suitable for injection into the Claudmaster narrator agent's prompt, enabling the AI DM to mirror the player's language style.

## Acceptance Criteria

- [ ] `StyleTracker` class implemented in `src/dm20_protocol/terminology/style.py`
- [ ] `observe(term, used_variant)` method correctly detects whether the variant is EN or IT and increments counters
- [ ] `preferred_language(category)` returns "en" or "it" based on majority observations for that category
- [ ] `preferred_language()` returns "en" as default when no observations exist for a category
- [ ] `preferences_summary()` returns a dict like `{"spell": "en", "skill": "it", "combat": "it"}`
- [ ] `reset()` clears all observations
- [ ] Handles edge cases: tie-breaking (default to "en"), single observation, empty tracker
- [ ] Unit tests covering: single observation, multiple observations, preference flip, tie-breaking, reset, summary format
- [ ] Exported from `src/dm20_protocol/terminology/__init__.py`

## Technical Details

### StyleTracker (style.py)
```python
class StyleTracker:
    _observations: dict[str, dict[str, int]]  # category → {"en": count, "it": count}

    def observe(self, term: TermEntry, used_variant: str) -> None:
        """
        Record that the player used `used_variant` to refer to `term`.
        Determine if used_variant is the EN form or an IT form by comparing
        against term.en, term.it_primary, and term.it_variants.
        """

    def preferred_language(self, category: str) -> str:
        """Return 'en' or 'it' based on observation counts. Default 'en' on tie or no data."""

    def preferences_summary(self) -> dict[str, str]:
        """Return {category: preferred_language} for all observed categories."""

    def reset(self) -> None:
        """Clear all observations."""
```

### Language Detection Logic
To determine if `used_variant` is EN or IT:
1. Normalize `used_variant` the same way TermResolver does
2. Compare against normalized `term.en` → if match, it's "en"
3. Compare against normalized `term.it_primary` and `term.it_variants` → if match, it's "it"
4. Fallback: if `used_variant == term.canonical`, it's "en"

### Integration with TermResolver
The `observe()` method takes a `TermEntry` (from TermResolver.resolve) and the original text the player used. This is called by the integration layer (Task #93), not directly by the user.

### Files Affected
- New: `src/dm20_protocol/terminology/style.py`
- Modified: `src/dm20_protocol/terminology/__init__.py` (add StyleTracker export)
- New: `tests/test_style_tracker.py`

## Dependencies

- [ ] Task #89 (TermEntry model must exist for type annotations and testing)

## Effort Estimate

- Size: S
- Hours: 2-3
- Parallel: false (depends on Task #89 for TermEntry model)

## Definition of Done

- [ ] Code implemented with all methods functional
- [ ] Unit tests written and passing
- [ ] Exported from package `__init__.py`
- [ ] No regressions in existing tests
