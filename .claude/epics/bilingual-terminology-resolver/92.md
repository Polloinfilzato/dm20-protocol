---
name: Rulebook Auto-Indexing — TermResolver Integration with RulebookManager
status: open
created: 2026-02-12T16:51:04Z
updated: 2026-02-12T16:56:34Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/95
depends_on: [89, 90]
parallel: false
conflicts_with: []
---

# Task: Rulebook Auto-Indexing — TermResolver Integration with RulebookManager

## Description

Add the `index_from_rulebook()` method to `TermResolver` that automatically extracts entity names from loaded rulebook sources (spells, monsters, classes, races, items) and indexes them for bilingual lookup. When a rulebook is loaded via `RulebookManager`, the resolver can pull all content names and add them to the lookup dict. Terms already in the static dictionary (core_terms.yaml) are skipped to avoid overwriting curated translations.

## Acceptance Criteria

- [ ] `TermResolver.index_from_rulebook(manager)` method implemented
- [ ] Extracts entity names from all categories: spells, monsters, classes, races, items/feats
- [ ] Creates basic `TermEntry` objects for extracted terms (canonical=name, en=name, category inferred from source)
- [ ] Skips terms that already exist in the static dictionary (YAML-loaded terms take priority)
- [ ] Handles case where `RulebookManager` has no sources loaded (no-op)
- [ ] Handles case where `RulebookManager` has multiple sources (indexes all)
- [ ] Works with both SRD sources and custom library sources
- [ ] Italian translations for rulebook-extracted terms: `it_primary = en` (same as English) since auto-extracted terms don't have translations — they're indexed for English-term recognition
- [ ] Integration tests with real SRD data (load SRD, index, verify spells/monsters are resolvable)
- [ ] Unit tests with mock RulebookManager

## Technical Details

### index_from_rulebook Method
```python
def index_from_rulebook(self, manager: "RulebookManager") -> int:
    """
    Auto-index entity names from loaded rulebook sources.
    Returns count of newly indexed terms.

    Pulls content names from manager's loaded sources and creates
    TermEntry objects for each. Terms already in _lookup are skipped.
    """
```

### RulebookManager Integration Points
The `RulebookManager` (in `src/dm20_protocol/rulebook/`) provides:
- `search_rules(query, category, limit)` — search across loaded sources
- `get_spell_info(name)`, `get_monster_info(name)`, `get_class_info(name)`, `get_race_info(name)` — get specific entries

To get all content names, use `search_rules` with empty query per category:
```python
for category in ["spell", "monster", "class", "race", "item", "feat"]:
    results = manager.search_rules(query="", category=category, limit=9999)
    for result in results:
        # Create TermEntry if not already in _lookup
```

### Category Mapping
| Rulebook category | TermEntry category |
|---|---|
| spell | spell |
| monster | monster |
| class | class |
| race | race |
| item | item |
| feat | general |

### Files Affected
- Modified: `src/dm20_protocol/terminology/resolver.py` (add `index_from_rulebook` method)
- New: `tests/test_terminology_rulebook_integration.py`

## Dependencies

- [ ] Task #89 (TermResolver must exist)
- [ ] Task #90 (core_terms.yaml must exist so we can test skip-if-exists logic)
- [ ] `RulebookManager` (existing, read-only access)

## Effort Estimate

- Size: S
- Hours: 2-3
- Parallel: false (depends on Tasks #89 and #90)

## Definition of Done

- [ ] `index_from_rulebook` method implemented and working
- [ ] Integration tests pass with SRD data
- [ ] Unit tests pass with mock data
- [ ] Static dictionary terms not overwritten by auto-indexing
- [ ] No regressions in existing tests
