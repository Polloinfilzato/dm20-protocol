---
name: TermEntry Model + TermResolver with YAML Loading and O(1) Lookup
status: open
created: 2026-02-12T16:51:04Z
updated: 2026-02-12T16:56:34Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/92
depends_on: []
parallel: true
conflicts_with: []
---

# Task: TermEntry Model + TermResolver with YAML Loading and O(1) Lookup

## Description

Build the core terminology resolution engine: the `TermEntry` Pydantic model and the `TermResolver` class that provides O(1) dictionary lookup for bilingual D&D terms. This includes YAML dictionary loading, Unicode accent normalization, and text scanning for known terms.

Create the new package structure under `src/dm20_protocol/terminology/`.

## Acceptance Criteria

- [ ] New package `src/dm20_protocol/terminology/` created with `__init__.py`, `models.py`, `resolver.py`
- [ ] `TermEntry` Pydantic model with fields: `canonical`, `category`, `en`, `it_primary`, `it_variants`
- [ ] `TermResolver` class with methods: `load_yaml()`, `resolve()`, `resolve_in_text()`, `_normalize()`
- [ ] Accent normalization using `unicodedata.normalize('NFD')` — handles "furtivita" = "furtività"
- [ ] O(1) lookup via internal `_lookup: dict[str, TermEntry]` mapping all normalized variants to entries
- [ ] `resolve()` returns `TermEntry | None` for a single term
- [ ] `resolve_in_text()` finds all known terms in a text string, returns `list[tuple[str, TermEntry]]`
- [ ] Case-insensitive matching (all lookups on lowercased + accent-stripped text)
- [ ] Unknown terms return `None` (no errors, graceful passthrough)
- [ ] Unit tests covering: YAML loading, normalization, exact match, accent-insensitive match, case-insensitive match, unknown term, multi-term text scanning
- [ ] Test fixtures with small sample YAML (5-10 terms) for fast tests

## Technical Details

### Package Structure
```
src/dm20_protocol/terminology/
├── __init__.py        # Export TermEntry, TermResolver
├── models.py          # TermEntry Pydantic model
├── resolver.py        # TermResolver class
└── data/              # (created but YAML content in Task 90)
```

### TermEntry Model (models.py)
```python
class TermEntry(BaseModel):
    canonical: str       # Canonical English key (e.g., "fireball")
    category: str        # spell, skill, condition, ability, combat, item, class, race, general
    en: str              # English display name (e.g., "Fireball")
    it_primary: str      # Primary Italian name (e.g., "Palla di Fuoco")
    it_variants: list[str] = []  # All Italian variants including colloquial
```

### TermResolver (resolver.py)
- `_normalize(text)`: `unicodedata.normalize('NFD', text.lower())` + strip combining marks + strip whitespace
- `load_yaml(path)`: Parse YAML file, create TermEntry for each entry, build `_lookup` dict mapping every normalized variant (en, it_primary, all it_variants, canonical) to the TermEntry
- `resolve(text)`: Normalize input, do dict lookup, return TermEntry or None
- `resolve_in_text(text)`: Tokenize/scan text for known terms (handle multi-word terms), return matches with original text spans

### Normalization Strategy
Use `unicodedata` from stdlib:
```python
import unicodedata
def _normalize(self, text: str) -> str:
    nfkd = unicodedata.normalize('NFD', text.lower().strip())
    return ''.join(c for c in nfkd if not unicodedata.combining(c))
```

### YAML Format Expected
```yaml
terms:
  - canonical: fireball
    category: spell
    en: Fireball
    it_primary: Palla di Fuoco
    it_variants: [Palla di fuoco, palla di fuoco]
```

### Files Affected
- New: `src/dm20_protocol/terminology/__init__.py`
- New: `src/dm20_protocol/terminology/models.py`
- New: `src/dm20_protocol/terminology/resolver.py`
- New: `tests/test_terminology_resolver.py`

## Dependencies

- [ ] No task dependencies (first task in epic)
- [ ] PyYAML (already a project dependency)
- [ ] Pydantic (already a project dependency)

## Effort Estimate

- Size: M
- Hours: 3-4
- Parallel: true (can run in parallel with Task #90)

## Definition of Done

- [ ] Code implemented with all methods functional
- [ ] Unit tests written and passing (pytest)
- [ ] `__init__.py` exports public API
- [ ] No regressions in existing tests
