---
name: TOC extraction from PDFs using PyMuPDF
status: completed
created: 2026-02-02T20:05:44Z
updated: 2026-02-02T20:11:56Z
github: https://github.com/Polloinfilzato/gamemaster-mcp/issues/23
depends_on: [22]
parallel: false
conflicts_with: []
---

# Task: TOC extraction from PDFs using PyMuPDF

## Description

Implement the `TOCExtractor` class that extracts table of contents from PDF files using PyMuPDF. The extractor should identify content types (classes, races, spells, etc.) and create a searchable index structure.

## Acceptance Criteria

- [ ] Create `TOCExtractor` class in `src/gamemaster_mcp/library/extractors/toc.py`
- [ ] Extract TOC from PDF bookmarks/outlines
- [ ] Fall back to heading detection if no bookmarks exist
- [ ] Identify D&D content types from chapter/section titles
- [ ] Store page numbers for each entry
- [ ] Calculate file hash (SHA-256) for change detection
- [ ] Return structured `LibraryIndex` object
- [ ] Handle PDFs without TOC gracefully
- [ ] Unit tests with sample PDF fixtures

## Technical Details

### Files to Create

```
src/gamemaster_mcp/library/extractors/
├── __init__.py
└── toc.py              # TOCExtractor class
```

### TOCExtractor Interface

```python
class TOCExtractor:
    def __init__(self, pdf_path: Path):
        self.pdf_path = pdf_path

    async def extract(self) -> LibraryIndex:
        """Extract TOC and create index."""
        ...

    def _extract_bookmarks(self, doc: fitz.Document) -> list[TOCEntry]: ...
    def _detect_headings(self, doc: fitz.Document) -> list[TOCEntry]: ...
    def _identify_content_type(self, title: str) -> ContentType | None: ...
    def _calculate_hash(self) -> str: ...
```

### Content Type Detection Heuristics

```python
CONTENT_TYPE_PATTERNS = {
    ContentType.CLASS: ["class", "classes"],
    ContentType.RACE: ["race", "races", "lineage", "species"],
    ContentType.SPELL: ["spell", "spells", "magic"],
    ContentType.MONSTER: ["monster", "creatures", "bestiary"],
    ContentType.FEAT: ["feat", "feats"],
    ContentType.ITEM: ["item", "items", "equipment", "magic items"],
    ContentType.SUBCLASS: ["subclass", "archetype", "tradition", "path"],
}
```

### LibraryIndex Model

```python
@dataclass
class TOCEntry:
    title: str
    page: int
    content_type: ContentType | None
    children: list[TOCEntry] = field(default_factory=list)

@dataclass
class LibraryIndex:
    source_id: str
    filename: str
    indexed_at: datetime
    file_hash: str
    total_pages: int
    toc: list[TOCEntry]
    content_summary: dict[ContentType, int]
```

### PyMuPDF Usage

```python
import fitz  # PyMuPDF

def _extract_bookmarks(self, doc: fitz.Document) -> list[TOCEntry]:
    toc = doc.get_toc()  # Returns [(level, title, page), ...]
    # Convert flat list to hierarchical structure
    ...
```

## Dependencies

- [ ] Task #21 (LibraryManager and directory structure)

## Effort Estimate

- Size: M
- Hours: 4-6
- Parallel: false (depends on #21)

## Definition of Done

- [ ] Code implemented with type hints
- [ ] Unit tests with real PDF fixtures
- [ ] TOC extraction works for PDFs with bookmarks
- [ ] Heading fallback works for PDFs without bookmarks
- [ ] Content types correctly identified
- [ ] Performance: < 5 seconds per PDF
