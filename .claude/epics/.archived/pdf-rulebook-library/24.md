---
name: Index persistence and search_library MCP tool
status: completed
created: 2026-02-02T20:05:44Z
updated: 2026-02-03T00:15:00Z
github: https://github.com/Polloinfilzato/gamemaster-mcp/issues/24
depends_on: [22, 23]
parallel: false
conflicts_with: []
---

# Task: Index persistence and search_library MCP tool

## Description

Implement index persistence (save/load JSON files) and create the first MCP tools: `scan_library`, `list_library`, `get_library_toc`, and `search_library`. These tools allow users to discover and search content across their PDF library.

## Acceptance Criteria

- [ ] Implement `IndexStore` class for JSON persistence
- [ ] Save index files to `library/index/{source_id}.index.json`
- [ ] Load existing indexes on startup
- [ ] Detect file changes via hash comparison
- [ ] Implement `scan_library` MCP tool
- [ ] Implement `list_library` MCP tool
- [ ] Implement `get_library_toc` MCP tool
- [ ] Implement `search_library` MCP tool
- [ ] Search across TOC entries by keyword
- [ ] Filter search by content type
- [ ] Unit tests for persistence and search

## Technical Details

### Files to Modify/Create

```
src/gamemaster_mcp/library/
├── index_store.py      # NEW: IndexStore class
└── manager.py          # UPDATE: Add persistence methods

src/gamemaster_mcp/
└── main.py             # UPDATE: Add MCP tools
```

### IndexStore Interface

```python
class IndexStore:
    def __init__(self, index_dir: Path):
        self.index_dir = index_dir

    def save(self, index: LibraryIndex) -> None:
        """Save index to JSON file."""
        path = self.index_dir / f"{index.source_id}.index.json"
        path.write_text(json.dumps(asdict(index), default=str))

    def load(self, source_id: str) -> LibraryIndex | None:
        """Load index from JSON file."""
        ...

    def load_all(self) -> list[LibraryIndex]:
        """Load all indexes."""
        ...

    def needs_reindex(self, pdf_path: Path, existing_index: LibraryIndex) -> bool:
        """Check if file hash changed."""
        ...
```

### MCP Tools

```python
@mcp.tool
async def scan_library() -> str:
    """
    Scan the library folder for new PDF/Markdown files and index them.

    Returns a summary of files found and indexed.
    """
    ...

@mcp.tool
async def list_library() -> str:
    """
    List all sources in the library with their content summaries.

    Returns formatted list of all indexed sources.
    """
    ...

@mcp.tool
async def get_library_toc(source_id: str) -> str:
    """
    Get the table of contents for a specific library source.

    Args:
        source_id: The source identifier (e.g., "tome-of-heroes")

    Returns formatted TOC with page numbers.
    """
    ...

@mcp.tool
async def search_library(
    query: str = "",
    content_type: Literal["all", "class", "race", "spell", "monster", "feat", "item"] = "all",
    limit: int = 20
) -> str:
    """
    Search across all indexed library content.

    Args:
        query: Search term (searches titles)
        content_type: Filter by content type
        limit: Maximum results to return

    Returns matching entries with source and page numbers.
    """
    ...
```

### Search Implementation

```python
def search(self, query: str, content_type: ContentType | None, limit: int) -> list[SearchResult]:
    results = []
    query_lower = query.lower()

    for index in self.indexes.values():
        for entry in self._flatten_toc(index.toc):
            if query_lower in entry.title.lower():
                if content_type is None or entry.content_type == content_type:
                    results.append(SearchResult(
                        title=entry.title,
                        source_id=index.source_id,
                        page=entry.page,
                        content_type=entry.content_type
                    ))

    return results[:limit]
```

## Dependencies

- [ ] Task #21 (LibraryManager)
- [ ] Task #22 (TOCExtractor)

## Effort Estimate

- Size: M
- Hours: 4-6
- Parallel: false (depends on #21, #22)

## Definition of Done

- [ ] Index files persisted to JSON
- [ ] Indexes auto-loaded on startup
- [ ] Re-indexing triggered on file hash change
- [ ] All 4 MCP tools working
- [ ] Search returns relevant results
- [ ] Performance: search < 200ms
- [ ] Unit tests passing
