---
name: Natural language search (ask_books)
status: completed
created: 2026-02-02T20:05:44Z
updated: 2026-02-02T20:11:56Z
github: https://github.com/Polloinfilzato/gamemaster-mcp/issues/30
depends_on: [24, 28]
parallel: true
conflicts_with: []
---

# Task: Natural language search (ask_books)

## Description

Implement the `ask_books` MCP tool that enables natural language queries across the library, such as "find a tanky spellcaster class" or "what options do I have for a dragon-themed character". This is the premium feature that makes the library truly useful for discovery.

## Acceptance Criteria

- [ ] Implement `ask_books` MCP tool
- [ ] Search across TOC titles and descriptions
- [ ] Support semantic queries (not just keyword match)
- [ ] Return results with source, page, and relevance
- [ ] Offer to extract unextracted content
- [ ] Include both library and SRD content in results
- [ ] Group results by source for readability
- [ ] Unit tests for query processing

## Technical Details

### Files to Create/Modify

```
src/gamemaster_mcp/library/
├── search.py           # NEW: Semantic search implementation
└── manager.py          # UPDATE: Integrate search

src/gamemaster_mcp/
└── main.py             # UPDATE: Add ask_books tool
```

### Search Strategy

Since we may not have access to embedding models, we'll use a hybrid approach:

1. **Keyword expansion**: Expand query into related terms
2. **TF-IDF scoring**: Score matches by term frequency
3. **Content type weighting**: Boost exact content type matches
4. **Description matching**: Search extracted content descriptions

```python
class LibrarySearch:
    # Semantic keyword expansion for D&D concepts
    CONCEPT_SYNONYMS = {
        "tanky": ["tank", "defensive", "high hp", "high ac", "durable", "tough"],
        "spellcaster": ["caster", "magic", "spells", "arcane", "divine"],
        "melee": ["martial", "fighter", "warrior", "close combat", "weapon"],
        "healer": ["healing", "support", "restoration", "cure"],
        "dragon": ["draconic", "wyrm", "drake"],
        "stealthy": ["stealth", "rogue", "sneaky", "shadow", "invisible"],
        "nature": ["druid", "ranger", "natural", "wild", "animal"],
    }

    def search(self, query: str, limit: int = 10) -> list[AskBooksResult]:
        """
        Natural language search across library and SRD.

        Returns ranked results with relevance scores.
        """
        # Expand query into keywords
        keywords = self._expand_query(query)

        # Score all indexed content
        results = []
        for index in self.library_manager.indexes.values():
            for entry in self._flatten_toc(index.toc):
                score = self._score_entry(entry, keywords)
                if score > 0:
                    results.append(AskBooksResult(
                        title=entry.title,
                        source_id=index.source_id,
                        source_name=index.filename,
                        page=entry.page,
                        content_type=entry.content_type,
                        score=score,
                        is_extracted=self._is_extracted(index.source_id, entry),
                    ))

        # Sort by score and limit
        results.sort(key=lambda r: r.score, reverse=True)
        return results[:limit]

    def _expand_query(self, query: str) -> list[str]:
        """Expand natural language query into search keywords."""
        words = query.lower().split()
        keywords = set(words)

        for word in words:
            if word in self.CONCEPT_SYNONYMS:
                keywords.update(self.CONCEPT_SYNONYMS[word])

        return list(keywords)

    def _score_entry(self, entry: TOCEntry, keywords: list[str]) -> float:
        """Score an entry against search keywords."""
        title_lower = entry.title.lower()
        score = 0.0

        for keyword in keywords:
            if keyword in title_lower:
                # Exact match in title
                score += 2.0
            elif any(keyword in child.title.lower() for child in entry.children):
                # Match in children
                score += 0.5

        # Boost for content type mentions
        if entry.content_type:
            type_name = entry.content_type.value.lower()
            if type_name in " ".join(keywords):
                score += 1.0

        return score
```

### MCP Tool

```python
@mcp.tool
async def ask_books(query: str, limit: int = 10) -> str:
    """
    Ask a natural language question across all your rulebooks.

    Examples:
    - "What options do I have for a melee spellcaster?"
    - "Find a class good for a dragon-themed character"
    - "What healing spells are available?"

    Args:
        query: Your question in natural language
        limit: Maximum results to return

    Returns matching content from your library and SRD, with options to extract details.
    """
    results = storage.library_manager.search.search(query, limit)

    # Format results grouped by source
    output = [f"**Search Results for:** {query}\n"]

    grouped = defaultdict(list)
    for result in results:
        grouped[result.source_name].append(result)

    for source_name, source_results in grouped.items():
        output.append(f"\n### From {source_name}:\n")
        for r in source_results:
            status = "✓" if r.is_extracted else "[Extract]"
            page_info = f"(p.{r.page})" if r.page else ""
            output.append(f"- **{r.title}** {page_info} {status}")
            if r.content_type:
                output.append(f"  *{r.content_type.value}*")

    if not results:
        output.append("No matching content found. Try different keywords.")

    output.append("\n---")
    output.append("To extract content: `extract_content(source_id, content_name, content_type)`")

    return "\n".join(output)
```

### Example Output

```
**Search Results for:** melee spellcaster

### From Tome of Heroes:
- **Dragon Knight** (p.47) [Extract]
  *class*
- **Spell Blade** (p.62) [Extract]
  *class*

### From SRD:
- **Eldritch Knight** ✓
  *subclass*
- **Bladesinger** ✓
  *subclass*

### From Deep Magic:
- **Battle Mage** (p.89) [Extract]
  *subclass*

---
To extract content: `extract_content(source_id, content_name, content_type)`
```

### Future Enhancement: LLM-Assisted Search

When available, enhance with LLM:

```python
async def _llm_enhanced_search(self, query: str, results: list) -> list:
    """Use LLM to rerank and explain results."""
    # Send results to LLM for relevance scoring
    # Get explanations for why each result matches
    pass
```

## Dependencies

- [ ] Task #23 (Index search for keyword matching)
- [ ] Task #27 (RulebookManager integration for SRD results)

## Effort Estimate

- Size: M
- Hours: 4-6
- Parallel: true (can work once search and integration are done)

## Definition of Done

- [ ] ask_books tool working
- [ ] Natural language queries return relevant results
- [ ] Results include both library and SRD content
- [ ] Extracted vs unextracted clearly indicated
- [ ] Output is readable and actionable
- [ ] Keyword expansion covers common D&D concepts
- [ ] Unit tests for search scoring
