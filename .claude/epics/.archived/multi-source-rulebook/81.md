---
name: MCP Tool and Manager Integration
status: closed
created: 2026-02-12T02:45:03Z
updated: 2026-02-12T12:16:03Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/82
depends_on: []
parallel: true
conflicts_with: []
---

# Task: MCP Tool and Manager Integration

## Description

Wire the new source types (`open5e`, `5etools`) into the existing infrastructure: extend the `load_rulebook` MCP tool's `source` parameter, add factory branches in `RulebookManager._create_source_from_config()`, and add the `FIVETOOLS` enum value to `RulebookSource`. This is a small, surgical change touching 3 existing files.

## Acceptance Criteria

- [ ] `RulebookSource` enum in `models.py` includes `FIVETOOLS = "5etools"`
- [ ] `load_rulebook` MCP tool accepts `source="open5e"` and `source="5etools"`
- [ ] `load_rulebook` with `source="open5e"` creates and loads an `Open5eSource`
- [ ] `load_rulebook` with `source="5etools"` creates and loads a `FiveToolsSource`
- [ ] `_create_source_from_config` in `manager.py` handles `open5e` and `5etools` config types
- [ ] `SourceConfig` supports the new source types for manifest persistence
- [ ] `list_rulebooks` displays Open5e and 5etools sources correctly
- [ ] Existing SRD and Custom source functionality unchanged (regression test)

## Technical Details

### Files to modify

**1. `src/dm20_protocol/rulebooks/models.py`** (~1 line)
```python
class RulebookSource(str, Enum):
    SRD = "srd"
    OPEN5E = "open5e"
    CUSTOM = "custom"
    FIVETOOLS = "5etools"  # ADD THIS
```

**2. `src/dm20_protocol/main.py`** (~20 lines)
- Line 1303: Change `Literal["srd", "custom"]` to `Literal["srd", "custom", "open5e", "5etools"]`
- Line 1304: Update description string
- Add `elif source == "open5e":` block after the `source == "srd"` block
- Add `elif source == "5etools":` block after the open5e block
- Both blocks follow the same pattern as existing SRD block: create source → load → return counts

**3. `src/dm20_protocol/rulebooks/manager.py`** (~10 lines)
- In `_create_source_from_config()` (line ~539): add two `elif` branches
- In `_source_to_config()` (line ~452): handle new source types for manifest serialization

### Import guards
Use lazy imports (same pattern as existing code):
```python
elif config.type == "open5e":
    from .sources.open5e import Open5eSource
    return Open5eSource(cache_dir=cache_dir)
```

## Dependencies

- [ ] Task #80 (Open5eSource) should be complete for open5e to work end-to-end
- [ ] Task #82/#83 (FiveToolsSource) should be complete for 5etools to work end-to-end
- [ ] But the integration code CAN be written before adapters are complete (with stub imports)

## Effort Estimate

- Size: S
- Hours: 1-2
- Parallel: true (can write integration code independently, just needs adapters for testing)
- Conflicts: modifies `main.py`, `manager.py`, `models.py` (shared files)

## Definition of Done

- [ ] All 3 files modified with new source types
- [ ] `load_rulebook(source="open5e")` works end-to-end (requires #80)
- [ ] `load_rulebook(source="5etools")` works end-to-end (requires #82/#83)
- [ ] Existing tests pass unchanged
- [ ] `list_rulebooks` shows correct info for all source types
