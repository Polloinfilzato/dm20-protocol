---
name: FiveToolsSource Data Downloader
status: closed
created: 2026-02-12T02:45:03Z
updated: 2026-02-12T11:56:36Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/83
depends_on: []
parallel: true
conflicts_with: [83]
---

# Task: FiveToolsSource Data Downloader

## Description

Implement the data acquisition layer of `FiveToolsSource` in `src/dm20_protocol/rulebooks/sources/fivetools.py`. This handles discovering available data files from the 5etools GitHub repository, downloading them, and caching the raw JSON locally. The model mapping (parsing 5etools schema into dm20-protocol models) is handled in Task #83.

## Acceptance Criteria

- [ ] `FiveToolsSource` class extends `RulebookSourceBase`
- [ ] Discovers available data files from 5etools GitHub repository structure
- [ ] Downloads JSON data files for: spells, bestiary (monsters), classes, races, feats, items, backgrounds
- [ ] All downloads cached locally as raw JSON files
- [ ] Progress indication during download (logging)
- [ ] Handles network failures gracefully (partial downloads, retries)
- [ ] Cache validation: skip re-download if local files exist and are valid JSON
- [ ] Manual cache refresh: ability to force re-download
- [ ] Unit tests with mocked HTTP responses for download logic

## Technical Details

### File to create
`src/dm20_protocol/rulebooks/sources/fivetools.py`

### 5etools data structure
5etools stores data as JSON files in a `data/` directory. Key files:
- `data/spells/` — One file per source book (e.g., `spells-phb.json`, `spells-xge.json`)
- `data/bestiary/` — Monster files per source (e.g., `bestiary-mm.json`)
- `data/class/` — Class definitions
- `data/race/` — Race definitions
- `data/feat/` — Feat definitions
- `data/items/` — Item definitions
- `data/background/` — Background definitions

### Download strategy
1. Fetch repository file listing (GitHub API or known file paths)
2. Download each category's JSON files
3. Merge multi-file categories (e.g., all spell files into one dataset)
4. Cache merged results locally

### Cache structure
```
{cache_dir}/5etools/
├── raw/                    # Raw downloaded files
│   ├── spells-phb.json
│   ├── spells-xge.json
│   ├── bestiary-mm.json
│   └── ...
├── merged/                 # Merged by category
│   ├── spells.json
│   ├── monsters.json
│   ├── classes.json
│   └── ...
└── metadata.json           # Download timestamp, file manifest
```

### GitHub raw file access
Use `https://raw.githubusercontent.com/` for direct file download.
Consider using a known mirror repository for stability.

### Class structure (partial — mapping in #83)
```python
class FiveToolsSource(RulebookSourceBase):
    def __init__(self, cache_dir: Path | None = None):
        super().__init__(
            source_id="5etools",
            source_type=RulebookSourceType.FIVETOOLS,
            name="5etools",
        )
        self.cache_dir = cache_dir or Path("dnd_data/rulebook_cache/5etools")
        # Content storage (populated by _parse methods in #83)
        self._classes: dict[str, ClassDefinition] = {}
        # ... etc

    async def load(self) -> None:
        await self._ensure_data_downloaded()
        self._parse_all_data()  # Implemented in #83
        self._loaded = True

    async def _ensure_data_downloaded(self) -> None:
        # Download logic here
        ...
```

## Dependencies

- [ ] No task dependencies (can start immediately)
- [ ] External: 5etools GitHub repository availability
- [ ] External: httpx (already a dependency)

## Effort Estimate

- Size: M
- Hours: 3-4
- Parallel: true (independent file, but conflicts with #83 which extends the same file)
- Conflicts: #83 (both modify fivetools.py — work on this FIRST, then #83 adds mapping)

## Definition of Done

- [ ] `FiveToolsSource` class with download infrastructure
- [ ] Successful download of all data categories from 5etools
- [ ] Local cache populated with raw and merged JSON files
- [ ] Unit tests for download logic with mocked HTTP
- [ ] Metadata tracking (download timestamp, file sizes)
