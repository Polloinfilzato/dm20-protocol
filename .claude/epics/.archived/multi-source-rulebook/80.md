---
name: Open5eSource Adapter
status: closed
created: 2026-02-12T02:45:03Z
updated: 2026-02-12T22:11:13Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/81
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Open5eSource Adapter

## Description

Implement the `Open5eSource` class in `src/dm20_protocol/rulebooks/sources/open5e.py`, following the established `SRDSource` pattern. This adapter connects to the Open5e REST API (`https://api.open5e.com/v1/`), fetches all available content (classes, races, spells, monsters, feats, backgrounds, items), caches responses locally as JSON files, and maps Open5e data models to dm20-protocol's existing Pydantic models.

## Acceptance Criteria

- [ ] `Open5eSource` extends `RulebookSourceBase` and implements all abstract methods
- [ ] Fetches from Open5e API endpoints: `/spells/`, `/monsters/`, `/classes/`, `/races/`, `/magicitems/`, `/feats/`, `/backgrounds/`
- [ ] Handles API pagination automatically (Open5e paginates with `?page=N`)
- [ ] Caches all API responses locally as JSON files in campaign cache directory
- [ ] Loads from cache when available (cache-first pattern, same as SRDSource)
- [ ] Maps Open5e response schema to dm20-protocol models (`SpellDefinition`, `MonsterDefinition`, etc.)
- [ ] Batch loading with concurrency control (avoid overwhelming the API)
- [ ] Retry logic with exponential backoff for transient failures
- [ ] Graceful error handling: individual entity failures don't block entire load
- [ ] `search()` works correctly across all content categories
- [ ] `content_counts()` returns accurate counts
- [ ] Unit tests with mocked HTTP responses (> 80% coverage)
- [ ] Source reports `source_type = RulebookSourceType.OPEN5E`

## Technical Details

### File to create
`src/dm20_protocol/rulebooks/sources/open5e.py`

### Open5e API specifics
- Base URL: `https://api.open5e.com/v1/`
- Pagination: responses include `next` URL field (follow until `null`)
- Each result has `document__slug` field (e.g., `5esrd`, `tob`, `cc`) — store but don't filter (Phase 1)
- Rate limiting: be conservative, use batch_size of 1 page at a time with small delays

### Model mapping challenges
- Open5e spell schema differs from SRD API (e.g., `spell_level` vs `level`, different component format)
- Monster stat blocks use different field names (e.g., `challenge_rating` as string "1/4")
- Magic items don't have a direct dm20-protocol model equivalent — map to `ItemDefinition`

### Cache structure
```
{cache_dir}/open5e/
├── spells.json      # All spells (pre-paginated, merged)
├── monsters.json    # All monsters
├── classes.json     # All classes
├── races.json       # All races
├── feats.json       # All feats
├── backgrounds.json # All backgrounds
├── magicitems.json  # All magic items
└── metadata.json    # Fetch timestamp, counts
```

### Template
Use `SRDSource` (`sources/srd.py`) as the primary template — same patterns for:
- `__init__` with cache_dir parameter
- `async load()` with _client management
- `_fetch()` with cache check → HTTP → cache write
- `_map_*()` methods for each content type
- Query methods delegating to internal dicts

## Dependencies

- [ ] No task dependencies (can start immediately)
- [ ] External: httpx (already a dependency)
- [ ] External: Open5e API availability

## Effort Estimate

- Size: M
- Hours: 4-6
- Parallel: true (independent of other tasks)
- Conflicts: none (new file only)

## Definition of Done

- [ ] `Open5eSource` class implemented with all abstract methods
- [ ] Cache-first loading with HTTP fallback
- [ ] All Open5e content types mapped to dm20-protocol models
- [ ] Unit tests with mocked responses passing
- [ ] Manual smoke test: load Open5e source, query spells/monsters
