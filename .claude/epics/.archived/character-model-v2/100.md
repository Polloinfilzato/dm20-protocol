---
name: "Level-Up Engine & MCP Tool"
status: closed
created: 2026-02-12T18:15:41Z
updated: 2026-02-12T19:58:50Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/101
depends_on: [98]
parallel: true
conflicts_with: [99]
---

# Task: Level-Up Engine & MCP Tool

## Description

Create a `LevelUpEngine` module that handles character progression and a new `level_up_character` MCP tool. The engine increments level, rolls/calculates HP, adds class features from ClassDefinition, updates spell slots for casters, handles ASI/feat choices at appropriate levels, and manages subclass selection. This module is also used internally by the CharacterBuilder (Task #99) for creating characters above level 1.

## Acceptance Criteria

- [ ] New `level_up_engine.py` module with `LevelUpEngine` class
- [ ] HP increase: average (default) or roll + CON modifier
- [ ] New class features added from ClassDefinition.class_levels[new_level]
- [ ] Spell slots updated for casters from SpellcastingInfo.spell_slots[new_level]
- [ ] Proficiency bonus auto-updated when it changes (levels 5, 9, 13, 17)
- [ ] ASI handling at levels 4, 8, 12, 16, 19: accept +2 to one ability or +1/+1 to two abilities
- [ ] Subclass selection at class-specific level (typically 3): accept subclass name, validate against ClassDefinition.subclasses
- [ ] New `level_up_character` MCP tool with params: name_or_id, hp_method, asi_choices, subclass, new_spells
- [ ] Hit dice total/remaining updated on level up
- [ ] Returns clear summary of all changes applied
- [ ] Error if no rulebook loaded (needs ClassDefinition for features)
- [ ] Tests for Fighter (simple martial), Ranger (half-caster), Wizard (full caster) progressions

## Technical Details

### New File
- `src/dm20_protocol/level_up_engine.py`

### LevelUpEngine Class
```python
class LevelUpEngine:
    def __init__(self, rulebook_manager: RulebookManager):
        self.rm = rulebook_manager

    def level_up(self, character: Character,
                 hp_method: str = "average",
                 asi_choices: dict | None = None,
                 subclass: str | None = None,
                 new_spells: list[str] | None = None) -> LevelUpResult:
        # 1. Validate rulebook loaded
        # 2. Increment class level
        # 3. Calculate HP increase
        # 4. Add features from class_levels
        # 5. Update spell slots if caster
        # 6. Handle ASI/feat if applicable
        # 7. Handle subclass if applicable
        # 8. Update proficiency bonus
        # 9. Update hit dice
        # 10. Return summary of changes
```

### LevelUpResult (return object)
```python
class LevelUpResult(BaseModel):
    new_level: int
    hp_gained: int
    features_added: list[str]
    spell_slots_changed: bool
    asi_applied: dict | None
    subclass_set: str | None
    proficiency_bonus_changed: bool
    summary: str  # Human-readable summary
```

### HP Calculation
- **Average method**: `(hit_die // 2 + 1) + CON modifier` (PHB standard)
- **Roll method**: Roll hit die via `roll_dice`, add CON modifier, minimum 1

### ASI Logic
- At levels 4, 8, 12, 16, 19 (standard; some classes get extra like Fighter)
- Accept: `{"strength": 2}` (one ability +2) or `{"strength": 1, "dexterity": 1}` (+1/+1)
- Validate: total bonus = 2, ability scores don't exceed 20 (or 30 with magic items)
- If ASI level but no choices provided: warn but proceed (DM can update later)

### MCP Tool (`main.py`)
```python
@mcp.tool()
async def level_up_character(
    name_or_id: str,
    hp_method: str = "average",  # "average" or "roll"
    asi_choices: str | None = None,  # JSON: {"strength": 2}
    subclass: str | None = None,
    new_spells: str | None = None,  # JSON: ["spell1", "spell2"]
) -> str:
```

### Files Modified
- `src/dm20_protocol/level_up_engine.py` (new)
- `src/dm20_protocol/main.py` — new level_up_character tool

## Dependencies

- [ ] Task #98 (Character Model Extension) — needs Feature model and new fields
- [ ] RulebookManager + ClassDefinition data (existing, read-only)

## Effort Estimate

- Size: M
- Hours: 4-6
- Parallel: true (can run parallel with Task #99, #101 after Task #98 completes)

## Definition of Done

- [ ] LevelUpEngine module implemented
- [ ] level_up_character MCP tool registered and working
- [ ] Unit tests: HP calculation (average and roll methods)
- [ ] Unit tests: ASI validation and application
- [ ] Unit tests: Proficiency bonus changes at correct levels
- [ ] Integration tests: Fighter 1→5, Ranger 1→5, Wizard 1→5 with SRD
- [ ] Test: subclass selection at level 3
- [ ] Test: error without rulebook loaded
- [ ] All existing tests pass
- [ ] CHANGELOG.md updated
