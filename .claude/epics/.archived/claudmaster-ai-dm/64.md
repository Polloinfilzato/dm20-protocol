---
name: player_action MCP Tool
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-07T10:12:59Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/61
depends_on: [34, 44]
parallel: true
conflicts_with: []
---

# player_action MCP Tool

## Description

Implement the `player_action` MCP tool that serves as the primary interface for player interactions during gameplay. This tool accepts natural language actions from players, routes them through the Orchestrator for processing by appropriate agents, and returns narrative responses while updating the game state accordingly.

## Acceptance Criteria

- [ ] Implement `player_action` MCP tool function
- [ ] Accept free-form natural language player input
- [ ] Validate session is active before processing
- [ ] Route input through Orchestrator for intent classification
- [ ] Dispatch to appropriate agent(s) based on action type
- [ ] Collect and merge agent responses
- [ ] Generate coherent narrative response
- [ ] Update game state based on action results
- [ ] Track action in session history
- [ ] Record any new facts established
- [ ] Return structured response with narrative and state changes
- [ ] Add comprehensive tests

## Technical Details

### MCP Tool Definition

```python
@tool
async def player_action(
    session_id: str,
    action: str,
    character_name: Optional[str] = None,
    context: Optional[str] = None
) -> dict:
    """
    Process a player action in the current Claudmaster session.

    Args:
        session_id: Active session identifier
        action: Natural language description of the player's action
        character_name: Optional specific character performing the action
        context: Optional additional context for the action

    Returns:
        Response including:
        - narrative: The DM's narrative response
        - action_type: Classification of the action (combat, roleplay, etc.)
        - state_changes: Any changes to game state
        - dice_rolls: Any dice rolls performed
        - npc_responses: NPC dialogue/reactions if applicable
        - follow_up_options: Suggested follow-up actions (optional)
    """
```

### Action Processing Flow

1. **Session Validation**
   - Verify session_id exists and is active
   - Load session state from memory/storage

2. **Input Preprocessing**
   - Normalize input text
   - Extract character context if not provided
   - Build action context from recent history

3. **Orchestrator Routing**
   - Send action to Orchestrator
   - Orchestrator classifies intent
   - Routes to appropriate agent(s)

4. **Agent Processing**
   - Narrative Agent: Generate story response
   - Combat Agent: Handle combat actions (if applicable)
   - Social Agent: Handle NPC interactions (if applicable)
   - Puzzle Agent: Handle puzzles/exploration

5. **Response Aggregation**
   - Collect responses from all involved agents
   - Merge into coherent narrative
   - Resolve any conflicts

6. **State Updates**
   - Apply game state changes
   - Update character conditions/resources
   - Progress any affected quests
   - Record new facts

7. **History Recording**
   - Add action to session history
   - Store for context in future turns

### Response Schema

```python
@dataclass
class ActionResponse:
    narrative: str  # The DM's response text
    action_type: str  # "combat", "roleplay", "exploration", "puzzle", "mixed"
    state_changes: list[StateChange]  # What changed in game state
    dice_rolls: list[DiceRoll]  # Any rolls performed
    npc_responses: list[NPCResponse]  # NPC dialogue/reactions
    follow_up_options: Optional[list[str]] = None  # Suggested actions
    warnings: list[str] = field(default_factory=list)  # Any issues
```

### Action Types

```python
class ActionType(Enum):
    COMBAT = "combat"        # Attack, defend, use ability
    ROLEPLAY = "roleplay"    # Conversation, persuasion
    EXPLORATION = "exploration"  # Search, investigate, travel
    PUZZLE = "puzzle"        # Solve puzzle, decipher
    SKILL_CHECK = "skill_check"  # Generic skill use
    REST = "rest"            # Short/long rest
    INVENTORY = "inventory"  # Item management
    MIXED = "mixed"          # Multiple types
```

### File Structure

```
src/gamemaster_mcp/claudmaster/
├── tools/
│   ├── __init__.py
│   ├── session_tools.py
│   └── action_tools.py    # player_action implementation
```

### Error Handling

- Invalid session ID → return error with guidance
- Session not active → prompt to start/resume session
- Orchestrator timeout → return partial response with warning
- Agent failure → graceful degradation with available agents

## Dependencies

- Task #33: Orchestrator Skeleton (for action routing and processing)
- Task #43: Narrative Agent (for generating narrative responses)

## Effort Estimate

- **Size:** M
- **Estimated Hours:** 6
- **Complexity:** Medium - routing logic and response aggregation

## Definition of Done

1. `player_action` tool implemented and registered
2. Natural language input correctly processed
3. Action routing through Orchestrator working
4. All action types supported
5. Narrative responses generated coherently
6. Game state updates applied correctly
7. Session history properly tracked
8. Fact recording integrated
9. Error handling complete
10. Unit tests for action processing
11. Integration tests with Orchestrator
12. Tool registered in MCP server
