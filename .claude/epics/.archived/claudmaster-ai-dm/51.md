---
name: Improvisation Level System
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-05T19:21:30Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/48
depends_on: [36, 42]
parallel: true
conflicts_with: []
---

# Improvisation Level System

## Description

Implement a configurable improvisation level system that controls how much creative freedom the AI DM agents have when narrating and responding to player actions. This system defines clear boundaries for AI creativity, from strict module adherence to full improvisation, enabling DMs to fine-tune the balance between prepared content and emergent storytelling.

## Acceptance Criteria

- [ ] Define `ImprovisationLevel` enum with five levels: none, low, medium, high, full
- [ ] Document clear behavioral constraints for each improvisation level
- [ ] Implement level-specific constraint injection into agent prompts
- [ ] Define module adherence percentages per level (e.g., none=100%, low=90%, medium=70%, high=40%, full=0%)
- [ ] Store improvisation level setting in `ClaudmasterConfig` dataclass
- [ ] Create helper methods to retrieve level-appropriate constraints
- [ ] Add validation for level transitions during active sessions
- [ ] Include unit tests for all improvisation level functionality

## Technical Details

### ImprovisationLevel Enum

```python
from enum import Enum

class ImprovisationLevel(Enum):
    """Controls AI creativity boundaries during narration."""
    NONE = "none"       # 100% module adherence, verbatim text only
    LOW = "low"         # 90% adherence, minor flavor additions
    MEDIUM = "medium"   # 70% adherence, moderate improvisation
    HIGH = "high"       # 40% adherence, significant creative freedom
    FULL = "full"       # 0% adherence, complete improvisation
```

### Level Behavioral Constraints

| Level | Module Adherence | Allowed Behaviors |
|-------|-----------------|-------------------|
| NONE | 100% | Read module text verbatim, no additions |
| LOW | 90% | Minor descriptive flourishes, maintain plot exactly |
| MEDIUM | 70% | Expand descriptions, add minor NPCs, flexible dialogue |
| HIGH | 40% | Create side content, modify encounters, adapt plot |
| FULL | 0% | Complete creative freedom, module as inspiration only |

### Prompt Constraint Templates

Each level should have associated prompt constraints that are injected into agent system prompts:
- NONE: "You MUST read module content exactly as written..."
- LOW: "Follow module content closely, you may add minor descriptive details..."
- MEDIUM: "Use module as primary guide, moderate improvisation allowed..."
- HIGH: "Module provides framework, significant creative additions encouraged..."
- FULL: "Module is optional inspiration, full creative freedom..."

### ClaudmasterConfig Integration

Add to existing config:
```python
@dataclass
class ClaudmasterConfig:
    # ... existing fields ...
    improvisation_level: ImprovisationLevel = ImprovisationLevel.MEDIUM
    allow_level_change_mid_session: bool = True
```

## Dependencies

- Task 35: Narrator Agent Implementation (needs level constraints in prompts)
- Task 41: ClaudmasterConfig Updates (stores improvisation settings)

## Effort Estimate

- **Size:** M
- **Estimated Hours:** 6
- **Complexity:** Medium - clear domain but requires careful prompt engineering

## Definition of Done

1. ImprovisationLevel enum fully defined with all five levels
2. Level constraints documented and implemented as prompt templates
3. Module adherence percentages defined and validated
4. ClaudmasterConfig updated with improvisation settings
5. Helper methods for constraint retrieval working correctly
6. All code passes linting and type checking
7. Unit tests written and passing (>90% coverage)
8. Documentation complete with usage examples
