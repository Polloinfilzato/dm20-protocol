---
name: Adventure Module Parser
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-06T23:10:22Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/35
depends_on: [37]
parallel: false
conflicts_with: []
---

# Adventure Module Parser

## Description

Create a parser for adventure module PDFs that extracts structural information including chapters, sections, encounters, NPCs, and locations from the table of contents. This builds on the existing PDF library index system to understand adventure module organization and prepare content for RAG indexing.

## Acceptance Criteria

- [ ] Create `ModuleParser` class in `src/gamemaster_mcp/claudmaster/module_parser.py`
- [ ] Parse adventure module PDF structure from TOC
- [ ] Extract chapter hierarchy (chapters, sections, subsections)
- [ ] Identify and extract encounter references
- [ ] Identify and extract NPC references with locations
- [ ] Identify and extract location/area references
- [ ] Create `ModuleStructure` data model for parsed content
- [ ] Integrate with existing `library_index.py` TOC extraction
- [ ] Handle multiple adventure module formats (WotC, third-party)
- [ ] Add unit tests with sample module structures
- [ ] Include docstrings for all public methods

## Technical Details

### File Location

```
src/gamemaster_mcp/claudmaster/
├── module_parser.py     # ModuleParser class
├── models/
│   └── module.py        # ModuleStructure data models
└── ...
```

### ModuleStructure Data Models

```python
from dataclasses import dataclass, field
from typing import List, Optional, Dict
from enum import Enum

class ContentType(Enum):
    CHAPTER = "chapter"
    SECTION = "section"
    ENCOUNTER = "encounter"
    NPC = "npc"
    LOCATION = "location"
    ITEM = "item"
    APPENDIX = "appendix"

@dataclass
class ModuleElement:
    """Base element in module structure."""
    name: str
    content_type: ContentType
    page_start: int
    page_end: Optional[int] = None
    parent: Optional[str] = None
    children: List[str] = field(default_factory=list)

@dataclass
class NPCReference:
    """NPC found in module."""
    name: str
    location: Optional[str] = None
    chapter: str = ""
    page: int = 0
    description_preview: str = ""

@dataclass
class EncounterReference:
    """Encounter found in module."""
    name: str
    location: str
    chapter: str
    page: int
    encounter_type: str = "combat"  # combat, social, exploration, puzzle

@dataclass
class LocationReference:
    """Location/area found in module."""
    name: str
    chapter: str
    page: int
    parent_location: Optional[str] = None
    sub_locations: List[str] = field(default_factory=list)

@dataclass
class ModuleStructure:
    """Complete parsed structure of an adventure module."""
    module_id: str
    title: str
    source_file: str
    chapters: List[ModuleElement] = field(default_factory=list)
    npcs: List[NPCReference] = field(default_factory=list)
    encounters: List[EncounterReference] = field(default_factory=list)
    locations: List[LocationReference] = field(default_factory=list)
    metadata: Dict[str, str] = field(default_factory=dict)
```

### ModuleParser Class Interface

```python
class ModuleParser:
    """Parses adventure module PDFs into structured data."""

    def __init__(self, library_path: str):
        """Initialize with path to PDF library."""
        pass

    def parse_module(self, source_id: str) -> ModuleStructure:
        """Parse a module from the library index."""
        pass

    def extract_chapters(self, toc_entries: List) -> List[ModuleElement]:
        """Extract chapter hierarchy from TOC."""
        pass

    def extract_npcs(self, toc_entries: List) -> List[NPCReference]:
        """Identify NPC entries in TOC."""
        pass

    def extract_encounters(self, toc_entries: List) -> List[EncounterReference]:
        """Identify encounter entries in TOC."""
        pass

    def extract_locations(self, toc_entries: List) -> List[LocationReference]:
        """Identify location/area entries in TOC."""
        pass
```

### Integration with Existing Library Index

The parser should use the existing `library/` system:
- Read from `library/indexes/{source_id}.json` for TOC data
- Access PDF content via existing `pdf_utils.py`
- Leverage existing `search_library` functionality

### Pattern Recognition for Content Types

Common patterns to identify:
- NPCs: "Strahd von Zarovich", names followed by "(NPC)", stat block references
- Encounters: "Encounter:", area numbers (e.g., "K1.", "Area 12")
- Locations: Chapter titles with location names, "Areas of X", "Map of Y"

## Dependencies

- Task #36 (ChromaDB Vector Store Setup) - storage for parsed structure
- Existing PDF Rulebook Library system - TOC extraction

## Effort Estimate

- **Size:** L
- **Estimated Hours:** 10
- **Complexity:** High - parsing varied module formats

## Definition of Done

1. ModuleParser class fully implemented
2. ModuleStructure and related data models defined
3. Chapter hierarchy extraction working for test modules
4. NPC extraction identifying major NPCs correctly
5. Encounter extraction finding encounter sections
6. Location extraction building location hierarchy
7. Integration with existing library index working
8. Handles at least 2 different module formats
9. All unit tests passing
10. Code passes linting and type checking
11. Documentation complete
