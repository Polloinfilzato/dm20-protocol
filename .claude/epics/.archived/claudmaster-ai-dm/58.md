---
name: Player Guidance System for Companions
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-07T01:48:13Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/55
depends_on: [55, 56]
parallel: false
conflicts_with: []
---

# Player Guidance System for Companions

## Description

Implement a system that allows players to give tactical guidance to their companions using natural language commands. Commands like "stay back", "focus the healer", or "protect the wizard" are parsed and translated into behavioral overrides that persist across combat rounds. This gives players meaningful control over companions without requiring micromanagement of every action.

## Acceptance Criteria

- [ ] Implement natural language command parser for common tactical phrases
- [ ] Create guidance persistence system (maintains across rounds)
- [ ] Support overriding companion default archetype behavior
- [ ] Implement guidance validation (reject impossible commands)
- [ ] Add guidance acknowledgment/confirmation from companions
- [ ] Support clearing/resetting guidance to defaults
- [ ] Handle conflicting or ambiguous commands gracefully
- [ ] Write tests for command parsing and behavior changes
- [ ] Document supported command patterns

## Technical Details

### GuidanceParser Class

```python
from dataclasses import dataclass
from enum import Enum
from typing import Optional

class GuidanceType(Enum):
    POSITIONING = "positioning"       # "stay back", "go front"
    TARGET_FOCUS = "target_focus"     # "focus the mage", "attack goblins"
    TARGET_AVOID = "target_avoid"     # "ignore the minions"
    ABILITY_USE = "ability_use"       # "use healing spells", "save your big attacks"
    PROTECTION = "protection"         # "protect Gandalf", "guard the healer"
    AGGRESSION = "aggression"         # "be aggressive", "play it safe"
    GENERAL = "general"               # "do your thing", "follow my lead"

@dataclass
class ParsedGuidance:
    guidance_type: GuidanceType
    target: Optional[str] = None      # Target entity if applicable
    modifier: Optional[str] = None    # Additional context
    priority: int = 1                 # Higher = more important
    duration: Optional[int] = None    # Rounds, or None for permanent

@dataclass
class CompanionGuidance:
    companion_id: str
    active_guidance: list[ParsedGuidance]

    def add_guidance(self, guidance: ParsedGuidance) -> None:
        """Add new guidance, handling conflicts."""
        pass

    def clear_guidance(self, guidance_type: Optional[GuidanceType] = None) -> None:
        """Clear guidance, optionally by type."""
        pass

class GuidanceParser:
    """Parses natural language commands into tactical guidance."""

    # Command patterns
    POSITIONING_PATTERNS = [
        (r"stay (back|behind)", GuidanceType.POSITIONING, "back"),
        (r"(go|move|get) (to the )?(front|forward)", GuidanceType.POSITIONING, "front"),
        (r"flank", GuidanceType.POSITIONING, "flank"),
        (r"stay (close|near)", GuidanceType.POSITIONING, "close"),
    ]

    TARGET_PATTERNS = [
        (r"(focus|target|attack|kill) (?:the |on )?(.+)", GuidanceType.TARGET_FOCUS),
        (r"(ignore|avoid|don't attack) (?:the )?(.+)", GuidanceType.TARGET_AVOID),
    ]

    PROTECTION_PATTERNS = [
        (r"protect (?:the )?(.+)", GuidanceType.PROTECTION),
        (r"guard (?:the )?(.+)", GuidanceType.PROTECTION),
        (r"keep (.+) safe", GuidanceType.PROTECTION),
    ]

    def parse(self, command: str, companion_id: str) -> Optional[ParsedGuidance]:
        """Parse a natural language command into guidance."""
        pass

    def validate(self, guidance: ParsedGuidance, context: CombatState) -> tuple[bool, str]:
        """Validate guidance is possible given current state."""
        pass
```

### Supported Command Examples

| Command | Guidance Type | Effect |
|---------|---------------|--------|
| "Stay back" | POSITIONING | Companion moves to rear positions |
| "Focus the healer" | TARGET_FOCUS | Prioritize enemy healers |
| "Ignore the minions" | TARGET_AVOID | Don't waste actions on low-value targets |
| "Protect Aragorn" | PROTECTION | Stay near and defend specified ally |
| "Be aggressive" | AGGRESSION | Lower caution, increase damage priority |
| "Play it safe" | AGGRESSION | Higher caution, defensive choices |
| "Save your spells" | ABILITY_USE | Prefer basic attacks over resources |
| "Use healing only" | ABILITY_USE | Restrict to healing abilities |

### Guidance Persistence

```python
class GuidanceManager:
    """Manages guidance across combat rounds."""

    def __init__(self):
        self.companion_guidance: dict[str, CompanionGuidance] = {}

    def apply_guidance(self, companion_id: str, command: str) -> str:
        """Apply new guidance and return confirmation."""
        pass

    def get_active_guidance(self, companion_id: str) -> list[ParsedGuidance]:
        """Get all active guidance for a companion."""
        pass

    def tick_round(self) -> None:
        """Advance round counters, expire temporary guidance."""
        pass

    def reset_combat_end(self) -> None:
        """Clear combat-specific guidance when combat ends."""
        pass
```

### TacticsEngine Integration

Guidance overrides default archetype behavior:

```python
def decide_action(self) -> TacticalDecision:
    # Get base decision from archetype
    base_decision = self._archetype_decision()

    # Apply guidance overrides
    guidance = self.guidance_manager.get_active_guidance(self.companion.id)

    for g in guidance:
        if g.guidance_type == GuidanceType.TARGET_FOCUS:
            base_decision = self._override_target(base_decision, g.target)
        elif g.guidance_type == GuidanceType.POSITIONING:
            base_decision = self._override_position(base_decision, g.modifier)
        # ... etc

    return base_decision
```

### Guidance Validation

- Check if target exists in combat
- Verify companion can reach specified position
- Ensure requested abilities are available
- Reject logically impossible commands

### Companion Acknowledgment

Companions respond to guidance:
- "Got it, staying back."
- "I'll focus on the mage."
- "I can't reach them from here."

## Dependencies

- Task #54: Companion NPC Profiles
  - Requires companion identity for guidance tracking
  - Uses personality for acknowledgment tone
- Task #55: AI Combat Tactics for Companions
  - Guidance modifies TacticsEngine decisions
  - Integrates with target selection and positioning

## Effort Estimate

- **Size:** S
- **Estimated Hours:** 4
- **Complexity:** Medium - NLP parsing with game state integration

## Definition of Done

1. Parser handles all documented command patterns
2. Guidance persists correctly across rounds
3. Default behavior successfully overridden
4. Validation rejects impossible commands
5. Companion acknowledgments generated
6. Clear/reset functionality working
7. Conflicting commands handled gracefully
8. Unit tests cover parsing edge cases
9. Integration tests verify behavior changes
10. Code reviewed and approved
