---
name: Module Keeper Agent
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-06T23:45:00Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/37
depends_on: [33, 39]
parallel: false
conflicts_with: []
---

# Module Keeper Agent

## Description

Implement the Module Keeper Agent, a specialized agent responsible for RAG-based retrieval of adventure module content. This agent provides the AI DM with knowledge about the current module's plot, NPCs, locations, and encounters, enabling faithful module execution while supporting improvisation within set boundaries.

## Acceptance Criteria

- [ ] Create `ModuleKeeperAgent` class extending base `Agent`
- [ ] Implement RAG query interface for module content retrieval
- [ ] Implement NPC knowledge retrieval (personality, goals, secrets)
- [ ] Implement location description retrieval (descriptions, features, hazards)
- [ ] Implement encounter trigger detection (conditions, setup, resolution)
- [ ] Support plot progression queries (what happens next, key beats)
- [ ] Filter results by current chapter/location context
- [ ] Support "what does [NPC] know about [topic]" queries
- [ ] Track which module content has been revealed to players
- [ ] Add unit tests for all retrieval methods
- [ ] Include docstrings for all public methods

## Technical Details

### File Location

```
src/gamemaster_mcp/claudmaster/agents/
├── __init__.py
├── module_keeper.py     # ModuleKeeperAgent class
└── ...
```

### ModuleKeeperAgent Class

```python
from ..base import Agent
from ..vector_store import VectorStoreManager
from ..module_parser import ModuleStructure
from typing import List, Dict, Any, Optional

class ModuleKeeperAgent(Agent):
    """Agent responsible for adventure module knowledge via RAG."""

    def __init__(
        self,
        vector_store: VectorStoreManager,
        module_structure: ModuleStructure,
        current_chapter: Optional[str] = None,
        current_location: Optional[str] = None
    ):
        """Initialize with vector store and module structure."""
        pass

    # ReAct Pattern Implementation
    async def reason(self, context: dict) -> str:
        """Analyze query to determine what module knowledge is needed."""
        pass

    async def act(self, reasoning: str) -> Any:
        """Execute RAG queries based on reasoning."""
        pass

    async def observe(self, result: Any) -> dict:
        """Process RAG results into structured response."""
        pass

    # Module Knowledge Queries
    async def get_npc_knowledge(
        self,
        npc_name: str,
        topic: Optional[str] = None
    ) -> NPCKnowledge:
        """Retrieve what an NPC knows about a topic."""
        pass

    async def get_location_description(
        self,
        location_name: str,
        detail_level: str = "full"  # "brief", "full", "dm_only"
    ) -> LocationDescription:
        """Retrieve location description at specified detail."""
        pass

    async def check_encounter_trigger(
        self,
        current_location: str,
        player_actions: List[str]
    ) -> Optional[EncounterTrigger]:
        """Check if player actions trigger an encounter."""
        pass

    async def get_plot_context(
        self,
        query: str
    ) -> PlotContext:
        """Get relevant plot information for current situation."""
        pass

    # State Management
    def set_context(
        self,
        chapter: Optional[str] = None,
        location: Optional[str] = None
    ) -> None:
        """Update current context for filtered queries."""
        pass

    def mark_revealed(
        self,
        content_type: str,
        content_id: str
    ) -> None:
        """Mark module content as revealed to players."""
        pass
```

### Response Data Models

```python
@dataclass
class NPCKnowledge:
    """Knowledge about an NPC."""
    npc_name: str
    personality: str
    goals: List[str]
    secrets: List[str]  # DM-only information
    relationships: Dict[str, str]
    current_location: Optional[str]
    knowledge_about_topic: Optional[str]
    relevant_quotes: List[str]

@dataclass
class LocationDescription:
    """Description of a location."""
    name: str
    read_aloud_text: Optional[str]  # Boxed text for players
    dm_description: str  # Full description with secrets
    features: List[str]
    exits: List[str]
    hazards: List[str]
    creatures_present: List[str]
    treasure: List[str]

@dataclass
class EncounterTrigger:
    """Triggered encounter information."""
    name: str
    trigger_condition: str
    setup: str
    creatures: List[str]
    tactics: str
    resolution_options: List[str]

@dataclass
class PlotContext:
    """Plot-relevant context."""
    current_chapter_summary: str
    key_objectives: List[str]
    upcoming_events: List[str]
    relevant_npcs: List[str]
    relevant_locations: List[str]
    foreshadowing_hints: List[str]
```

### Query Strategy

1. **Context-aware filtering**: Prioritize results from current chapter/location
2. **Multi-query approach**: Combine specific queries for comprehensive answers
3. **Metadata filtering**: Use ChromaDB `where` clauses for precise retrieval
4. **Re-ranking**: Score results by relevance to current game state

### Revealed Content Tracking

Track what players have learned to:
- Avoid repetition in descriptions
- Enable NPCs to reference shared knowledge
- Support "what do we know about X" queries

## Dependencies

- Task #32 (Claudmaster Directory Structure) - base Agent class
- Task #38 (Module Content Chunking and Indexing) - indexed content

## Effort Estimate

- **Size:** L
- **Estimated Hours:** 12
- **Complexity:** High - core intelligence component

## Definition of Done

1. ModuleKeeperAgent extends base Agent correctly
2. ReAct pattern (reason, act, observe) implemented
3. NPC knowledge retrieval working accurately
4. Location descriptions retrieved at correct detail levels
5. Encounter triggers detected from player actions
6. Plot context provides relevant information
7. Context filtering improves result relevance
8. Revealed content tracking working
9. All unit tests passing
10. Code passes linting and type checking
11. Documentation complete
