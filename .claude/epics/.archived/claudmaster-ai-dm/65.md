---
name: end_session and get_session_state MCP Tools
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-07T10:26:34Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/62
depends_on: [34, 47]
parallel: true
conflicts_with: []
---

# end_session and get_session_state MCP Tools

## Description

Implement two essential session management MCP tools: `end_session` for cleanly terminating or pausing a Claudmaster session (with full state persistence), and `get_session_state` for querying the current state of an active session. These tools ensure data integrity and provide visibility into session status.

## Acceptance Criteria

### end_session Tool
- [ ] Implement `end_session` MCP tool function
- [ ] Support both "pause" (save for later) and "end" (complete termination) modes
- [ ] Persist all session state to disk
- [ ] Save fact database state
- [ ] Save conversation/action history
- [ ] Save context window state
- [ ] Clean up active session from memory
- [ ] Return session summary with save confirmation
- [ ] Handle already-ended sessions gracefully

### get_session_state Tool
- [ ] Implement `get_session_state` MCP tool function
- [ ] Return comprehensive current session state
- [ ] Include game state summary
- [ ] Include active characters and their status
- [ ] Include recent history (last N actions)
- [ ] Include session metadata (duration, action count)
- [ ] Support optional detail level parameter
- [ ] Handle invalid/inactive sessions gracefully

### General
- [ ] Implement session state serialization
- [ ] Define persistent storage format
- [ ] Add unit and integration tests

## Technical Details

### end_session Tool Definition

```python
@tool
async def end_session(
    session_id: str,
    mode: str = "pause",  # "pause" or "end"
    summary_notes: Optional[str] = None
) -> dict:
    """
    End or pause a Claudmaster session, saving all state.

    Args:
        session_id: Session to end
        mode: "pause" (can resume later) or "end" (final termination)
        summary_notes: Optional DM notes to save with session

    Returns:
        - status: "saved" or "ended"
        - session_summary: Brief summary of session
        - save_path: Where state was persisted
        - stats: Session statistics (duration, actions, etc.)
    """
```

### get_session_state Tool Definition

```python
@tool
async def get_session_state(
    session_id: str,
    detail_level: str = "standard",  # "minimal", "standard", "full"
    include_history: bool = True,
    history_limit: int = 10
) -> dict:
    """
    Get the current state of a Claudmaster session.

    Args:
        session_id: Session to query
        detail_level: How much detail to include
        include_history: Whether to include action history
        history_limit: Max number of history entries

    Returns:
        - session_info: Basic session metadata
        - game_state: Current game state
        - party_status: Character conditions and resources
        - recent_history: Last N actions (if requested)
        - active_quests: Current quest status
        - context_usage: Context window utilization
    """
```

### Session Persistence Format

```
campaigns/{campaign_name}/claudmaster_sessions/
├── {session_id}/
│   ├── session_meta.json      # Session metadata
│   ├── state_snapshot.json    # Game state at save
│   ├── fact_database.json     # Established facts
│   ├── action_history.json    # Action log
│   └── context_state.json     # Context manager state
```

### Session Metadata Schema

```python
@dataclass
class SessionMetadata:
    session_id: str
    campaign_name: str
    module_id: Optional[str]
    status: str  # "active", "paused", "ended"
    created_at: datetime
    last_active: datetime
    total_duration_minutes: int
    action_count: int
    save_notes: Optional[str]
```

### State Serialization

```python
class SessionSerializer:
    """Handles session state persistence."""

    def save_session(
        self,
        session: ClaudmasterSession,
        mode: str
    ) -> Path:
        """Serialize and save complete session state."""

    def load_session(
        self,
        session_id: str,
        campaign_path: Path
    ) -> ClaudmasterSession:
        """Load session state from disk."""

    def list_sessions(
        self,
        campaign_path: Path
    ) -> list[SessionMetadata]:
        """List all saved sessions for a campaign."""
```

### File Structure

```
src/gamemaster_mcp/claudmaster/
├── tools/
│   ├── __init__.py
│   ├── session_tools.py    # start_claudmaster_session, end_session, get_session_state
│   └── action_tools.py
├── persistence/
│   ├── __init__.py
│   └── session_serializer.py
```

## Dependencies

- Task #33: Orchestrator Skeleton (for session management)
- Task #46: Fact Tracker System (for persisting fact database)

## Effort Estimate

- **Size:** S
- **Estimated Hours:** 4
- **Complexity:** Low-Medium - primarily serialization and file I/O

## Definition of Done

1. `end_session` tool implemented and registered
2. `get_session_state` tool implemented and registered
3. Session pause mode saves all state correctly
4. Session end mode terminates cleanly
5. State serialization complete and reversible
6. Session can be loaded after save
7. get_session_state returns accurate information
8. All detail levels supported
9. Error handling for invalid sessions
10. Unit tests for serialization
11. Integration tests for save/load cycle
12. Tools registered in MCP server
