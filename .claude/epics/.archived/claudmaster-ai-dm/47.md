---
name: Fact Tracker System
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-06T23:45:00Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/44
depends_on: [34]
parallel: true
conflicts_with: []
---

# Fact Tracker System

## Description

Implement a comprehensive fact tracking system that stores and manages established narrative facts throughout a campaign. The FactDatabase class will track events, discoveries, NPC information, and item details, enabling the AI DM to maintain narrative consistency and recall important story elements during gameplay.

## Acceptance Criteria

- [ ] Implement `FactDatabase` class with CRUD operations
- [ ] Store established narrative facts (events, discoveries, revelations)
- [ ] Categorize facts by type (event, location, npc, item, quest, world)
- [ ] Query facts by category, session number, and relevance score
- [ ] Persist facts to `fact_database.json` per campaign
- [ ] Support fact linking (related facts, cause-effect chains)
- [ ] Implement fact importance/relevance scoring
- [ ] Add timestamp and session tracking for each fact
- [ ] Create unit tests for all FactDatabase operations

## Technical Details

### File Structure

```
src/gamemaster_mcp/claudmaster/
├── consistency/
│   ├── __init__.py
│   ├── fact_database.py    # FactDatabase class
│   └── models.py           # Fact dataclass and enums
```

### Fact Model

```python
from dataclasses import dataclass, field
from enum import Enum
from datetime import datetime
from typing import Optional

class FactCategory(Enum):
    EVENT = "event"
    LOCATION = "location"
    NPC = "npc"
    ITEM = "item"
    QUEST = "quest"
    WORLD = "world"

@dataclass
class Fact:
    id: str
    category: FactCategory
    content: str
    session_number: int
    timestamp: datetime
    relevance_score: float = 1.0
    related_facts: list[str] = field(default_factory=list)
    tags: list[str] = field(default_factory=list)
    source: Optional[str] = None  # Who/what established this fact
```

### FactDatabase Class

```python
class FactDatabase:
    """Stores and manages narrative facts for consistency tracking."""

    def __init__(self, campaign_path: Path):
        """Initialize with campaign-specific storage path."""

    def add_fact(self, fact: Fact) -> str:
        """Add a new fact, return its ID."""

    def get_fact(self, fact_id: str) -> Optional[Fact]:
        """Retrieve a specific fact by ID."""

    def query_facts(
        self,
        category: Optional[FactCategory] = None,
        session: Optional[int] = None,
        min_relevance: float = 0.0,
        tags: Optional[list[str]] = None,
        limit: int = 50
    ) -> list[Fact]:
        """Query facts with filters."""

    def get_related_facts(self, fact_id: str) -> list[Fact]:
        """Get all facts related to a given fact."""

    def update_relevance(self, fact_id: str, new_score: float) -> None:
        """Update the relevance score of a fact."""

    def link_facts(self, fact_id_1: str, fact_id_2: str) -> None:
        """Create a bidirectional link between two facts."""

    def save(self) -> None:
        """Persist facts to fact_database.json."""

    def load(self) -> None:
        """Load facts from fact_database.json."""
```

### Storage Format (fact_database.json)

```json
{
  "version": "1.0",
  "campaign_id": "shadows-over-eldoria",
  "facts": [
    {
      "id": "fact_001",
      "category": "event",
      "content": "The party discovered the hidden entrance to the Shadowfell portal in the old crypt",
      "session_number": 5,
      "timestamp": "2026-02-05T20:30:00Z",
      "relevance_score": 0.9,
      "related_facts": ["fact_003", "fact_007"],
      "tags": ["shadowfell", "discovery", "main-quest"],
      "source": "exploration"
    }
  ],
  "metadata": {
    "total_facts": 1,
    "last_updated": "2026-02-05T19:06:45Z"
  }
}
```

## Dependencies

- Task 33: Context Window Manager (for retrieving relevant facts within context limits)

## Effort Estimate

- **Size:** M
- **Estimated Hours:** 8
- **Complexity:** Medium - data modeling and persistence with query capabilities

## Definition of Done

1. FactDatabase class fully implemented with all CRUD operations
2. Fact categorization system working correctly
3. Query system supports filtering by category, session, relevance, and tags
4. Facts properly persisted to and loaded from JSON
5. Fact linking (relationships) implemented
6. Relevance scoring system functional
7. All code passes linting and type checking
8. Unit tests written and passing (>90% coverage for fact_database.py)
9. Documentation/docstrings complete
10. Integration with campaign storage structure verified
