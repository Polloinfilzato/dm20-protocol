---
name: Canonical vs Improvised Tagging
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-07T09:23:03Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/51
depends_on: [47, 51]
parallel: true
conflicts_with: []
---

# Canonical vs Improvised Tagging

## Description

Implement a tagging system that marks all narrative outputs as either canonical (from module) or improvised (AI-generated). This enables DMs to track what content came from the prepared module versus AI creativity, review improvised content for potential issues, and maintain clarity about the campaign's established canon.

## Acceptance Criteria

- [ ] Tag all narrative outputs with canonical/improvised classification
- [ ] Store tags in the fact database alongside content
- [ ] Implement query interface for filtering improvised content
- [ ] Add improvisation markers to session notes output
- [ ] Create confidence scoring for classification
- [ ] Support hybrid tagging for partially improvised content
- [ ] Add MCP tools for reviewing tagged content
- [ ] Include tests for tagging accuracy

## Technical Details

### Content Tags

```python
from enum import Enum
from dataclasses import dataclass
from typing import Optional, List

class ContentOrigin(Enum):
    """Origin classification for narrative content."""
    CANONICAL = "canonical"      # Directly from module
    IMPROVISED = "improvised"    # AI-generated
    HYBRID = "hybrid"            # Combination of both

@dataclass
class ContentTag:
    """Tag attached to narrative content."""
    origin: ContentOrigin
    confidence: float           # 0.0-1.0 classification confidence
    module_source: Optional[str]  # Module section if canonical
    improvisation_level: Optional[ImprovisationLevel]  # Level used if improvised
    timestamp: datetime
    agent_id: str               # Which agent generated it
```

### Tagged Narrative Output

```python
@dataclass
class TaggedNarrative:
    """Narrative output with origin tagging."""
    content: str
    tag: ContentTag
    segments: List[TaggedSegment]  # For hybrid content

@dataclass
class TaggedSegment:
    """Individual segment within hybrid content."""
    text: str
    start_index: int
    end_index: int
    origin: ContentOrigin
    source_reference: Optional[str]
```

### Fact Database Integration

Extend fact storage schema:
```python
@dataclass
class TaggedFact:
    """Fact with origin tracking."""
    fact_id: str
    content: str
    origin_tag: ContentTag
    established_in_session: int
    last_referenced_session: int
    times_referenced: int
```

### Query Interface

```python
class TaggedContentQuery:
    """Query interface for tagged content."""

    def get_improvised_content(
        self,
        session_range: Optional[Tuple[int, int]] = None,
        agent_filter: Optional[str] = None,
        min_confidence: float = 0.5
    ) -> List[TaggedNarrative]:
        """Retrieve all improvised content matching criteria."""
        pass

    def get_canonical_content(
        self,
        module_section: Optional[str] = None
    ) -> List[TaggedNarrative]:
        """Retrieve canonical content, optionally by module section."""
        pass

    def get_hybrid_breakdown(
        self,
        narrative_id: str
    ) -> List[TaggedSegment]:
        """Get segment-by-segment breakdown of hybrid content."""
        pass
```

### Session Notes Integration

Session notes should display improvisation markers:
```markdown
## Session 5 Summary

### Events
- [CANONICAL] Party arrived at Phandalin as described in module
- [IMPROVISED] Added encounter with traveling merchant (AI-generated)
- [HYBRID] Modified goblin ambush dialogue (50% canonical)

### NPCs Encountered
- Sildar Hallwinter [CANONICAL]
- Merchant Tomas [IMPROVISED] - created by Narrator agent
```

### MCP Tools

- `list_improvised_content(session?, limit?)` - List improvised content
- `review_improvisation(content_id)` - Get detailed view of improvised content
- `approve_improvisation(content_id)` - Mark improvised content as accepted canon
- `reject_improvisation(content_id, reason)` - Flag problematic improvisation
- `get_session_improvisation_summary(session)` - Summary of session's improvisation

## Dependencies

- Task 46: Fact Database Schema (stores tagged facts)
- Task 50: Improvisation Level System (provides level context for tags)

## Effort Estimate

- **Size:** S
- **Estimated Hours:** 4
- **Complexity:** Low-Medium - clear requirements, extends existing systems

## Definition of Done

1. All narrative outputs correctly tagged with origin
2. Tags properly stored in fact database
3. Query interface working for all filter combinations
4. Session notes display improvisation markers
5. MCP tools functional for content review
6. Classification confidence scores reasonable
7. All code passes linting and type checking
8. Unit tests written and passing (>90% coverage)
9. Documentation includes tagging schema reference
