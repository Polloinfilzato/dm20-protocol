---
name: NPC Knowledge State Tracking
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-07T00:05:06Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/45
depends_on: [47]
parallel: false
conflicts_with: []
---

# NPC Knowledge State Tracking

## Description

Implement a system to track what each NPC knows and doesn't know within the campaign. This enables realistic NPC dialogue where characters only reference information they could plausibly know, maintains immersion by preventing NPCs from revealing information they shouldn't have, and tracks NPC memory of player interactions over time.

## Acceptance Criteria

- [ ] Implement `NPCKnowledgeTracker` class
- [ ] Track what each NPC knows (facts they are aware of)
- [ ] Track what each NPC doesn't know (facts hidden from them)
- [ ] Update NPC knowledge when players reveal information
- [ ] Query NPC knowledge state for dialogue generation
- [ ] Track NPC memory of player interactions (meetings, conversations)
- [ ] Support knowledge propagation (NPC A tells NPC B)
- [ ] Integrate with existing NPC data structure
- [ ] Persist NPC knowledge state per campaign
- [ ] Create unit tests for knowledge tracking operations

## Technical Details

### File Structure

```
src/gamemaster_mcp/claudmaster/
├── consistency/
│   ├── __init__.py
│   ├── fact_database.py
│   ├── npc_knowledge.py    # NPCKnowledgeTracker class
│   └── models.py
```

### Knowledge Entry Model

```python
from dataclasses import dataclass, field
from datetime import datetime
from typing import Optional
from enum import Enum

class KnowledgeSource(Enum):
    WITNESSED = "witnessed"       # NPC saw it happen
    TOLD_BY_PLAYER = "told_by_player"
    TOLD_BY_NPC = "told_by_npc"
    COMMON_KNOWLEDGE = "common_knowledge"
    PROFESSION = "profession"     # Knows due to their job/role
    RUMOR = "rumor"

@dataclass
class KnowledgeEntry:
    fact_id: str
    source: KnowledgeSource
    acquired_session: int
    acquired_timestamp: datetime
    confidence: float = 1.0  # 1.0 = certain, 0.5 = heard rumor
    source_entity: Optional[str] = None  # Who told them

@dataclass
class PlayerInteraction:
    session_number: int
    timestamp: datetime
    interaction_type: str  # "conversation", "combat", "trade", etc.
    summary: str
    player_characters: list[str]
    location: str
```

### NPCKnowledgeTracker Class

```python
class NPCKnowledgeTracker:
    """Tracks what each NPC knows and their interactions with players."""

    def __init__(self, fact_database: FactDatabase, campaign_path: Path):
        """Initialize with reference to fact database."""

    def get_npc_knowledge(self, npc_id: str) -> list[KnowledgeEntry]:
        """Get all facts an NPC knows."""

    def npc_knows_fact(self, npc_id: str, fact_id: str) -> bool:
        """Check if NPC knows a specific fact."""

    def add_knowledge(
        self,
        npc_id: str,
        fact_id: str,
        source: KnowledgeSource,
        session: int,
        confidence: float = 1.0,
        source_entity: Optional[str] = None
    ) -> None:
        """Add knowledge to an NPC's knowledge state."""

    def reveal_to_npc(
        self,
        npc_id: str,
        fact_id: str,
        revealed_by: str,
        session: int
    ) -> None:
        """Record that information was revealed to an NPC."""

    def propagate_knowledge(
        self,
        from_npc: str,
        to_npc: str,
        fact_ids: list[str],
        session: int
    ) -> None:
        """Transfer knowledge from one NPC to another."""

    def record_interaction(
        self,
        npc_id: str,
        interaction: PlayerInteraction
    ) -> None:
        """Record a player-NPC interaction."""

    def get_interactions(
        self,
        npc_id: str,
        session: Optional[int] = None
    ) -> list[PlayerInteraction]:
        """Get NPC's interaction history with players."""

    def query_npcs_who_know(self, fact_id: str) -> list[str]:
        """Find all NPCs who know a specific fact."""

    def get_knowledge_context(self, npc_id: str) -> dict:
        """Get full knowledge context for dialogue generation."""

    def save(self) -> None:
        """Persist NPC knowledge state."""

    def load(self) -> None:
        """Load NPC knowledge state."""
```

### Storage Format (npc_knowledge.json)

```json
{
  "version": "1.0",
  "campaign_id": "shadows-over-eldoria",
  "npc_knowledge": {
    "npc_blacksmith_thorin": {
      "known_facts": [
        {
          "fact_id": "fact_001",
          "source": "witnessed",
          "acquired_session": 3,
          "acquired_timestamp": "2026-02-05T19:00:00Z",
          "confidence": 1.0,
          "source_entity": null
        }
      ],
      "interactions": [
        {
          "session_number": 2,
          "timestamp": "2026-02-04T20:30:00Z",
          "interaction_type": "trade",
          "summary": "Sold a longsword to Ragnar",
          "player_characters": ["Ragnar"],
          "location": "Thorin's Forge"
        }
      ]
    }
  },
  "metadata": {
    "last_updated": "2026-02-05T19:06:45Z"
  }
}
```

## Dependencies

- Task 46: Fact Tracker System (required for fact references)

## Effort Estimate

- **Size:** M
- **Estimated Hours:** 6
- **Complexity:** Medium - knowledge graph modeling with NPC integration

## Definition of Done

1. NPCKnowledgeTracker class fully implemented
2. Knowledge addition and querying working correctly
3. Player reveal tracking functional
4. Knowledge propagation between NPCs working
5. Interaction history tracking complete
6. Integration with FactDatabase verified
7. All code passes linting and type checking
8. Unit tests written and passing (>90% coverage)
9. Documentation/docstrings complete
10. NPC knowledge state properly persisted and loaded
