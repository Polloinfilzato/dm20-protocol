---
name: Player Action Interpretation
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-05T19:21:30Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/41
depends_on: [34, 43]
parallel: false
conflicts_with: []
---

# Player Action Interpretation

## Description

Implement a natural language action parsing system that interprets player input and classifies their intent. This system validates proposed actions against the current game state and handles ambiguous or impossible actions gracefully, providing clear feedback to help players refine their intentions.

## Acceptance Criteria

- [ ] Parse natural language player input into structured actions
- [ ] Classify action intent (combat, exploration, social, magic, etc.)
- [ ] Validate actions against current game state
- [ ] Handle ambiguous actions with clarifying questions
- [ ] Detect impossible/invalid actions and explain why
- [ ] Support compound actions (e.g., "move and attack")
- [ ] Handle out-of-character requests vs. in-character actions
- [ ] Create comprehensive unit tests
- [ ] Add integration tests with game state validation

## Technical Details

### ActionInterpreter Class

```python
class ActionInterpreter:
    """Interprets natural language player actions."""

    def __init__(self, archivist: ArchivistAgent, llm: LLMProvider):
        self.archivist = archivist
        self.llm = llm

    async def interpret(
        self,
        player_input: str,
        character: Character,
        context: GameContext
    ) -> InterpretationResult:
        """Parse and interpret player input."""
        pass

    async def validate(
        self,
        action: ParsedAction,
        game_state: GameState
    ) -> ValidationResult:
        """Validate action against game state."""
        pass

    async def request_clarification(
        self,
        ambiguity: Ambiguity,
        original_input: str
    ) -> ClarificationRequest:
        """Generate clarifying question for ambiguous input."""
        pass
```

### Intent Classification

```python
class ActionIntent(Enum):
    COMBAT_ATTACK = "combat_attack"
    COMBAT_SPELL = "combat_spell"
    COMBAT_ABILITY = "combat_ability"
    COMBAT_MOVEMENT = "combat_movement"
    COMBAT_DEFENSIVE = "combat_defensive"
    EXPLORATION_MOVEMENT = "exploration_movement"
    EXPLORATION_SEARCH = "exploration_search"
    EXPLORATION_INTERACT = "exploration_interact"
    SOCIAL_DIALOGUE = "social_dialogue"
    SOCIAL_PERSUADE = "social_persuade"
    SOCIAL_INTIMIDATE = "social_intimidate"
    SOCIAL_DECEIVE = "social_deceive"
    MAGIC_CAST = "magic_cast"
    MAGIC_RITUAL = "magic_ritual"
    ITEM_USE = "item_use"
    ITEM_EQUIP = "item_equip"
    REST_SHORT = "rest_short"
    REST_LONG = "rest_long"
    META_OOC = "meta_ooc"  # Out of character
    META_QUESTION = "meta_question"  # Rules question
    UNKNOWN = "unknown"
```

### ParsedAction Dataclass

```python
@dataclass
class ParsedAction:
    intent: ActionIntent
    actor: str  # Character performing action
    targets: list[str]  # Targets of action
    method: Optional[str]  # Weapon, spell, or ability used
    modifiers: list[str]  # Advantage, stealth, etc.
    movement: Optional[MovementInfo]
    raw_input: str
    confidence: float  # 0.0 to 1.0
```

### ValidationResult Dataclass

```python
@dataclass
class ValidationResult:
    is_valid: bool
    action: ParsedAction
    issues: list[ValidationIssue]
    suggestions: list[str]  # Alternative valid actions
    resources_required: ResourceRequirements
    can_attempt_with_penalty: bool  # e.g., attack without proficiency
```

### Ambiguity Handling

```python
@dataclass
class Ambiguity:
    type: AmbiguityType  # TARGET, METHOD, INTENT, LOCATION
    options: list[str]
    context_hint: str

class AmbiguityType(Enum):
    TARGET = "target"  # "I attack" - attack what?
    METHOD = "method"  # "I attack the goblin" - with what?
    INTENT = "intent"  # "I go to the door" - open, examine, listen?
    LOCATION = "location"  # "I search" - search where?
    QUANTITY = "quantity"  # "I drink a potion" - which one?
```

### Validation Rules

Check against game state:
- Character has required resources (spell slots, items, etc.)
- Target is valid and reachable
- Action is possible given conditions (not paralyzed, etc.)
- Action timing is valid (in combat vs. out of combat)
- Equipment is available and equipped

### Compound Action Parsing

Handle complex inputs like:
- "I move behind the pillar and shoot the goblin with my crossbow"
- "I cast shield as a reaction when the orc attacks me"
- "I want to intimidate the guard while my rogue picks the lock"

## Dependencies

- Task 33: LLM Integration Layer
- Task 42: Archivist Agent Implementation

## Effort Estimate

- **Size:** M
- **Estimated Hours:** 8
- **Complexity:** Medium-High - NLP parsing with game rule validation

## Definition of Done

1. ActionInterpreter class fully implemented
2. Intent classification working accurately
3. Game state validation functional
4. Ambiguity handling with clear questions
5. Compound action parsing working
6. All unit tests passing
7. Integration tests with real game states passing
8. Edge cases handled gracefully
9. Documentation complete with examples
10. Code reviewed and approved
