---
name: Campaign Module Binding
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-07T00:05:06Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/38
depends_on: [38, 40]
parallel: false
conflicts_with: []
---

# Campaign Module Binding

## Description

Extend the campaign system to support binding adventure modules to campaigns. This includes tracking which module is active for a campaign, storing module progression state (current chapter, visited locations, completed encounters), and providing functions to bind/unbind modules from campaigns.

## Acceptance Criteria

- [ ] Extend `campaign.json` schema with module binding fields
- [ ] Implement `bind_module_to_campaign` function
- [ ] Implement `unbind_module_from_campaign` function
- [ ] Track current chapter/location in campaign state
- [ ] Track visited locations list
- [ ] Track completed encounters list
- [ ] Track revealed NPCs and their known information
- [ ] Support multiple modules per campaign (one active at a time)
- [ ] Add MCP tool `bind_adventure_module` for binding
- [ ] Add MCP tool `get_module_progress` for progress query
- [ ] Add unit tests for binding and state tracking
- [ ] Include docstrings for all public methods

## Technical Details

### Campaign Schema Extension

```json
{
  "name": "Curse of Strahd Campaign",
  "description": "...",
  "characters": [...],
  "npcs": [...],

  "module_binding": {
    "active_module_id": "curse-of-strahd",
    "bound_modules": [
      {
        "module_id": "curse-of-strahd",
        "bound_at": "2026-02-05T19:06:45Z",
        "source_id": "cos-pdf"
      }
    ]
  },

  "module_progress": {
    "curse-of-strahd": {
      "current_chapter": "Chapter 4: Castle Ravenloft",
      "current_location": "K1. Front Courtyard",
      "visited_locations": [
        "Village of Barovia",
        "Blood on the Vine Tavern",
        "K1. Front Courtyard"
      ],
      "completed_encounters": [
        "death-house-shambling-mound",
        "village-barovia-strahd-appearance"
      ],
      "revealed_npcs": {
        "Strahd": ["is a vampire", "rules Barovia", "seeks Ireena"],
        "Ireena": ["looks like Tatyana", "is being hunted"]
      },
      "key_items_found": ["Sunsword hilt", "Holy Symbol of Ravenkind"],
      "plot_flags": {
        "strahd_first_meeting": true,
        "ally_identified": false,
        "fortunes_read": true
      },
      "last_updated": "2026-02-05T19:06:45Z"
    }
  }
}
```

### Module Binding Functions

```python
# In src/gamemaster_mcp/claudmaster/module_binding.py

from typing import Optional, List, Dict
from ..models import Campaign

async def bind_module_to_campaign(
    campaign: Campaign,
    module_id: str,
    source_id: str,
    set_active: bool = True
) -> BindingResult:
    """
    Bind an adventure module to a campaign.

    Args:
        campaign: Target campaign
        module_id: Module identifier (e.g., "curse-of-strahd")
        source_id: Library source ID for the PDF
        set_active: Whether to set as active module

    Returns:
        BindingResult with success status and details
    """
    pass

async def unbind_module_from_campaign(
    campaign: Campaign,
    module_id: str,
    preserve_progress: bool = True
) -> UnbindingResult:
    """
    Unbind a module from campaign, optionally preserving progress.
    """
    pass

async def set_active_module(
    campaign: Campaign,
    module_id: str
) -> None:
    """Set which bound module is currently active."""
    pass

async def update_module_progress(
    campaign: Campaign,
    module_id: str,
    chapter: Optional[str] = None,
    location: Optional[str] = None,
    completed_encounter: Optional[str] = None,
    revealed_npc_info: Optional[Dict[str, str]] = None,
    found_item: Optional[str] = None,
    plot_flag: Optional[Dict[str, bool]] = None
) -> ModuleProgress:
    """Update progress tracking for a bound module."""
    pass

async def get_module_progress(
    campaign: Campaign,
    module_id: Optional[str] = None  # None = active module
) -> ModuleProgress:
    """Get current progress for a module."""
    pass
```

### MCP Tools

```python
# bind_adventure_module tool
@mcp_tool
async def bind_adventure_module(
    module_source_id: str,
    module_name: Optional[str] = None
) -> str:
    """
    Bind an adventure module to the current campaign.

    Args:
        module_source_id: Library source ID of the module PDF
        module_name: Optional display name for the module

    Returns:
        Confirmation message with binding details
    """
    pass

# get_module_progress tool
@mcp_tool
async def get_module_progress() -> str:
    """
    Get current progress in the active adventure module.

    Returns:
        Formatted progress report including chapter, location,
        completed encounters, and revealed information.
    """
    pass
```

### Data Models

```python
@dataclass
class ModuleBinding:
    """Binding between campaign and module."""
    module_id: str
    source_id: str
    bound_at: datetime
    is_active: bool = False

@dataclass
class ModuleProgress:
    """Progress state for a bound module."""
    module_id: str
    current_chapter: Optional[str] = None
    current_location: Optional[str] = None
    visited_locations: List[str] = field(default_factory=list)
    completed_encounters: List[str] = field(default_factory=list)
    revealed_npcs: Dict[str, List[str]] = field(default_factory=dict)
    key_items_found: List[str] = field(default_factory=list)
    plot_flags: Dict[str, bool] = field(default_factory=dict)
    last_updated: datetime = field(default_factory=datetime.now)

@dataclass
class BindingResult:
    """Result of binding operation."""
    success: bool
    module_id: str
    message: str
    indexed: bool = False  # Whether module was auto-indexed
```

## Dependencies

- Task #37 (Adventure Module Parser) - module structure
- Task #39 (Module Keeper Agent) - uses binding for context

## Effort Estimate

- **Size:** S
- **Estimated Hours:** 4
- **Complexity:** Low - schema extension and state management

## Definition of Done

1. Campaign schema extended with module_binding and module_progress
2. bind_module_to_campaign function working
3. unbind_module_from_campaign function working
4. Progress tracking (chapter, location, encounters) working
5. Revealed NPC information tracked correctly
6. Plot flags system working
7. MCP tools registered and functional
8. Backward compatible with campaigns without modules
9. All unit tests passing
10. Code passes linting and type checking
11. Documentation complete
