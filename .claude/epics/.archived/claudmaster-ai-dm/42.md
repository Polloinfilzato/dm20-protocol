---
name: Enhanced Narrator with NPC Dialogue
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-07T00:26:06Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/39
depends_on: [35, 40]
parallel: false
conflicts_with: []
---

# Enhanced Narrator with NPC Dialogue

## Description

Extend the NarratorAgent with dialogue generation capabilities that integrate NPC personalities from the module system. This enhancement enables the narrator to generate contextually appropriate dialogue for NPCs based on their defined traits, supporting multiple NPCs in a single scene with distinct voices and tones.

## Acceptance Criteria

- [ ] Extend NarratorAgent class with dialogue generation methods
- [ ] Integrate NPC personality data from module system
- [ ] Generate dialogue tone based on NPC traits (friendly, hostile, nervous, etc.)
- [ ] Support multiple NPCs in a single scene with distinct voices
- [ ] Handle NPC-to-NPC dialogue exchanges
- [ ] Maintain NPC voice consistency across sessions
- [ ] Provide dialogue formatting options (inline vs. block quotes)
- [ ] Create unit tests for dialogue generation
- [ ] Add integration tests with module NPC data

## Technical Details

### NarratorAgent Extension

```python
class NarratorAgent(Agent):
    """Extended narrator with dialogue capabilities."""

    async def generate_dialogue(
        self,
        npc: NPC,
        context: DialogueContext,
        tone_override: Optional[str] = None
    ) -> DialogueLine:
        """Generate a single line of dialogue for an NPC."""
        pass

    async def generate_conversation(
        self,
        participants: list[NPC | Character],
        scene_context: SceneContext,
        topic: str
    ) -> Conversation:
        """Generate a multi-party conversation."""
        pass

    def get_npc_voice_profile(self, npc: NPC) -> VoiceProfile:
        """Extract voice characteristics from NPC data."""
        pass
```

### DialogueContext Dataclass

```python
@dataclass
class DialogueContext:
    speaker: NPC
    listeners: list[NPC | Character]
    location: Location
    current_mood: str
    relationship_to_party: str  # friendly, neutral, hostile
    recent_events: list[str]
    conversation_history: list[DialogueLine]
```

### VoiceProfile Dataclass

```python
@dataclass
class VoiceProfile:
    speech_pattern: str  # formal, casual, archaic, etc.
    vocabulary_level: str  # simple, educated, scholarly
    accent_hints: str  # regional speech patterns
    quirks: list[str]  # catchphrases, verbal tics
    emotional_baseline: str  # calm, excitable, melancholic
```

### Dialogue Tone Mapping

Map NPC traits to dialogue characteristics:
- `friendly` + `merchant` → helpful, sales-oriented speech
- `hostile` + `guard` → threatening, authoritative
- `nervous` + `commoner` → stuttering, evasive
- `wise` + `sage` → measured, metaphorical

### Multi-NPC Scene Handling

- Track which NPC is currently speaking
- Maintain separate voice profiles per NPC
- Handle interruptions and reactions
- Support group dynamics (leader speaks first, etc.)

## Dependencies

- Task 34: Narrative Engine Architecture
- Task 39: Module Response Integration

## Effort Estimate

- **Size:** L
- **Estimated Hours:** 10
- **Complexity:** High - requires natural language generation with personality modeling

## Definition of Done

1. NarratorAgent extended with all dialogue methods
2. NPC personality integration complete and tested
3. Multiple NPC scenes generate distinct voices
4. Dialogue tone correctly reflects NPC traits
5. Voice consistency maintained across conversation
6. All unit tests passing
7. Integration tests with module data passing
8. Documentation complete with examples
9. Code reviewed and approved
