---
name: Companion NPC Profiles
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-07T01:07:41Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/52
depends_on: [34]
parallel: true
conflicts_with: []
---

# Companion NPC Profiles

## Description

Implement a CompanionProfile system that extends the existing NPC framework to support AI-controlled companion characters. Companions have distinct personalities, combat styles, and loyalty mechanics that influence their behavior during gameplay. This task establishes the foundation for the Companion System by defining how companions are created, configured, and managed.

## Acceptance Criteria

- [ ] Implement `CompanionProfile` dataclass with personality, combat style, and loyalty attributes
- [ ] Define pre-built archetype templates (Tank, Healer, Striker, Support)
- [ ] Implement custom companion creation from existing NPCs
- [ ] Integrate with existing NPC stat system for combat values
- [ ] Add loyalty tracking mechanics (affects behavior thresholds)
- [ ] Create companion persistence (save/load with campaign)
- [ ] Write comprehensive unit tests
- [ ] Document companion profile schema

## Technical Details

### CompanionProfile Dataclass

```python
from dataclasses import dataclass, field
from enum import Enum
from typing import Optional

class CombatStyle(Enum):
    AGGRESSIVE = "aggressive"      # Prioritizes damage
    DEFENSIVE = "defensive"        # Prioritizes protection
    SUPPORTIVE = "supportive"      # Prioritizes healing/buffs
    BALANCED = "balanced"          # Adapts to situation

class CompanionArchetype(Enum):
    TANK = "tank"           # High HP, defensive abilities, draws aggro
    HEALER = "healer"       # Healing spells, support abilities
    STRIKER = "striker"     # High damage, mobility
    SUPPORT = "support"     # Buffs, debuffs, utility

@dataclass
class PersonalityTraits:
    bravery: int = 50        # 0-100: cowardly to fearless
    loyalty: int = 50        # 0-100: self-serving to devoted
    aggression: int = 50     # 0-100: pacifist to bloodthirsty
    caution: int = 50        # 0-100: reckless to careful
    compassion: int = 50     # 0-100: cold to empathetic

@dataclass
class CompanionProfile:
    """Extended profile for AI-controlled companion NPCs."""

    npc_id: str                                    # Reference to base NPC
    archetype: CompanionArchetype
    combat_style: CombatStyle
    personality: PersonalityTraits = field(default_factory=PersonalityTraits)
    loyalty_score: int = 50                        # Current loyalty (0-100)
    max_loyalty: int = 100
    active: bool = True                            # Currently in party

    # Behavioral preferences
    preferred_targets: list[str] = field(default_factory=list)
    avoided_targets: list[str] = field(default_factory=list)
    preferred_abilities: list[str] = field(default_factory=list)
```

### Archetype Templates

Pre-defined templates for quick companion creation:

```python
ARCHETYPE_TEMPLATES = {
    CompanionArchetype.TANK: {
        "combat_style": CombatStyle.DEFENSIVE,
        "personality": PersonalityTraits(bravery=80, aggression=40, caution=30),
        "preferred_abilities": ["shield", "taunt", "protect"],
    },
    CompanionArchetype.HEALER: {
        "combat_style": CombatStyle.SUPPORTIVE,
        "personality": PersonalityTraits(compassion=90, caution=70, aggression=20),
        "preferred_abilities": ["heal", "cure", "bless"],
    },
    # ... etc
}
```

### NPC Integration

- Extend existing `NPC` model to optionally link to `CompanionProfile`
- Use NPC stats (AC, HP, abilities) for combat calculations
- Companion-specific data stored separately, linked by `npc_id`

### Loyalty Mechanics

- Loyalty affects willingness to follow dangerous orders
- Low loyalty may cause companion to refuse certain actions
- Loyalty changes based on player treatment and events

## Dependencies

- Task #33: Orchestrator Skeleton
  - Requires base agent infrastructure for companion AI integration
  - Uses campaign context management

## Effort Estimate

- **Size:** M
- **Estimated Hours:** 6
- **Complexity:** Medium - data modeling with integration points

## Definition of Done

1. CompanionProfile dataclass fully implemented
2. All four archetype templates defined and tested
3. Custom companion creation from NPC working
4. NPC stat integration verified
5. Loyalty mechanics implemented
6. Campaign persistence working (save/load)
7. Unit tests written and passing
8. Documentation complete
9. Code reviewed and approved
