---
name: Error Handling and Recovery
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-07T10:45:16Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/64
depends_on: [34, 65]
parallel: true
conflicts_with: []
---

# Error Handling and Recovery

## Description

Implement comprehensive error handling and recovery mechanisms for the Claudmaster system. This includes agent failure recovery, graceful degradation when components fail, state rollback on errors, user-friendly error messaging, and crash recovery to restore sessions after unexpected termination.

## Acceptance Criteria

- [ ] Implement agent failure detection and recovery
- [ ] Create graceful degradation system for partial failures
- [ ] Implement state rollback on critical errors
- [ ] Design user-friendly error message system
- [ ] Implement crash recovery mechanism
- [ ] Create error logging and diagnostics
- [ ] Support retry logic for transient failures
- [ ] Handle timeout scenarios gracefully
- [ ] Preserve game state integrity during errors
- [ ] Add comprehensive error handling tests

## Technical Details

### Error Categories

```python
class ClaudmasterError(Exception):
    """Base exception for Claudmaster errors."""
    pass

class AgentError(ClaudmasterError):
    """Agent-specific failures."""
    agent_name: str
    recoverable: bool

class StateError(ClaudmasterError):
    """Game state corruption or inconsistency."""
    pass

class SessionError(ClaudmasterError):
    """Session management errors."""
    pass

class TimeoutError(ClaudmasterError):
    """Operation timeout."""
    operation: str
    timeout_seconds: float
```

### Agent Failure Recovery

```python
class AgentRecoveryManager:
    """Handles agent failures and recovery strategies."""

    def __init__(self, orchestrator: Orchestrator):
        self.orchestrator = orchestrator
        self.failure_counts: dict[str, int] = {}
        self.max_retries = 3

    async def handle_agent_failure(
        self,
        agent_name: str,
        error: Exception,
        context: AgentRequest
    ) -> RecoveryResult:
        """
        Handle an agent failure with appropriate recovery strategy.

        Strategies:
        1. Retry with exponential backoff
        2. Fallback to alternative agent
        3. Graceful degradation
        4. User intervention request
        """

    async def retry_with_backoff(
        self,
        agent: Agent,
        request: AgentRequest,
        attempt: int
    ) -> Optional[AgentResponse]:
        """Retry agent call with exponential backoff."""

    def get_fallback_agent(self, failed_agent: str) -> Optional[Agent]:
        """Find alternative agent for failed component."""
```

### Graceful Degradation

```python
class DegradationManager:
    """Manages system degradation when components fail."""

    # Degradation levels
    FULL = "full"           # All systems operational
    REDUCED = "reduced"     # Some agents unavailable
    MINIMAL = "minimal"     # Core functionality only
    EMERGENCY = "emergency" # Save and exit only

    def __init__(self, session: ClaudmasterSession):
        self.session = session
        self.level = self.FULL
        self.unavailable_features: list[str] = []

    def degrade_to(self, level: str, reason: str) -> None:
        """Lower operational level due to failure."""

    def get_available_actions(self) -> list[str]:
        """Return actions available at current degradation level."""

    def notify_user(self) -> str:
        """Generate user-friendly degradation notice."""
```

### State Rollback

```python
class StateRollbackManager:
    """Manages state snapshots and rollback on errors."""

    def __init__(self, session: ClaudmasterSession):
        self.session = session
        self.snapshots: list[StateSnapshot] = []
        self.max_snapshots = 10

    def create_snapshot(self, label: str = "auto") -> str:
        """Create state snapshot before risky operation."""

    def rollback_to(self, snapshot_id: str) -> bool:
        """Restore state to specific snapshot."""

    def rollback_last(self) -> bool:
        """Restore to most recent snapshot."""

    def clear_old_snapshots(self) -> None:
        """Remove snapshots beyond retention limit."""
```

### User-Friendly Error Messages

```python
class ErrorMessageFormatter:
    """Converts technical errors to user-friendly messages."""

    ERROR_MESSAGES = {
        "agent_timeout": (
            "I'm taking a moment to think... "
            "If this continues, try rephrasing your action."
        ),
        "agent_failure": (
            "Something went wrong while processing that. "
            "Let's try a different approach - what would you like to do?"
        ),
        "state_corruption": (
            "I noticed some inconsistency in the game state. "
            "I've restored to the last good checkpoint. "
            "What was your last action?"
        ),
        # ... more messages
    }

    def format_error(
        self,
        error: ClaudmasterError,
        context: Optional[str] = None
    ) -> str:
        """Convert error to player-friendly message."""

    def suggest_recovery_action(self, error: ClaudmasterError) -> str:
        """Suggest what the player can do next."""
```

### Crash Recovery

```python
class CrashRecoveryManager:
    """Handles recovery from unexpected termination."""

    def __init__(self, campaign_path: Path):
        self.campaign_path = campaign_path
        self.recovery_file = campaign_path / ".claudmaster_recovery"

    def write_recovery_marker(self, session: ClaudmasterSession) -> None:
        """Write marker file during active session."""

    def check_for_crash(self) -> Optional[str]:
        """Check if previous session crashed."""

    async def recover_session(self, session_id: str) -> RecoveryResult:
        """Attempt to recover crashed session."""

    def clean_recovery_marker(self) -> None:
        """Remove recovery marker on clean shutdown."""
```

### Error Handling Flow

1. **Detection**: Error occurs during operation
2. **Classification**: Determine error type and severity
3. **Snapshot**: Preserve current state if not already done
4. **Recovery Attempt**: Try appropriate recovery strategy
5. **Degradation**: Reduce functionality if recovery fails
6. **User Notification**: Inform user in friendly terms
7. **Logging**: Record error details for diagnostics

### File Structure

```
src/gamemaster_mcp/claudmaster/
├── recovery/
│   ├── __init__.py
│   ├── agent_recovery.py      # AgentRecoveryManager
│   ├── degradation.py         # DegradationManager
│   ├── rollback.py            # StateRollbackManager
│   ├── crash_recovery.py      # CrashRecoveryManager
│   └── error_messages.py      # ErrorMessageFormatter
├── exceptions.py              # Custom exceptions
```

## Dependencies

- Task #33: Orchestrator Skeleton (for agent management)
- Task #64: end_session and get_session_state MCP Tools (for state persistence)

## Effort Estimate

- **Size:** M
- **Estimated Hours:** 8
- **Complexity:** Medium-High - multiple recovery strategies and state management

## Definition of Done

1. Agent failure detection working correctly
2. Retry logic with backoff implemented
3. Graceful degradation system functional
4. State rollback mechanism working
5. Crash recovery detecting and recovering sessions
6. User-friendly error messages for all error types
7. Error logging comprehensive and useful
8. All error paths tested
9. Integration with Orchestrator complete
10. Unit tests for all recovery managers
11. Integration tests simulating various failure modes
12. Documentation for error handling behavior
