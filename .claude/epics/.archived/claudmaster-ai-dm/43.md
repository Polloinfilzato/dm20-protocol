---
name: Archivist Agent Implementation
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-06T23:23:27Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/40
depends_on: [33, 34]
parallel: true
conflicts_with: []
---

# Archivist Agent Implementation

## Description

Implement the ArchivistAgent class responsible for querying and tracking game state information. This agent serves as the knowledge keeper for the AI DM system, providing accurate information about character stats, inventory, conditions, rules, and combat state when other agents need to make informed decisions.

## Acceptance Criteria

- [ ] Implement ArchivistAgent class extending base Agent
- [ ] Query existing game state (HP, inventory, conditions, position)
- [ ] Integrate with rulebook system for rules lookup
- [ ] Track and report combat state (initiative, turns, conditions)
- [ ] Provide character sheet data on demand
- [ ] Cache frequently accessed data for performance
- [ ] Handle concurrent queries safely
- [ ] Create comprehensive unit tests
- [ ] Add integration tests with campaign data

## Technical Details

### ArchivistAgent Class

```python
class ArchivistAgent(Agent):
    """Agent responsible for game state knowledge and rules lookup."""

    def __init__(self, campaign: Campaign, rulebooks: list[Rulebook]):
        self.campaign = campaign
        self.rulebooks = rulebooks
        self._cache = StateCache()

    async def reason(self, context: dict) -> str:
        """Determine what information is needed."""
        pass

    async def act(self, reasoning: str) -> QueryResult:
        """Execute the information retrieval."""
        pass

    async def observe(self, result: QueryResult) -> dict:
        """Format and validate the retrieved information."""
        pass
```

### Query Methods

```python
class ArchivistAgent(Agent):
    # Character queries
    async def get_character_stats(self, name_or_id: str) -> CharacterStats:
        """Get full character statistics."""
        pass

    async def get_character_hp(self, name_or_id: str) -> HPStatus:
        """Get current HP, max HP, temp HP."""
        pass

    async def get_inventory(self, name_or_id: str) -> Inventory:
        """Get character inventory with item details."""
        pass

    async def get_conditions(self, name_or_id: str) -> list[Condition]:
        """Get active conditions and their effects."""
        pass

    # Combat queries
    async def get_combat_state(self) -> CombatState:
        """Get current combat status if in combat."""
        pass

    async def get_initiative_order(self) -> list[InitiativeEntry]:
        """Get current initiative order."""
        pass

    async def get_available_actions(self, name_or_id: str) -> list[Action]:
        """Get available actions for a combatant."""
        pass

    # Rules queries
    async def lookup_rule(self, query: str) -> RuleResult:
        """Search rulebooks for relevant rules."""
        pass

    async def get_spell_info(self, spell_name: str) -> SpellInfo:
        """Get spell details from rulebooks."""
        pass

    async def get_monster_info(self, monster_name: str) -> MonsterInfo:
        """Get monster stat block."""
        pass
```

### StateCache Class

```python
@dataclass
class StateCache:
    """Cache for frequently accessed game state."""

    character_cache: dict[str, tuple[CharacterStats, datetime]]
    combat_cache: Optional[tuple[CombatState, datetime]]
    rule_cache: dict[str, tuple[RuleResult, datetime]]
    cache_ttl: timedelta = timedelta(seconds=30)

    def get_or_fetch(self, key: str, fetcher: Callable) -> Any:
        """Get from cache or fetch and cache."""
        pass

    def invalidate(self, pattern: str = "*"):
        """Invalidate cache entries matching pattern."""
        pass
```

### Query Result Types

```python
@dataclass
class CharacterStats:
    name: str
    race: str
    character_class: str
    level: int
    ability_scores: dict[str, int]
    hp_current: int
    hp_max: int
    hp_temp: int
    armor_class: int
    speed: int
    conditions: list[str]

@dataclass
class CombatState:
    is_active: bool
    round_number: int
    current_turn: str  # character/npc name
    initiative_order: list[InitiativeEntry]
    conditions_in_effect: dict[str, list[Condition]]
```

### Integration Points

- Campaign data access via existing MCP tools
- Rulebook search via `search_rules` and related tools
- Combat state via `get_game_state` and combat tools
- Character data via `get_character` tool

## Dependencies

- Task 32: Directory Structure and Base Classes
- Task 33: LLM Integration Layer

## Effort Estimate

- **Size:** L
- **Estimated Hours:** 10
- **Complexity:** High - requires integration with multiple existing systems

## Definition of Done

1. ArchivistAgent class fully implemented
2. All query methods working correctly
3. Rulebook integration functional
4. Combat state tracking accurate
5. Cache system working with proper invalidation
6. Thread-safe for concurrent queries
7. All unit tests passing
8. Integration tests with real campaign data passing
9. Documentation complete
10. Code reviewed and approved
