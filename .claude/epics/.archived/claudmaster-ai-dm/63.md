---
name: start_claudmaster_session MCP Tool
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-07T09:23:03Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/60
depends_on: [34, 36, 41]
parallel: true
conflicts_with: []
---

# start_claudmaster_session MCP Tool

## Description

Implement the `start_claudmaster_session` MCP tool that serves as the main entry point for AI DM sessions. This tool initializes the Claudmaster system by loading the campaign, module configuration, and all required agents. It supports both starting new sessions and resuming existing ones, returning the complete session state to the client.

## Acceptance Criteria

- [ ] Implement `start_claudmaster_session` MCP tool function
- [ ] Support starting a new session for a campaign
- [ ] Support resuming an existing paused/saved session
- [ ] Load campaign data using existing campaign system
- [ ] Load and validate module configuration
- [ ] Initialize Orchestrator with all registered agents
- [ ] Initialize Context Window Manager
- [ ] Load any existing session state (facts, context, history)
- [ ] Return comprehensive session state to client
- [ ] Handle errors gracefully (missing campaign, invalid config, etc.)
- [ ] Add unit and integration tests

## Technical Details

### MCP Tool Definition

```python
@tool
async def start_claudmaster_session(
    campaign_name: str,
    module_id: Optional[str] = None,
    session_id: Optional[str] = None,
    resume: bool = False
) -> dict:
    """
    Start or resume a Claudmaster AI DM session.

    Args:
        campaign_name: Name of the campaign to load
        module_id: Optional module to use (defaults to campaign's active module)
        session_id: Optional session ID to resume (required if resume=True)
        resume: Whether to resume an existing session

    Returns:
        Session state including:
        - session_id: Unique identifier for this session
        - campaign_info: Basic campaign information
        - module_info: Active module details
        - game_state: Current game state
        - party_info: Character summaries
        - last_events: Recent narrative events (for context)
        - status: Session status (active, paused, etc.)
    """
```

### Session Initialization Flow

1. **Validate Inputs**
   - Check campaign exists
   - If resume=True, verify session_id provided and session exists
   - Validate module_id if provided

2. **Load Campaign**
   - Use existing `load_campaign` functionality
   - Get game state, characters, NPCs, locations

3. **Load Module Configuration**
   - Load `claudmaster_config.yaml` from module
   - Parse and validate configuration
   - Set up module-specific parameters

4. **Initialize Agents**
   - Create agent instances based on config
   - Register all agents with Orchestrator
   - Initialize Context Window Manager with context budget

5. **Restore Session State (if resuming)**
   - Load saved session state
   - Restore fact database
   - Load conversation history
   - Reconstruct context

6. **Generate Initial State Response**
   - Compile session information
   - Include last N events for context
   - Return formatted response

### Response Schema

```python
@dataclass
class SessionState:
    session_id: str
    status: str  # "active", "paused", "error"
    campaign_info: CampaignSummary
    module_info: ModuleSummary
    game_state: GameStateSummary
    party_info: list[CharacterSummary]
    last_events: list[str]
    context_budget: int
    error_message: Optional[str] = None
```

### File Structure

```
src/gamemaster_mcp/claudmaster/
├── tools/
│   ├── __init__.py
│   └── session_tools.py    # start_claudmaster_session implementation
```

### Error Handling

- Campaign not found → return error state with message
- Module not found → fall back to default config
- Invalid session ID → return error state
- Agent initialization failure → return partial state with warning

## Dependencies

- Task #33: Orchestrator Skeleton (for Orchestrator class)
- Task #35: Module Format Design (for module configuration loading)
- Task #40: Context Window Manager (for context initialization)

## Effort Estimate

- **Size:** M
- **Estimated Hours:** 6
- **Complexity:** Medium - integration of multiple systems

## Definition of Done

1. `start_claudmaster_session` tool implemented and registered
2. New session creation working correctly
3. Session resumption working correctly
4. Campaign loading integrated
5. Module configuration loading integrated
6. All agents properly initialized
7. Context Window Manager initialized
8. Session state correctly returned
9. Error handling complete with user-friendly messages
10. Unit tests written and passing
11. Integration test with mock campaign
12. Tool registered in MCP server
