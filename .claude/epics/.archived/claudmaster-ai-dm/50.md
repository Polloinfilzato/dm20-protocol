---
name: Timeline and Location State Consistency
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-07T01:48:13Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/47
depends_on: [47]
parallel: true
conflicts_with: []
---

# Timeline and Location State Consistency

## Description

Implement a system to track in-game time progression and location state changes throughout the campaign. This ensures temporal consistency (events happen in logical order, travel times make sense) and spatial consistency (doors stay opened, traps remain triggered, loot stays collected), providing a coherent persistent world state.

## Acceptance Criteria

- [ ] Implement `TimelineTracker` class for in-game time progression
- [ ] Implement `LocationStateManager` class for location state changes
- [ ] Track location state changes (doors, traps, loot, environmental changes)
- [ ] Validate temporal consistency of new events
- [ ] Support world state persistence across sessions
- [ ] Calculate travel times between known locations
- [ ] Track day/night cycles and calendar progression
- [ ] Integrate with existing location data structure
- [ ] Create unit tests for timeline and location state operations

## Technical Details

### File Structure

```
src/gamemaster_mcp/claudmaster/
├── consistency/
│   ├── __init__.py
│   ├── fact_database.py
│   ├── npc_knowledge.py
│   ├── contradiction.py
│   ├── timeline.py          # TimelineTracker class
│   └── location_state.py    # LocationStateManager class
```

### Timeline Models

```python
from dataclasses import dataclass, field
from datetime import datetime, timedelta
from typing import Optional
from enum import Enum

class TimeUnit(Enum):
    ROUND = "round"      # 6 seconds
    MINUTE = "minute"
    HOUR = "hour"
    DAY = "day"
    WEEK = "week"
    MONTH = "month"

@dataclass
class GameTime:
    year: int
    month: int
    day: int
    hour: int = 0
    minute: int = 0
    round: int = 0  # For combat tracking

    def advance(self, amount: int, unit: TimeUnit) -> "GameTime":
        """Return new GameTime advanced by specified amount."""

    def to_string(self, format: str = "full") -> str:
        """Format game time for display."""

@dataclass
class TimelineEvent:
    id: str
    game_time: GameTime
    real_session: int
    description: str
    location: Optional[str] = None
    characters_involved: list[str] = field(default_factory=list)
    fact_ids: list[str] = field(default_factory=list)
```

### Location State Models

```python
class StateChangeType(Enum):
    DOOR_OPENED = "door_opened"
    DOOR_LOCKED = "door_locked"
    DOOR_BROKEN = "door_broken"
    TRAP_TRIGGERED = "trap_triggered"
    TRAP_DISARMED = "trap_disarmed"
    LOOT_COLLECTED = "loot_collected"
    ENEMY_DEFEATED = "enemy_defeated"
    OBJECT_MOVED = "object_moved"
    OBJECT_DESTROYED = "object_destroyed"
    ENVIRONMENTAL = "environmental"
    CUSTOM = "custom"

@dataclass
class LocationState:
    location_id: str
    room_id: Optional[str] = None
    state_changes: list["StateChange"] = field(default_factory=list)
    visited: bool = False
    first_visited: Optional[GameTime] = None
    last_visited: Optional[GameTime] = None

@dataclass
class StateChange:
    id: str
    change_type: StateChangeType
    description: str
    game_time: GameTime
    session_number: int
    target_object: Optional[str] = None
    reversible: bool = False
    reverted: bool = False
```

### TimelineTracker Class

```python
class TimelineTracker:
    """Tracks in-game time progression and event timeline."""

    def __init__(self, fact_database: FactDatabase, campaign_path: Path):
        """Initialize with campaign-specific settings."""

    def get_current_time(self) -> GameTime:
        """Get the current in-game time."""

    def advance_time(self, amount: int, unit: TimeUnit) -> GameTime:
        """Advance game time by specified amount."""

    def set_time(self, game_time: GameTime) -> None:
        """Set game time to specific point."""

    def add_event(self, event: TimelineEvent) -> str:
        """Add an event to the timeline."""

    def get_events_at(self, game_time: GameTime) -> list[TimelineEvent]:
        """Get events occurring at a specific time."""

    def get_events_between(
        self,
        start: GameTime,
        end: GameTime
    ) -> list[TimelineEvent]:
        """Get events within a time range."""

    def validate_temporal_order(
        self,
        new_event: TimelineEvent
    ) -> tuple[bool, Optional[str]]:
        """Check if event time is consistent with existing timeline."""

    def calculate_travel_time(
        self,
        from_location: str,
        to_location: str,
        travel_method: str = "walking"
    ) -> timedelta:
        """Calculate travel time between locations."""

    def get_time_of_day(self) -> str:
        """Get descriptive time of day (dawn, morning, etc.)."""

    def save(self) -> None:
        """Persist timeline state."""

    def load(self) -> None:
        """Load timeline state."""
```

### LocationStateManager Class

```python
class LocationStateManager:
    """Manages persistent state changes for locations."""

    def __init__(self, fact_database: FactDatabase, campaign_path: Path):
        """Initialize with campaign-specific storage."""

    def get_location_state(self, location_id: str) -> LocationState:
        """Get current state of a location."""

    def record_state_change(
        self,
        location_id: str,
        change: StateChange
    ) -> None:
        """Record a state change for a location."""

    def is_door_open(
        self,
        location_id: str,
        door_id: str
    ) -> bool:
        """Check if a specific door is open."""

    def is_trap_active(
        self,
        location_id: str,
        trap_id: str
    ) -> bool:
        """Check if a trap is still active."""

    def is_loot_collected(
        self,
        location_id: str,
        loot_id: str
    ) -> bool:
        """Check if loot has been collected."""

    def get_changes_since(
        self,
        location_id: str,
        game_time: GameTime
    ) -> list[StateChange]:
        """Get all changes since a specific time."""

    def revert_change(
        self,
        location_id: str,
        change_id: str
    ) -> bool:
        """Revert a reversible state change."""

    def mark_visited(
        self,
        location_id: str,
        game_time: GameTime
    ) -> None:
        """Mark a location as visited."""

    def get_location_summary(self, location_id: str) -> dict:
        """Get a summary of location state for DM reference."""

    def save(self) -> None:
        """Persist location states."""

    def load(self) -> None:
        """Load location states."""
```

### Storage Format (world_state.json)

```json
{
  "version": "1.0",
  "campaign_id": "shadows-over-eldoria",
  "timeline": {
    "current_time": {
      "year": 1492,
      "month": 3,
      "day": 15,
      "hour": 14,
      "minute": 30,
      "round": 0
    },
    "events": [
      {
        "id": "evt_001",
        "game_time": {"year": 1492, "month": 3, "day": 14, "hour": 10},
        "real_session": 5,
        "description": "Party arrived in Thornwood Village",
        "location": "thornwood-village",
        "characters_involved": ["Ragnar", "Elara", "Finn"],
        "fact_ids": ["fact_042"]
      }
    ],
    "calendar": {
      "months_per_year": 12,
      "days_per_month": 30,
      "hours_per_day": 24
    }
  },
  "locations": {
    "old-crypt-level-1": {
      "location_id": "old-crypt-level-1",
      "visited": true,
      "first_visited": {"year": 1492, "month": 3, "day": 15, "hour": 11},
      "last_visited": {"year": 1492, "month": 3, "day": 15, "hour": 13},
      "state_changes": [
        {
          "id": "sc_001",
          "change_type": "door_opened",
          "description": "Iron door to burial chamber",
          "game_time": {"year": 1492, "month": 3, "day": 15, "hour": 11, "minute": 30},
          "session_number": 6,
          "target_object": "iron_door_01",
          "reversible": true,
          "reverted": false
        },
        {
          "id": "sc_002",
          "change_type": "trap_triggered",
          "description": "Poison dart trap in corridor",
          "game_time": {"year": 1492, "month": 3, "day": 15, "hour": 11, "minute": 45},
          "session_number": 6,
          "target_object": "dart_trap_01",
          "reversible": false,
          "reverted": false
        }
      ]
    }
  },
  "metadata": {
    "last_updated": "2026-02-05T19:06:45Z"
  }
}
```

## Dependencies

- Task 46: Fact Tracker System (for linking events to facts)

## Effort Estimate

- **Size:** M
- **Estimated Hours:** 6
- **Complexity:** Medium - temporal logic and state management

## Definition of Done

1. TimelineTracker class fully implemented
2. LocationStateManager class fully implemented
3. In-game time progression working correctly
4. Location state changes tracked accurately
5. Temporal validation catching inconsistencies
6. Travel time calculations functional
7. Day/night cycle and calendar working
8. Integration with FactDatabase verified
9. All code passes linting and type checking
10. Unit tests written and passing (>90% coverage)
11. World state properly persisted and loaded
12. Documentation/docstrings complete
