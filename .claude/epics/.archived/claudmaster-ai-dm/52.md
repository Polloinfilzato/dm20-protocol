---
name: Locked and Flexible Elements Configuration
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-07T01:48:13Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/49
depends_on: [51]
parallel: false
conflicts_with: []
---

# Locked and Flexible Elements Configuration

## Description

Implement a granular system for DMs to lock specific story elements (preventing AI improvisation) while allowing flexibility in others. This enables fine-tuned control over which aspects of the module must remain canonical and which can be adapted, going beyond the global improvisation level to per-element configuration.

## Acceptance Criteria

- [ ] Create UI/config interface for locking individual plot elements
- [ ] Define flexible element categories (NPCs, locations, events, dialogue, descriptions)
- [ ] Implement per-element override system that supersedes global improvisation level
- [ ] Add validation logic to check locked elements against module content
- [ ] Create storage schema for element lock configuration
- [ ] Implement inheritance rules (e.g., locking a location locks its contents)
- [ ] Add MCP tools for managing locked/flexible elements
- [ ] Include comprehensive tests for element locking logic

## Technical Details

### Element Categories

```python
from enum import Enum

class ElementCategory(Enum):
    """Categories of story elements that can be locked or made flexible."""
    NPC = "npc"                    # Non-player characters
    LOCATION = "location"          # Places and settings
    EVENT = "event"                # Plot events and encounters
    DIALOGUE = "dialogue"          # Specific NPC lines
    DESCRIPTION = "description"    # Boxed text and descriptions
    ITEM = "item"                  # Treasure and equipment
    SECRET = "secret"              # Hidden information
    ENCOUNTER = "encounter"        # Combat and challenges
```

### Lock Configuration Schema

```python
@dataclass
class ElementLock:
    """Configuration for a locked story element."""
    element_id: str
    category: ElementCategory
    is_locked: bool
    lock_reason: Optional[str] = None
    override_level: Optional[ImprovisationLevel] = None
    inherit_to_children: bool = True

@dataclass
class LockConfiguration:
    """Campaign-level lock configuration."""
    locks: Dict[str, ElementLock]
    default_category_locks: Dict[ElementCategory, bool]
```

### Inheritance Rules

When an element is locked with `inherit_to_children=True`:
- Locking a location locks all NPCs, items, and events within
- Locking an NPC locks their dialogue and secrets
- Locking an event locks its descriptions and outcomes

### Validation Logic

```python
def validate_locks(locks: LockConfiguration, module_content: ModuleData) -> List[ValidationError]:
    """Validate that locked elements exist in module content."""
    errors = []
    for element_id, lock in locks.locks.items():
        if not module_content.has_element(element_id):
            errors.append(ValidationError(f"Locked element {element_id} not found in module"))
    return errors
```

### MCP Tools

- `lock_element(element_id, category, reason)` - Lock a specific element
- `unlock_element(element_id)` - Remove lock from element
- `list_locked_elements(category?)` - List all locked elements
- `set_category_default(category, locked)` - Set default lock state for category
- `validate_lock_config()` - Validate all locks against module

## Dependencies

- Task 50: Improvisation Level System (provides base level system to override)

## Effort Estimate

- **Size:** M
- **Estimated Hours:** 6
- **Complexity:** Medium - clear requirements but complex inheritance logic

## Definition of Done

1. All element categories defined and documented
2. Lock configuration schema implemented with validation
3. Per-element override system working correctly
4. Inheritance rules implemented and tested
5. MCP tools created and functional
6. Validation against module content working
7. All code passes linting and type checking
8. Unit tests written and passing (>90% coverage)
9. Documentation includes usage examples
