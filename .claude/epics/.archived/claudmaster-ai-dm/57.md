---
name: Companion Roleplay and Dialogue
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-05T19:21:30Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/54
depends_on: [42, 55]
parallel: true
conflicts_with: []
---

# Companion Roleplay and Dialogue

## Description

Implement a dialogue and reaction system that brings companions to life through personality-driven responses. Companions react to game events, engage in banter with players and NPCs, and express opinions based on their traits. This creates memorable, distinct companion personalities that enhance the roleplaying experience.

## Acceptance Criteria

- [ ] Implement companion reaction system for game events
- [ ] Create companion-to-player dialogue generation
- [ ] Support companion-to-NPC interactions
- [ ] Ensure personality traits drive response tone and content
- [ ] Add context awareness (remember recent events, relationships)
- [ ] Support mood/emotional state tracking
- [ ] Integrate with narrative generation system
- [ ] Write tests for dialogue consistency
- [ ] Document dialogue trigger system

## Technical Details

### CompanionDialogue System

```python
from dataclasses import dataclass, field
from enum import Enum
from typing import Optional

class DialogueTrigger(Enum):
    COMBAT_START = "combat_start"
    COMBAT_END = "combat_end"
    ALLY_INJURED = "ally_injured"
    ALLY_DOWNED = "ally_downed"
    ENEMY_KILLED = "enemy_killed"
    DISCOVERY = "discovery"
    REST = "rest"
    QUEST_COMPLETE = "quest_complete"
    NPC_INTERACTION = "npc_interaction"
    PLAYER_DECISION = "player_decision"
    IDLE = "idle"

class EmotionalState(Enum):
    NEUTRAL = "neutral"
    HAPPY = "happy"
    ANGRY = "angry"
    FEARFUL = "fearful"
    SAD = "sad"
    EXCITED = "excited"
    CONCERNED = "concerned"

@dataclass
class DialogueContext:
    trigger: DialogueTrigger
    target: Optional[str] = None          # Who/what triggered this
    location: Optional[str] = None
    recent_events: list[str] = field(default_factory=list)
    party_status: dict = field(default_factory=dict)

@dataclass
class CompanionDialogue:
    companion_id: str
    text: str
    trigger: DialogueTrigger
    emotional_state: EmotionalState
    addressed_to: Optional[str] = None    # Player name, NPC name, or "party"

class CompanionDialogueEngine:
    """Generates personality-driven dialogue for companions."""

    def __init__(self, companion: CompanionProfile):
        self.companion = companion
        self.emotional_state = EmotionalState.NEUTRAL
        self.relationship_memory: dict[str, int] = {}  # NPC/player -> sentiment

    def react_to_event(self, context: DialogueContext) -> Optional[CompanionDialogue]:
        """Generate a reaction to a game event based on personality."""
        pass

    def generate_banter(self, target: str) -> Optional[CompanionDialogue]:
        """Generate casual dialogue during downtime."""
        pass

    def respond_to_player(self, player_message: str) -> CompanionDialogue:
        """Generate response to direct player communication."""
        pass

    def interact_with_npc(self, npc: NPC, context: str) -> CompanionDialogue:
        """Generate dialogue when interacting with an NPC."""
        pass
```

### Personality-Driven Responses

Personality traits influence dialogue:

```python
def get_response_modifiers(self) -> dict:
    """Get dialogue modifiers based on personality."""
    modifiers = {}

    personality = self.companion.personality

    # Bravery affects combat reactions
    if personality.bravery > 70:
        modifiers["combat_tone"] = "confident"
    elif personality.bravery < 30:
        modifiers["combat_tone"] = "nervous"

    # Compassion affects reactions to suffering
    if personality.compassion > 70:
        modifiers["injury_reaction"] = "deeply_concerned"
    elif personality.compassion < 30:
        modifiers["injury_reaction"] = "pragmatic"

    # Aggression affects enemy interactions
    if personality.aggression > 70:
        modifiers["enemy_tone"] = "hostile"
    elif personality.aggression < 30:
        modifiers["enemy_tone"] = "diplomatic"

    return modifiers
```

### Event Reactions

Different triggers produce different dialogue types:

| Trigger | High Bravery | Low Bravery |
|---------|-------------|-------------|
| Combat Start | "Finally, some action!" | "Stay close, everyone." |
| Ally Injured | "Hold on, we've got this!" | "We need to fall back!" |
| Enemy Killed | "One down!" | "Is it over?" |

### Relationship Memory

- Track sentiment toward NPCs and players
- Positive interactions increase affinity
- Negative events decrease trust
- Affects dialogue tone in future interactions

### Narrative Integration

- Dialogue hooks into narrative agent output
- Companions can comment on story developments
- Supports interjections during NPC conversations

## Dependencies

- Task #41: Narrative Agent (assumed to exist in Phase 3)
  - Integrates dialogue into narrative flow
  - Uses context from story events
- Task #54: Companion NPC Profiles
  - Requires personality traits for dialogue generation
  - Uses companion identity and background

## Effort Estimate

- **Size:** M
- **Estimated Hours:** 8
- **Complexity:** Medium - creative text generation with personality modeling

## Definition of Done

1. Reaction system responds to all defined triggers
2. Player dialogue responses feel natural and consistent
3. NPC interactions respect companion personality
4. Personality traits visibly influence dialogue tone
5. Emotional state tracking working
6. Relationship memory persists across sessions
7. Narrative system integration complete
8. Tests verify personality consistency
9. Documentation covers trigger system
10. Code reviewed and approved
