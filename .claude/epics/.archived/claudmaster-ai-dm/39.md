---
name: Module Content Chunking and Indexing
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-06T23:23:27Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/36
depends_on: [37, 38]
parallel: false
conflicts_with: []
---

# Module Content Chunking and Indexing

## Description

Implement the text chunking strategy for adventure module content and index the chunks into ChromaDB for RAG retrieval. This includes intelligent chunking with overlap, preserving structural metadata (chapter, section, content type), and supporting re-indexing when modules are updated.

## Acceptance Criteria

- [ ] Create `ModuleIndexer` class in `src/gamemaster_mcp/claudmaster/module_indexer.py`
- [ ] Implement text chunking with configurable size and overlap
- [ ] Preserve structural context in chunk metadata
- [ ] Store chapter/section references with each chunk
- [ ] Store NPC and location cross-references
- [ ] Implement full module indexing workflow
- [ ] Implement incremental re-indexing on module update
- [ ] Add detection of already-indexed modules (skip if unchanged)
- [ ] Handle special content (stat blocks, boxed text, tables)
- [ ] Add unit tests for chunking and indexing
- [ ] Include docstrings for all public methods

## Technical Details

### File Location

```
src/gamemaster_mcp/claudmaster/
├── module_indexer.py    # ModuleIndexer class
└── ...
```

### Chunking Strategy

```python
@dataclass
class ChunkConfig:
    """Configuration for text chunking."""
    chunk_size: int = 500       # Target characters per chunk
    chunk_overlap: int = 100    # Overlap between chunks
    min_chunk_size: int = 100   # Minimum chunk size
    respect_paragraphs: bool = True  # Don't split mid-paragraph if possible
    respect_sections: bool = True    # Prefer section boundaries
```

### Chunk Metadata Schema

Each chunk stored in ChromaDB includes:
```python
{
    "module_id": "curse-of-strahd",
    "chapter": "Chapter 4: Castle Ravenloft",
    "section": "K1. Front Courtyard",
    "content_type": "location",  # narrative, encounter, npc, location, item
    "page_start": 52,
    "page_end": 53,
    "chunk_index": 0,
    "total_chunks_in_section": 3,
    "npcs_referenced": ["Strahd", "Rahadin"],
    "locations_referenced": ["Castle Ravenloft", "Front Courtyard"],
    "is_boxed_text": false,
    "is_stat_block": false
}
```

### ModuleIndexer Class Interface

```python
class ModuleIndexer:
    """Indexes adventure module content into ChromaDB."""

    def __init__(
        self,
        vector_store: VectorStoreManager,
        chunk_config: Optional[ChunkConfig] = None
    ):
        """Initialize with vector store and chunk configuration."""
        pass

    def index_module(
        self,
        module_structure: ModuleStructure,
        pdf_path: str,
        force_reindex: bool = False
    ) -> IndexingResult:
        """Index entire module into vector store."""
        pass

    def chunk_text(
        self,
        text: str,
        context: Dict[str, Any]
    ) -> List[Tuple[str, Dict[str, Any]]]:
        """Chunk text with metadata preservation."""
        pass

    def is_indexed(self, module_id: str) -> bool:
        """Check if module is already indexed."""
        pass

    def get_index_metadata(self, module_id: str) -> Optional[Dict]:
        """Get metadata about indexed module."""
        pass

    def delete_index(self, module_id: str) -> None:
        """Remove module from vector store."""
        pass

@dataclass
class IndexingResult:
    """Result of module indexing operation."""
    module_id: str
    chunks_created: int
    chapters_indexed: int
    npcs_indexed: int
    locations_indexed: int
    indexing_time_seconds: float
    errors: List[str] = field(default_factory=list)
```

### Content Type Detection

Identify special content for appropriate handling:
- **Boxed text**: Read-aloud descriptions (preserve intact)
- **Stat blocks**: Monster/NPC statistics (chunk together)
- **Tables**: Reference tables (preserve structure)
- **Maps**: Map references (extract descriptions)

### Re-indexing Strategy

```python
# Stored with each indexed module
{
    "module_id": "curse-of-strahd",
    "source_hash": "sha256:abc123...",  # Hash of source PDF
    "indexed_at": "2026-02-05T19:06:45Z",
    "chunk_config": {...},
    "total_chunks": 1523
}
```

Compare hash on re-index to detect changes.

## Dependencies

- Task #36 (ChromaDB Vector Store Setup) - vector storage
- Task #37 (Adventure Module Parser) - module structure

## Effort Estimate

- **Size:** M
- **Estimated Hours:** 8
- **Complexity:** Medium - chunking strategy requires tuning

## Definition of Done

1. ModuleIndexer class fully implemented
2. Chunking respects content boundaries (paragraphs, sections)
3. All metadata correctly attached to chunks
4. Overlap strategy working correctly
5. Re-indexing detects and skips unchanged modules
6. Force re-index option working
7. Special content (boxed text, stat blocks) handled appropriately
8. IndexingResult provides useful statistics
9. All unit tests passing
10. Code passes linting and type checking
11. Documentation complete
