---
name: Contradiction Detection
status: completed
created: 2026-02-05T19:06:45Z
updated: 2026-02-07T00:26:06Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/46
depends_on: [47, 48]
parallel: false
conflicts_with: []
---

# Contradiction Detection

## Description

Implement a contradiction detection system that checks new narrative statements against established facts and NPC knowledge to identify potential inconsistencies. The system will flag contradictions, suggest resolutions, and maintain a log of detected issues for the DM to review, ensuring narrative coherence throughout the campaign.

## Acceptance Criteria

- [ ] Implement `ContradictionDetector` class
- [ ] Check new narrative statements against established facts
- [ ] Detect contradictions in NPC knowledge/dialogue
- [ ] Flag potential contradictions with severity levels
- [ ] Implement auto-resolution strategies for minor contradictions
- [ ] Log all contradictions and their resolutions
- [ ] Provide suggestions for resolving major contradictions
- [ ] Support contradiction categories (temporal, spatial, character, factual)
- [ ] Create unit tests for detection and resolution logic

## Technical Details

### File Structure

```
src/gamemaster_mcp/claudmaster/
├── consistency/
│   ├── __init__.py
│   ├── fact_database.py
│   ├── npc_knowledge.py
│   ├── contradiction.py     # ContradictionDetector class
│   └── models.py
```

### Contradiction Models

```python
from dataclasses import dataclass, field
from datetime import datetime
from enum import Enum
from typing import Optional

class ContradictionType(Enum):
    TEMPORAL = "temporal"       # Time-based inconsistencies
    SPATIAL = "spatial"         # Location-based inconsistencies
    CHARACTER = "character"     # NPC behavior/knowledge contradictions
    FACTUAL = "factual"         # Contradicts established facts
    LOGICAL = "logical"         # Logical impossibilities

class ContradictionSeverity(Enum):
    MINOR = "minor"             # Can be auto-resolved or ignored
    MODERATE = "moderate"       # Should be addressed but not critical
    MAJOR = "major"             # Significant narrative inconsistency
    CRITICAL = "critical"       # Breaks core story elements

class ResolutionStrategy(Enum):
    RETCON = "retcon"           # Quietly adjust the old fact
    EXPLAIN = "explain"         # Add narrative explanation
    IGNORE = "ignore"           # Minor enough to skip
    FLAG_FOR_DM = "flag_for_dm" # Needs human decision

@dataclass
class Contradiction:
    id: str
    type: ContradictionType
    severity: ContradictionSeverity
    new_statement: str
    conflicting_facts: list[str]  # Fact IDs
    detected_at: datetime
    session_number: int
    resolution: Optional[ResolutionStrategy] = None
    resolution_notes: Optional[str] = None
    resolved: bool = False

@dataclass
class ResolutionSuggestion:
    strategy: ResolutionStrategy
    description: str
    confidence: float  # How confident the system is this will work
    side_effects: list[str]  # Other facts that might need updating
```

### ContradictionDetector Class

```python
class ContradictionDetector:
    """Detects and manages narrative contradictions."""

    def __init__(
        self,
        fact_database: FactDatabase,
        npc_knowledge: NPCKnowledgeTracker,
        campaign_path: Path
    ):
        """Initialize with fact and NPC knowledge references."""

    def check_statement(
        self,
        statement: str,
        context: dict,
        session_number: int
    ) -> list[Contradiction]:
        """Check a new statement for contradictions."""

    def check_npc_dialogue(
        self,
        npc_id: str,
        dialogue: str,
        session_number: int
    ) -> list[Contradiction]:
        """Check NPC dialogue against their knowledge state."""

    def detect_temporal_contradiction(
        self,
        statement: str,
        relevant_facts: list[Fact]
    ) -> Optional[Contradiction]:
        """Check for time-based inconsistencies."""

    def detect_spatial_contradiction(
        self,
        statement: str,
        relevant_facts: list[Fact]
    ) -> Optional[Contradiction]:
        """Check for location-based inconsistencies."""

    def suggest_resolutions(
        self,
        contradiction: Contradiction
    ) -> list[ResolutionSuggestion]:
        """Generate resolution suggestions for a contradiction."""

    def auto_resolve(
        self,
        contradiction: Contradiction
    ) -> bool:
        """Attempt automatic resolution of minor contradictions."""

    def resolve_contradiction(
        self,
        contradiction_id: str,
        strategy: ResolutionStrategy,
        notes: str
    ) -> None:
        """Mark a contradiction as resolved with given strategy."""

    def get_unresolved(
        self,
        severity: Optional[ContradictionSeverity] = None
    ) -> list[Contradiction]:
        """Get all unresolved contradictions."""

    def get_contradiction_log(
        self,
        session: Optional[int] = None,
        resolved: Optional[bool] = None
    ) -> list[Contradiction]:
        """Get contradiction history with filters."""

    def save(self) -> None:
        """Persist contradiction log."""

    def load(self) -> None:
        """Load contradiction log."""
```

### Storage Format (contradictions.json)

```json
{
  "version": "1.0",
  "campaign_id": "shadows-over-eldoria",
  "contradictions": [
    {
      "id": "contra_001",
      "type": "temporal",
      "severity": "moderate",
      "new_statement": "The merchant arrived yesterday",
      "conflicting_facts": ["fact_042"],
      "detected_at": "2026-02-05T20:15:00Z",
      "session_number": 7,
      "resolution": "explain",
      "resolution_notes": "Clarified merchant was delayed by storm",
      "resolved": true
    }
  ],
  "statistics": {
    "total_detected": 15,
    "auto_resolved": 8,
    "manually_resolved": 5,
    "pending": 2
  },
  "metadata": {
    "last_updated": "2026-02-05T19:06:45Z"
  }
}
```

### Detection Heuristics

1. **Temporal Detection**: Compare timestamps, sequences ("before/after"), durations
2. **Spatial Detection**: Location references, travel times, simultaneous presence
3. **Character Detection**: NPC personality shifts, impossible knowledge
4. **Factual Detection**: Direct contradiction of established events
5. **Logical Detection**: Physical impossibilities, rule violations

## Dependencies

- Task 46: Fact Tracker System (required for fact comparison)
- Task 47: NPC Knowledge State Tracking (required for dialogue checking)

## Effort Estimate

- **Size:** L
- **Estimated Hours:** 10
- **Complexity:** High - requires semantic understanding and heuristic detection

## Definition of Done

1. ContradictionDetector class fully implemented
2. All contradiction types detected correctly
3. Severity classification working as expected
4. Auto-resolution working for minor contradictions
5. Resolution suggestions generated appropriately
6. Contradiction log persisted and queryable
7. Integration with FactDatabase and NPCKnowledgeTracker verified
8. All code passes linting and type checking
9. Unit tests written and passing (>85% coverage)
10. Documentation/docstrings complete
11. Performance acceptable for real-time checking
