---
name: MCP Tools - Rulebook Management
status: completed
created: 2026-02-02T03:47:06Z
updated: 2026-02-02T03:47:06Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/18
depends_on: [15, 16]
parallel: true
conflicts_with: [18]
---

# Task: MCP Tools - Rulebook Management

## Description

Implement MCP tools for managing rulebooks: loading, listing, and unloading rulebook sources. These tools allow users to configure which rules are active in their campaign.

## Acceptance Criteria

- [ ] `load_rulebook` tool: Load SRD or custom rulebook into campaign
- [ ] `list_rulebooks` tool: List active rulebooks with source info
- [ ] `unload_rulebook` tool: Remove a rulebook from campaign
- [ ] All tools follow existing patterns in main.py
- [ ] Proper error handling and user feedback
- [ ] Support TOON output format where applicable

## Technical Details

### Tool: load_rulebook

```python
@mcp.tool
async def load_rulebook(
    source: Annotated[
        Literal["srd", "custom"],
        Field(description="Source type: 'srd' for official D&D 5e SRD, 'custom' for local files")
    ],
    version: Annotated[
        str | None,
        Field(description="SRD version: '2014' (default) or '2024'. Ignored for custom sources.")
    ] = "2014",
    path: Annotated[
        str | None,
        Field(description="Path to custom rulebook file (JSON or YAML). Required for custom sources.")
    ] = None,
) -> str:
    """
    Load a rulebook into the current campaign.

    Examples:
    - Load SRD: source="srd", version="2014"
    - Load custom: source="custom", path="homebrew/my_races.json"
    """
    if not storage._current_campaign:
        return "‚ùå No campaign loaded. Use `load_campaign` first."

    if source == "srd":
        srd_source = SRDSource(version=version or "2014", cache_dir=storage.rulebook_cache_dir)
        await storage.rulebook_manager.load_source(srd_source)
        return f"‚úÖ Loaded SRD {version} rulebook\nüìö {srd_source.stats_summary()}"

    elif source == "custom":
        if not path:
            return "‚ùå Custom source requires 'path' parameter"
        custom_source = CustomSource(path=storage.rulebooks_dir / path)
        await storage.rulebook_manager.load_source(custom_source)
        return f"‚úÖ Loaded custom rulebook: {path}\nüìö {custom_source.stats_summary()}"
```

### Tool: list_rulebooks

```python
@mcp.tool
def list_rulebooks(
    format: Annotated[
        Literal["json", "toon"],
        Field(description="Output format: 'json' for full details, 'toon' for token-efficient")
    ] = "json",
) -> str:
    """List all active rulebooks in the current campaign."""
    if not storage._current_campaign:
        return "‚ùå No campaign loaded."

    if not storage.rulebook_manager or not storage.rulebook_manager.sources:
        return "üìö No rulebooks loaded. Use `load_rulebook` to add one."

    rulebooks = []
    for source_id, source in storage.rulebook_manager.sources.items():
        rulebooks.append({
            "id": source_id,
            "type": source.source_type,
            "loaded_at": source.loaded_at.isoformat(),
            "content_counts": source.content_counts,
        })

    if format == "toon":
        return encode_to_toon(rulebooks)

    # Markdown output
    lines = ["# Active Rulebooks\n"]
    for rb in rulebooks:
        lines.append(f"## {rb['id']}")
        lines.append(f"- Type: {rb['type']}")
        lines.append(f"- Loaded: {rb['loaded_at']}")
        lines.append(f"- Content: {rb['content_counts']}")
        lines.append("")

    return "\n".join(lines)
```

### Tool: unload_rulebook

```python
@mcp.tool
def unload_rulebook(
    source_id: Annotated[
        str,
        Field(description="ID of the rulebook to unload (from list_rulebooks)")
    ],
) -> str:
    """Remove a rulebook from the current campaign."""
    if not storage._current_campaign:
        return "‚ùå No campaign loaded."

    if not storage.rulebook_manager:
        return "‚ùå No rulebooks loaded."

    if storage.rulebook_manager.unload_source(source_id):
        return f"‚úÖ Unloaded rulebook: {source_id}"
    else:
        return f"‚ùå Rulebook not found: {source_id}"
```

### Import Updates

```python
# Add to main.py imports
from gamemaster_mcp.rulebooks import RulebookManager, SRDSource, CustomSource
from gamemaster_mcp.rulebooks.models import ClassDefinition, RaceDefinition
```

## Dependencies

- [ ] Task 14: RulebookManager (core functionality)
- [ ] Task 15: Storage Integration (manager available via storage)

## Effort Estimate

- Size: S
- Parallel: true (can run with Task 18)

## Definition of Done

- [ ] Three management tools implemented
- [ ] Tools registered with @mcp.tool decorator
- [ ] Error handling for edge cases
- [ ] User-friendly output with emojis
- [ ] TOON format support for list_rulebooks
- [ ] Integration tests with mock campaign
