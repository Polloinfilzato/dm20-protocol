---
name: RulebookManager Orchestration
status: completed
created: 2026-02-02T03:47:06Z
updated: 2026-02-02T06:15:00Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/15
depends_on: [12, 13, 14]
parallel: false
conflicts_with: []
---

# Task: RulebookManager Orchestration

## Description

Create the RulebookManager class that orchestrates multiple rulebook sources and provides a unified query interface. This is the main entry point for all rulebook operations.

## Acceptance Criteria

- [ ] Create `src/gamemaster_mcp/rulebooks/manager.py` with `RulebookManager` class
- [ ] Support loading multiple sources (SRD + custom rulebooks)
- [ ] Unified query interface: `get_class()`, `get_race()`, `get_spell()`, `get_monster()`, `search()`
- [ ] Priority resolution: custom content overrides official
- [ ] Load/unload sources dynamically
- [ ] Persist active sources to campaign manifest
- [ ] Lazy loading: content loaded on first access
- [ ] Campaign-scoped: each campaign has its own manager instance
- [ ] Thread-safe for concurrent queries

## Technical Details

### Manager Structure

```python
class RulebookManager:
    """Orchestrates multiple rulebook sources with unified query interface."""

    def __init__(self, campaign_dir: Path):
        self.campaign_dir = campaign_dir
        self._sources: dict[str, RulebookSource] = {}  # id -> source
        self._priority: list[str] = []  # Order of resolution (last wins)

    async def load_source(self, source: RulebookSource) -> None:
        """Add and load a rulebook source."""
        await source.load()
        self._sources[source.source_id] = source
        self._priority.append(source.source_id)
        self._save_manifest()

    def unload_source(self, source_id: str) -> bool:
        """Remove a source from the manager."""
        if source_id in self._sources:
            del self._sources[source_id]
            self._priority.remove(source_id)
            self._save_manifest()
            return True
        return False

    def get_class(self, index: str) -> ClassDefinition | None:
        """Query class from all sources (priority order)."""
        for source_id in reversed(self._priority):
            result = self._sources[source_id].get_class(index)
            if result:
                return result
        return None
```

### Manifest File

Location: `{campaign_dir}/rulebooks/manifest.json`

```json
{
  "active_sources": [
    {
      "id": "srd-2014",
      "type": "srd",
      "version": "2014",
      "loaded_at": "2026-02-02T14:00:00Z"
    },
    {
      "id": "homebrew-races",
      "type": "custom",
      "path": "custom/my_races.json",
      "loaded_at": "2026-02-02T14:05:00Z"
    }
  ],
  "priority": ["srd-2014", "homebrew-races"],
  "conflict_resolution": "last_wins"
}
```

### Factory Methods

```python
class RulebookManager:
    @classmethod
    async def load_srd(cls, campaign_dir: Path, version: str = "2014") -> "RulebookManager":
        """Create manager with SRD pre-loaded."""
        manager = cls(campaign_dir)
        await manager.load_source(SRDSource(version=version))
        return manager

    @classmethod
    async def from_manifest(cls, campaign_dir: Path) -> "RulebookManager":
        """Load manager from existing manifest."""
        manager = cls(campaign_dir)
        manifest = manager._load_manifest()
        for source_config in manifest["active_sources"]:
            source = manager._create_source(source_config)
            await manager.load_source(source)
        return manager
```

### Search Interface

```python
def search(
    self,
    query: str,
    categories: list[str] | None = None,
    limit: int = 20
) -> list[SearchResult]:
    """
    Search across all loaded sources.

    Args:
        query: Search term (fuzzy match)
        categories: Filter to specific types (class, race, spell, monster, etc.)
        limit: Max results

    Returns:
        List of SearchResult with source attribution
    """
```

## Dependencies

- [ ] Task 11: Rulebook Data Models
- [ ] Task 12: Source Abstraction
- [ ] Task 13: SRD API Client

## Effort Estimate

- Size: M
- Parallel: false (depends on all previous tasks)

## Definition of Done

- [ ] RulebookManager class with full interface
- [ ] Source loading/unloading works
- [ ] Manifest persistence works
- [ ] Priority resolution works (custom overrides SRD)
- [ ] Search works across sources
- [ ] Unit tests for all manager methods
- [ ] Integration test with SRD + custom source
