---
name: Tool Output Audit & Enrichment
status: closed
created: 2026-02-09T01:33:04Z
updated: 2026-02-09T01:50:34Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/67
depends_on: []
parallel: true
conflicts_with: [68]
---

# Task: Tool Output Audit & Enrichment

## Description

Audit and enrich the return values of key MCP tools so they provide sufficient structured data for Claude to act as a DM. Currently, most tools return formatted markdown strings that are hard for an AI to parse and act on. The DM needs structured, complete data to make decisions.

## Acceptance Criteria

- [ ] `get_character` returns full character data including: inventory details (not just count), equipment slots, spell slots/spells known, proficiency bonus, skill proficiencies, saving throws, death saves, hit dice
- [ ] `get_npc` returns full NPC data including: stats (if any), relationships dict
- [ ] `get_game_state` returns structured data including: initiative_order, current_turn (when in combat), active quest names
- [ ] `start_combat` validates participants exist as characters/NPCs in the campaign
- [ ] `next_turn` skips dead/incapacitated participants
- [ ] `end_combat` returns a combat summary (participants, rounds, casualties)
- [ ] All enriched tools maintain backward compatibility (existing string output still works)
- [ ] Tests pass for all modified tools

## Technical Details

### Files to Modify
- `src/dm20_protocol/main.py` — Tool function implementations for:
  - `get_character` (~line 183-250)
  - `get_npc` (~line 429-450)
  - `get_game_state` (~line 633-654)
  - `start_combat` (~line 657-676)
  - `next_turn` (~line 688-711)
  - `end_combat` (~line 678-686)

### Approach
- Enrich the formatted string output to include ALL relevant data from the underlying models
- For `get_character`: expose `inventory` items with details, `equipment` dict, `spells_known`, `spell_slots`, `spell_slots_used`, `features_and_traits`, `proficiency_bonus`, `death_saves_success/failure`
- For `get_npc`: expose `stats` and `relationships` dicts
- For `get_game_state`: expose `initiative_order` and `current_turn` from GameState model
- For combat tools: add validation, skip dead participants, return summary on end

### Key Considerations
- The tools are called by Claude (the host LLM) which reads formatted text well, so enriching the string output (rather than changing to JSON) is the right approach
- Check the actual model fields in `src/dm20_protocol/models.py` to confirm what data is available
- Existing tests in `tests/` must continue to pass

## Dependencies
- [ ] None — this is a foundation task

## Effort Estimate
- Size: M
- Hours: 4-6
- Parallel: true (can run alongside Task 68 with care — both modify main.py but different tool functions)
- Conflicts: Task 68 also modifies main.py session tools

## Definition of Done
- [ ] All 6 tool functions enriched with complete data
- [ ] Combat tools have validation and improved state management
- [ ] Existing tests pass
- [ ] New test cases for enriched output
