---
name: Hybrid Python Integration
status: open
created: 2026-02-09T01:33:04Z
updated: 2026-02-09T01:56:17Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/72
depends_on: [68]
parallel: true
conflicts_with: []
---

# Task: Hybrid Python Integration

## Description

Wire the existing Python Orchestrator and Archivist code into the MCP tool flow so that deterministic operations (intent classification, data retrieval, consistency checks) happen locally in Python instead of consuming LLM tokens. This is the "token savings" layer of the hybrid architecture.

The goal is NOT to rewrite anything — just to ensure the existing Python logic is accessible through the MCP tool pipeline.

## Acceptance Criteria

- [ ] `player_action` tool uses `Orchestrator.classify_intent()` internally to classify player input before processing
- [ ] Intent classification result (type + confidence) is included in the `player_action` response metadata
- [ ] Archivist data retrieval methods are accessible through existing tools (get_character, get_npc, etc.) — verify they already are
- [ ] Consistency Engine fact tracking is wired into session persistence (facts saved/loaded with session)
- [ ] Python agents (Narrator, Archivist, Module Keeper) are registered in the Orchestrator when a session starts
- [ ] Document which Python components are "active" (used in game loop) vs "available but unused" (Narrator LLM calls)
- [ ] No new Python code created — only wiring of existing components

## Technical Details

### Intent Classification Integration
The `player_action` tool (registered in Task 68) should:
1. Receive raw player input
2. Call `Orchestrator.classify_intent(player_input)` — this is pure Python, zero tokens
3. Include the classified intent (type, confidence, matched patterns) in the tool response
4. Claude (the DM) can then use this classification to decide how to respond

### Archivist Data Layer
Verify that the Archivist's data retrieval methods (get_hp_status, get_character_stats, get_inventory) are already surfaced through the MCP tools. If not, the enriched tools from Task 67 should cover this.

### Consistency Engine
The `ConsistencyEngine` (in `src/dm20_protocol/claudmaster/consistency/`) tracks:
- Established narrative facts
- NPC knowledge states
- Contradiction detection

This needs to be:
1. Initialized when a session starts
2. Updated when events are added
3. Saved when session is paused
4. Loaded when session is resumed

### Agent Registration
When `start_claudmaster_session` creates an Orchestrator, it should register the Python agents:
```python
orchestrator.register_agent("narrator", NarratorAgent(...))
orchestrator.register_agent("archivist", ArchivistAgent(...))
orchestrator.register_agent("module_keeper", ModuleKeeperAgent(...))
```

Note: These agents' LLM-calling methods (generate, etc.) are NOT used — only their data retrieval and analysis methods.

### Documentation
Add a section to the epic or a README noting:
- **Active Python components:** classify_intent, data queries, consistency checks
- **Available but unused:** Narrator.generate(), Module Keeper RAG (will be used in Phase 2)

## Dependencies
- [ ] Task 68 (Session Tool Fixes) — needs working session management to wire into

## Effort Estimate
- Size: S
- Hours: 2-3
- Parallel: true (can start after Task 68, runs alongside Tasks 70-71)
- Conflicts: none

## Definition of Done
- [ ] Intent classification integrated into player_action flow
- [ ] Agent registration happens on session start
- [ ] Consistency Engine wired into session lifecycle
- [ ] Documentation of active vs unused Python components
- [ ] No new Python logic created — only wiring
