---
name: Session Tool Fixes & player_action Registration
status: closed
created: 2026-02-09T01:33:04Z
updated: 2026-02-09T01:50:34Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/68
depends_on: []
parallel: true
conflicts_with: [67]
---

# Task: Session Tool Fixes & player_action Registration

## Description

Fix the critical blockers in the Claudmaster session system:
1. `start_claudmaster_session` currently returns a hardcoded error instead of loading the campaign
2. `player_action` tool exists in code but is not registered as an MCP tool
3. `get_claudmaster_session_state` has a hardcoded empty array for `active_quests`

## Acceptance Criteria

- [ ] `start_claudmaster_session` successfully loads a campaign by name from `DnDStorage`
- [ ] `start_claudmaster_session` initializes `SessionManager` with actual campaign data and `ClaudmasterConfig`
- [ ] `start_claudmaster_session` supports resume=True with existing session_id
- [ ] `player_action` is registered as `@mcp.tool` in `main.py` and callable via MCP
- [ ] `player_action` processes input through the Orchestrator pipeline (intent → agents → response)
- [ ] `get_claudmaster_session_state` returns actual active quests from campaign data
- [ ] Session save/resume cycle works (start → play → pause → resume)
- [ ] Tests pass for all fixed tools

## Technical Details

### Fix `start_claudmaster_session`
**File:** `src/dm20_protocol/claudmaster/tools/session_tools.py` (~line 442-455)

Current code returns hardcoded error:
```python
return {
    "session_id": session_id or "",
    "status": "error",
    "error_message": "Campaign loading not yet integrated..."
}
```

Replace with actual campaign loading:
```python
# Use existing storage instance (available via main.py's global `storage`)
campaign = storage.get_campaign_by_name(campaign_name)
if not campaign:
    return {"status": "error", "error_message": f"Campaign '{campaign_name}' not found"}

config = storage.get_claudmaster_config()
# ... initialize session with real data
```

**Key challenge:** The session tools in `session_tools.py` need access to the `storage` instance from `main.py`. Check how other tools access storage — likely via a module-level reference or passed through the tool function.

### Register `player_action`
**File:** `src/dm20_protocol/main.py`

The tool implementation is in `src/dm20_protocol/claudmaster/tools/action_tools.py` (~line 342-412). It needs to be imported and registered as `@mcp.tool` in `main.py`, following the same pattern as other Claudmaster tools.

### Fix `active_quests` in session state
**File:** `src/dm20_protocol/claudmaster/tools/session_tools.py` (~line 606-732)

Replace the hardcoded empty array with actual quest data from the campaign.

## Dependencies
- [ ] None — this is a foundation task

## Effort Estimate
- Size: M
- Hours: 3-5
- Parallel: true (can run alongside Task 67 with care — both modify main.py but different sections)
- Conflicts: Task 67 also modifies main.py tool functions

## Definition of Done
- [ ] `start_claudmaster_session` loads real campaign data
- [ ] `player_action` callable via MCP
- [ ] Session round-trip (start → pause → resume) works
- [ ] Active quests populated in session state
- [ ] Tests written and passing
