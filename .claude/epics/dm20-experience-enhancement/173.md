---
name: STT Integration + Player UI Voice Controls
status: closed
created: 2026-02-19T23:14:33Z
updated: 2026-02-20T01:07:20Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/175
depends_on: [172]
parallel: false
conflicts_with: [168, 169]
---

# Task: STT Integration + Player UI Voice Controls

## Description

Integrate Speech-to-Text (STT) into the player browser UI using the Web Speech API. Add a microphone button with listening indicator, transcribe spoken commands client-side, and send the transcribed text via the existing WebSocket connection to the server. The server processes speech-transcribed text identically to typed text.

## Acceptance Criteria

- [ ] Player browser uses Web Speech API for STT (client-side, free)
- [ ] Microphone button in player UI toggles STT on/off
- [ ] UI shows "listening" indicator when STT is active
- [ ] Transcribed text sent via existing WebSocket connection
- [ ] Server processes speech-transcribed text identically to typed text
- [ ] STT language matches campaign language (EN or IT)
- [ ] Works on Chrome and Safari (mobile and desktop)
- [ ] Graceful fallback: if STT unavailable, text input remains functional
- [ ] Microphone permission handled gracefully (prompt, denied state)

## Technical Details

### Player UI Changes (`src/dm20_protocol/party/static/`)

#### Microphone Button

```html
<button id="mic-btn" class="voice-control" title="Speak your action">
    <span class="mic-icon">üé§</span>
    <span class="listening-indicator" hidden>‚óè</span>
</button>
```

#### Web Speech API Integration (JavaScript)

```javascript
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const recognition = new SpeechRecognition();

recognition.continuous = false;
recognition.interimResults = true;
recognition.lang = campaignLanguage; // 'en-US' or 'it-IT'

recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    if (event.results[0].isFinal) {
        ws.send(JSON.stringify({
            type: "player_action",
            action: transcript,
            source: "voice"
        }));
    }
};

document.getElementById('mic-btn').onclick = () => {
    recognition.start();
    showListeningIndicator();
};
```

#### Listening Indicator

- Pulsing red dot animation when actively listening
- Interim transcription shown as preview text
- Visual feedback for successful transcription vs timeout

### Server-Side (No Changes Needed)

The WebSocket handler already processes `player_action` messages. Voice-transcribed text arrives in the same format ‚Äî no server changes needed beyond accepting the optional `source: "voice"` field for logging.

### Browser Compatibility

| Browser | STT Support | Notes |
|---------|------------|-------|
| Chrome (desktop) | Full | Best support |
| Chrome (mobile/Android) | Full | |
| Chrome (iOS) | Limited | Uses WebKit engine |
| Safari (macOS) | Full | Since Safari 14.1 |
| Safari (iOS) | Full | Best mobile option |
| Firefox | Limited | Behind flag, unreliable |

### Files Affected

- `src/dm20_protocol/party/static/` ‚Äî Player UI: mic button, STT JS, listening indicator CSS
- `tests/` ‚Äî UI integration tests (if applicable)

## Dependencies

- [ ] **Task #172 (Voice Registry + Audio Streaming)** must be completed ‚Äî establishes audio infrastructure
- [ ] Requires existing WebSocket infrastructure from party-mode

## Effort Estimate

- Size: M
- Hours: 6-8
- Parallel: false (depends on Task #172)

## Definition of Done

- [ ] Code implemented
- [ ] STT tested on Chrome and Safari (desktop + mobile)
- [ ] Listening indicator and mic button working
- [ ] Graceful fallback verified (STT unavailable ‚Üí text input works)
- [ ] Transcribed actions processed correctly by server
- [ ] CHANGELOG.md updated
