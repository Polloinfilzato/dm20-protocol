---
name: Standalone Rules Access + Rules Version Selection
status: closed
updated: 2026-02-20T00:48:43Z
created: 2026-02-19T23:14:33Z
updated: 2026-02-19T23:18:18Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/169
depends_on: []
parallel: true
conflicts_with: [174]
---

# Task: Standalone Rules Access + Rules Version Selection

## Description

Create a global `RulebookManager` initialized at server startup (outside any campaign context) so that rules tools (`search_rules`, `get_spell_info`, `get_monster_info`, `get_class_info`, `get_race_info`) work immediately without loading a campaign. Add a `rules_version` parameter to `create_campaign()` supporting "2014" and "2024" versions, with 2024 as default.

## Acceptance Criteria

- [ ] Global `RulebookManager` initialized at server startup with 5etools as default source
- [ ] All 5 rules MCP tools work without any campaign loaded
- [ ] When a campaign is active, its `RulebookManager` takes priority over the global one
- [ ] Response includes source attribution (e.g., "Source: 5etools")
- [ ] `create_campaign()` accepts `rules_version` parameter ("2014" or "2024")
- [ ] Default rules version is "2024" when not specified
- [ ] Rules version stored in campaign manifest and loaded on `load_campaign()`
- [ ] Standalone mode defaults to 2024
- [ ] Unit tests for global manager initialization and fallback chain
- [ ] Integration tests for rules queries without campaign

## Technical Details

### Global Manager Initialization

In `src/dm20_protocol/main.py` or server startup:

```python
global_rulebook_manager = RulebookManager()
await global_rulebook_manager.load_source(FiveToolsSource(version="2024"))
```

### Fallback Chain in MCP Tool Handlers

```python
def search_rules(query, ...):
    manager = storage.rulebook_manager or global_rulebook_manager
    return manager.search(query, ...)
```

Apply the same pattern to all 5 rules tools.

### Campaign Version Support

- Add `rules_version` field to campaign manifest schema in `storage.py`
- Update `create_campaign()` to accept and store the version
- On `load_campaign()`, load the appropriate versioned rulebook

### Files Affected

- `src/dm20_protocol/main.py` — MCP tool handlers (fallback chain), global manager init
- `src/dm20_protocol/storage.py` — Campaign manifest schema (add `rules_version`)
- `tests/` — New test files for standalone rules

## Dependencies

- [ ] No task dependencies (first task in epic)
- [ ] Requires existing `RulebookManager` class and `FiveToolsSource`

## Effort Estimate

- Size: M
- Hours: 6-8
- Parallel: true (can run alongside Tasks 168, 169, 170, 171)

## Definition of Done

- [ ] Code implemented
- [ ] Tests written and passing
- [ ] All 5 rules tools verified working without campaign
- [ ] Rules version parameter tested with both 2014 and 2024
- [ ] CHANGELOG.md updated
