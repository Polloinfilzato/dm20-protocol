---
name: TTS Engine Core
status: closed
updated: 2026-02-20T00:48:43Z
created: 2026-02-19T23:14:33Z
updated: 2026-02-19T23:18:18Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/173
depends_on: []
parallel: true
conflicts_with: []
---

# Task: TTS Engine Core

## Description

Build the TTS (Text-to-Speech) subsystem with a 3-tier router that selects the best engine based on context and hardware. Tier 1 (Speed): Kokoro for combat narration. Tier 2 (Quality): Qwen3-TTS via mlx-audio for DM/NPC voices. Tier 3 (Fallback): Edge-TTS cloud when local engines unavailable. Intel Macs substitute Piper for Kokoro. All engines are free and open-source.

## Acceptance Criteria

- [ ] TTSRouter with 3 tiers: Speed (Kokoro), Quality (Qwen3-TTS), Fallback (Edge-TTS)
- [ ] Hardware detection at startup determines available tiers (Apple Silicon vs Intel)
- [ ] Apple Silicon: Kokoro (Tier 1), Qwen3-TTS (Tier 2), Edge-TTS (Tier 3)
- [ ] Intel Mac: Piper (Tier 1), Edge-TTS (Tier 2 & 3)
- [ ] Each engine wrapper implements a common `TTSEngine` interface
- [ ] TTSRouter selects engine based on context (combat→speed, narration→quality)
- [ ] TTS generates valid audio output (WAV/Opus format)
- [ ] Graceful degradation: if preferred engine fails, cascade to next tier
- [ ] TTS engines installed as optional extras (`pip install dm20-protocol[voice]`)
- [ ] English and Italian language support
- [ ] Tier 1 latency < 300ms, Tier 2 latency < 1.5s

## Technical Details

### New Package: `src/dm20_protocol/voice/`

#### `hardware.py` — Hardware Detection

```python
def is_apple_silicon() -> bool:
    """Detect Apple Silicon (M1/M2/M3/M4)."""
    import platform
    return platform.machine() == "arm64" and platform.system() == "Darwin"

def get_available_tiers() -> dict:
    if is_apple_silicon():
        return {"speed": "kokoro", "quality": "qwen3-tts", "fallback": "edge-tts"}
    else:
        return {"speed": "piper", "quality": "edge-tts", "fallback": "edge-tts"}
```

#### `router.py` — TTSRouter

```python
class TTSRouter:
    def __init__(self):
        self.tiers = self._init_engines()

    async def synthesize(self, text: str, context: str, voice_config: dict) -> bytes:
        engine = self._select_engine(context)
        try:
            return await engine.synthesize(text, voice_config)
        except Exception:
            return await self._fallback(text, voice_config)
```

#### `engines/` — Engine Wrappers

- `base.py` — Abstract `TTSEngine` interface
- `kokoro.py` — Kokoro 82M wrapper (Apple Silicon speed tier)
- `qwen3.py` — Qwen3-TTS via mlx-audio (quality tier)
- `edge_tts.py` — Edge-TTS Python library (cloud fallback)
- `piper.py` — Piper TTS (Intel Mac speed tier)

### Optional Dependencies in `pyproject.toml`

```toml
[project.optional-dependencies]
voice = [
    "mlx-audio",
    "kokoro",
    "edge-tts",
    "piper-tts",
]
```

### Files Affected

- `src/dm20_protocol/voice/` — New package
- `pyproject.toml` — Optional voice dependencies
- `tests/test_voice/` — Engine and router tests

## Dependencies

- [ ] No task dependencies (foundational voice infrastructure)
- [ ] External: mlx-audio, kokoro, edge-tts, piper-tts (optional extras)

## Effort Estimate

- Size: L
- Hours: 12-16
- Parallel: true (can run alongside Tasks 167-170)

## Definition of Done

- [ ] Code implemented
- [ ] All engine wrappers implement common interface
- [ ] TTSRouter tested with mock and real engines
- [ ] Hardware detection tested
- [ ] Graceful degradation verified (engine failure → cascade)
- [ ] Optional dependency installation documented
- [ ] CHANGELOG.md updated
