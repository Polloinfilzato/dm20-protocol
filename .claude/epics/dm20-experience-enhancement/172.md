---
name: Voice Registry + Audio Streaming
status: closed
created: 2026-02-19T23:14:33Z
updated: 2026-02-20T00:34:08Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/174
depends_on: [171]
parallel: false
conflicts_with: [168]
---

# Task: Voice Registry + Audio Streaming

## Description

Create a per-campaign voice registry (YAML) that maps DM narrator, combat narrator, and individual NPCs to specific TTS engine/voice configurations. Implement WebSocket audio chunk streaming so that TTS-generated audio reaches player browsers in real time.

## Acceptance Criteria

### Voice Registry

- [ ] Per-campaign `voice_registry.yaml` file in campaign directory
- [ ] Default voice configurations for DM narrator, combat narrator
- [ ] NPC voice defaults by race/gender archetype
- [ ] NPC-specific voice overrides (e.g., custom voice for named NPCs)
- [ ] Qwen3-TTS voice design via text description for NPC voices
- [ ] Voice registry loaded in < 500ms
- [ ] Registry management API (get voice for NPC, update voice config)

### Audio Streaming

- [ ] TTS audio streamed via WebSocket to player browsers as chunks
- [ ] Audio format: Opus or PCM (configurable)
- [ ] Player browser auto-plays received audio chunks
- [ ] Sequence numbers for correct chunk ordering
- [ ] Supports both English and Italian audio
- [ ] Graceful degradation: if streaming fails, text still delivered

## Technical Details

### New Modules in `src/dm20_protocol/voice/`

#### `registry.py` — Voice Registry Management

```python
class VoiceRegistry:
    def __init__(self, campaign_dir: Path):
        self.config = self._load_or_create(campaign_dir / "voice_registry.yaml")

    def get_voice_config(self, speaker: str) -> dict:
        """Get voice config for DM, combat, or specific NPC."""
        if speaker in self.config.get("npc_overrides", {}):
            return self.config["npc_overrides"][speaker]
        # Fall back to defaults by archetype
        ...
```

#### `streaming.py` — WebSocket Audio Delivery

```python
async def stream_tts_to_player(player_id: str, text: str, voice_config: dict):
    audio_chunks = tts_router.synthesize_streaming(text, voice_config)
    async for chunk in audio_chunks:
        await connection_manager.send_to_player(player_id, {
            "type": "audio",
            "format": "opus",
            "data": base64.b64encode(chunk).decode(),
            "sequence": seq_num
        })
```

### Voice Registry YAML Schema

```yaml
version: 1
default_language: en
dm_voice:
  engine: qwen3-tts
  voice_design: "A warm, deep male voice with authority"
combat_voice:
  engine: kokoro
  voice: af_heart
npc_defaults:
  male_human:
    engine: qwen3-tts
    voice_design: "A middle-aged male voice, neutral and calm"
npc_overrides:
  giuseppe_barkeep:
    engine: qwen3-tts
    voice_design: "Un uomo italiano di mezza età, voce calda"
    language: it
```

### Player UI Audio Playback (JavaScript)

```javascript
ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if (msg.type === "audio") {
        audioQueue.push(base64ToArrayBuffer(msg.data));
        playNextChunk();
    }
};
```

### Files Affected

- `src/dm20_protocol/voice/registry.py` — New voice registry module
- `src/dm20_protocol/voice/streaming.py` — New audio streaming module
- `src/dm20_protocol/party/server.py` — WebSocket audio message type
- `src/dm20_protocol/party/static/` — Player UI audio playback
- `tests/test_voice/` — Registry and streaming tests

## Dependencies

- [ ] **Task #171 (TTS Engine Core)** must be completed — provides TTSRouter and engine wrappers
- [ ] Requires existing WebSocket infrastructure from party-mode

## Effort Estimate

- Size: M
- Hours: 6-8
- Parallel: false (depends on Task #171)

## Definition of Done

- [ ] Code implemented
- [ ] Voice registry YAML schema documented
- [ ] Audio streaming tested end-to-end (TTS → WebSocket → browser playback)
- [ ] NPC voice mapping verified with different archetypes
- [ ] CHANGELOG.md updated
