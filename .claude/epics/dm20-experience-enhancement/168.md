---
name: Party-Mode Stable Tokens + QR Terminal Display
status: open
created: 2026-02-19T23:14:33Z
updated: 2026-02-19T23:18:18Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/170
depends_on: []
parallel: true
conflicts_with: [172, 173]
---

# Task: Party-Mode Stable Tokens + QR Terminal Display

## Description

Replace random token generation in party-mode with deterministic tokens based on character ID, so that player URLs remain stable across server restarts. Additionally, render QR codes as ASCII/Unicode art directly in terminal output so players can scan them immediately.

## Acceptance Criteria

### Stable Tokens

- [ ] Token equals the character's unique identifier (character name/ID)
- [ ] Same character always gets the same URL across server restarts
- [ ] Old random token generation (`secrets.token_urlsafe`) commented out, not deleted
- [ ] OBSERVER token is the fixed string "OBSERVER"
- [ ] Existing party-mode functionality (WebSocket, actions, permissions) unchanged
- [ ] Token validation is O(1) lookup

### QR Terminal Display

- [ ] QR codes rendered as ASCII/Unicode art in terminal output
- [ ] Each QR code labeled with character name and URL
- [ ] QR codes still saved to files (existing behavior preserved)
- [ ] Works in standard terminal emulators (iTerm2, Terminal.app)
- [ ] Graceful fallback to URL-only output if terminal rendering fails

## Technical Details

### Stable Token Implementation

In `src/dm20_protocol/party/auth.py`:

```python
class TokenManager:
    def generate_token(self, player_id: str) -> str:
        # NEW: Deterministic token = player_id
        token = player_id
        self._tokens[token] = player_id
        self._reverse_index[player_id] = token
        return token

        # OLD (preserved as comment):
        # token = secrets.token_urlsafe(6)
        # ...
```

### QR Terminal Rendering

In `src/dm20_protocol/party/server.py`:

```python
import qrcode

def render_qr_terminal(url: str, label: str) -> str:
    qr = qrcode.QRCode(border=1)
    qr.add_data(url)
    qr.make(fit=True)
    # Unicode block character art for terminal
    return f"\n{label}\n{qr.print_ascii(out=None)}\n{url}"
```

### Files Affected

- `src/dm20_protocol/party/auth.py` — TokenManager: deterministic token generation
- `src/dm20_protocol/party/server.py` — QR terminal output rendering
- `tests/` — Token stability tests, QR rendering tests

## Dependencies

- [ ] No task dependencies
- [ ] Requires existing `qrcode` package (already in dependencies)

## Effort Estimate

- Size: S
- Hours: 3-4
- Parallel: true (can run alongside Tasks 167, 169, 170, 171)

## Definition of Done

- [ ] Code implemented
- [ ] Tests written and passing (token stability across simulated restarts)
- [ ] QR codes verified in iTerm2 and Terminal.app
- [ ] Old token generation code preserved as comments
- [ ] CHANGELOG.md updated
