---
name: DDB fetcher and file reader
status: open
created: 2026-02-17T17:01:12Z
updated: 2026-02-17T17:12:58Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/160
depends_on: [159]
parallel: true
conflicts_with: []
---

# Task: DDB fetcher and file reader

## Description

Implement the input layer that retrieves DDB character JSON from two sources: (A) HTTP fetch from D&D Beyond's character service endpoint given a URL or numeric ID, and (B) reading a local JSON file. Both paths output a validated `dict` ready for the mapper.

## Acceptance Criteria

- [ ] `fetcher.py` can extract numeric character ID from various URL formats
- [ ] `fetcher.py` fetches JSON from `character-service.dndbeyond.com/character/v5/character/{id}` using httpx
- [ ] `fetcher.py` handles HTTP errors: 404 (not found), 403 (private), timeout, connection error
- [ ] `fetcher.py` validates response has expected top-level keys (`name`, `stats`, `classes`)
- [ ] `fetcher.py` can read and validate a local `.json` file as DDB format
- [ ] Both paths return a raw `dict` (the character data portion of the DDB response)
- [ ] DDB API response wrapper (`{"data": {...}}`) is unwrapped correctly

## Technical Details

### File: `src/dm20_protocol/importers/dndbeyond/fetcher.py`

**URL parsing function:**
```python
def extract_character_id(url_or_id: str) -> int:
```
- Accept: `https://www.dndbeyond.com/characters/12345678`, `https://www.dndbeyond.com/characters/12345678/builder`, `12345678`
- Use regex from `schema.py` (`DDB_CHARACTER_URL_PATTERN`)
- Raise `ImportError` if URL doesn't match and isn't a bare integer

**Fetch function (async):**
```python
async def fetch_character(url_or_id: str) -> dict:
```
- Extract ID → build API URL → `httpx.AsyncClient.get()`
- Timeout: 10 seconds
- Unwrap `{"data": {...}}` envelope if present
- Validate top-level keys exist
- Return raw character dict

**File reader function:**
```python
def read_character_file(file_path: str) -> dict:
```
- Read JSON file → validate structure → unwrap envelope if present
- Detect DDB format by checking for `stats` array and `classes` array
- Raise `ImportError` with clear message if format unrecognized

### Error handling

- `404` → `ImportError("Character not found. Check the ID or URL.")`
- `403` → `ImportError("Character is private. Set it to Public on D&D Beyond, or use file import.")`
- Timeout → `ImportError("D&D Beyond is not responding. Try again later or use file import.")`
- Invalid JSON file → `ImportError("File is not valid DDB character JSON. Expected 'stats' and 'classes' fields.")`

## Dependencies

- [ ] #159 — Schema constants (URL pattern, API base URL)
- [ ] `httpx` — Already in pyproject.toml

## Effort Estimate

- Size: S
- Hours: 3
- Parallel: true (can run alongside #161 after #159 is done)

## Definition of Done

- [ ] URL parsing handles all documented URL formats
- [ ] HTTP fetch works for public characters
- [ ] File reader works for saved DDB JSON files
- [ ] All error cases return clear, actionable messages
- [ ] Functions are importable from `dm20_protocol.importers.dndbeyond.fetcher`
