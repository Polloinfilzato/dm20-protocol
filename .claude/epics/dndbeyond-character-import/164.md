---
name: Test suite with DDB JSON fixtures
status: closed
created: 2026-02-17T17:01:12Z
updated: 2026-02-17T18:20:14Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/164
depends_on: [159, 160, 161, 162, 163]
parallel: false
conflicts_with: []
---

# Task: Test suite with DDB JSON fixtures

## Description

Create a comprehensive test suite for the DDB import pipeline: unit tests for each mapper function, integration tests for the full pipeline, HTTP mock tests for the fetcher, and file reader tests. Include realistic DDB JSON fixtures as test data.

## Acceptance Criteria

- [ ] `tests/fixtures/ddb_character_sample.json` contains a realistic (anonymized) DDB character JSON
- [ ] Unit tests for each `map_*()` function with known expected values
- [ ] Ability score aggregation tested with multiple modifier sources
- [ ] Fetcher tests with mocked httpx responses (200, 403, 404, timeout)
- [ ] URL parsing tests for all supported URL formats
- [ ] File reader tests for valid and invalid JSON files
- [ ] Integration test: full JSON → Character pipeline
- [ ] Edge case tests: missing optional fields, empty arrays, null values
- [ ] All tests pass

## Technical Details

### Fixture file: `tests/fixtures/ddb_character_sample.json`

Create a realistic but anonymized DDB character JSON. Must include:
- A level 5+ character with subclass
- Multiple ability score modifiers (racial + ASI + bonus)
- Several inventory items (weapon, armor, misc)
- Prepared and known spells
- Class features and racial traits
- At least one feat
- Currency values
- Notes and traits

The fixture should be crafted manually based on the known DDB JSON structure documented in the PRD and schema.py constants.

### Test files

**`tests/test_ddb_fetcher.py`:**
- `test_extract_character_id_from_url()` — full URL
- `test_extract_character_id_from_url_with_builder()` — URL with /builder suffix
- `test_extract_character_id_bare_number()` — just the ID
- `test_extract_character_id_invalid()` — bad input
- `test_fetch_character_success()` — mock 200 response
- `test_fetch_character_not_found()` — mock 404
- `test_fetch_character_private()` — mock 403
- `test_fetch_character_timeout()` — mock timeout
- `test_read_character_file_valid()` — valid DDB JSON file
- `test_read_character_file_invalid_format()` — non-DDB JSON
- `test_read_character_file_not_found()` — missing file

**`tests/test_ddb_mapper.py`:**
- `test_map_identity()` — name, race, class, background, alignment
- `test_map_identity_with_subclass()` — subclass present
- `test_map_identity_multiclass()` — multiple classes
- `test_map_abilities_base_only()` — no modifiers
- `test_map_abilities_with_racial_bonus()` — racial modifier applied
- `test_map_abilities_with_asi()` — ASI from class
- `test_map_abilities_with_override()` — stat override (headband of intellect)
- `test_map_combat_basic()` — HP, AC, speed
- `test_map_combat_with_bonus_hp()` — bonus HP from feats
- `test_map_combat_with_removed_hp()` — damaged character
- `test_map_proficiencies()` — skills, saves, tools
- `test_map_proficiencies_languages()` — language extraction
- `test_map_inventory()` — items with correct types
- `test_map_equipment_slots()` — equipped items in correct slots
- `test_map_spells()` — spell list with levels and schools
- `test_map_spell_slots()` — slot configuration
- `test_map_features()` — class features, racial traits, feats
- `test_map_notes()` — bio from traits
- `test_map_currency()` — currency formatting

**`tests/test_ddb_integration.py`:**
- `test_full_import_from_fixture()` — complete pipeline from fixture JSON
- `test_import_result_has_no_critical_warnings()` — warnings are advisory, not errors
- `test_partial_import_with_missing_fields()` — graceful degradation

### Mocking strategy

- Use `pytest-httpx` or `unittest.mock.patch` for httpx mocking
- Create helper to load fixture JSON for mapper tests
- Each mapper test provides a minimal DDB JSON snippet (not the full fixture) for isolation

## Dependencies

- [ ] #159 — Base models to assert against
- [ ] #160 — Fetcher functions to test
- [ ] #161 — Core mapper functions to test
- [ ] #162 — Extended mapper functions to test
- [ ] #163 — Integration test needs MCP tools wired
- [ ] `pytest` — Already in dev dependencies

## Effort Estimate

- Size: M
- Hours: 4
- Parallel: false (must wait for all implementation tasks)

## Definition of Done

- [ ] Fixture file committed to `tests/fixtures/`
- [ ] All test files created in `tests/`
- [ ] All tests pass with `pytest tests/test_ddb_*.py`
- [ ] Edge cases covered (missing fields, nulls, empty arrays)
- [ ] HTTP error scenarios tested
- [ ] No test depends on live D&D Beyond endpoint (all mocked)
