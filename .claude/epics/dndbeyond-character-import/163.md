---
name: MCP tool integration and import summary
status: open
created: 2026-02-17T17:01:12Z
updated: 2026-02-17T17:12:58Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/163
depends_on: [159, 160, 161]
parallel: true
conflicts_with: []
---

# Task: MCP tool integration and import summary

## Description

Register two new MCP tools (`import_from_dndbeyond` and `import_character_file`) in `main.py`, wire them to the fetcher and mapper pipeline, add the imported character to the current campaign storage, and generate a formatted import summary for the user.

## Acceptance Criteria

- [ ] `import_from_dndbeyond` MCP tool registered and callable
- [ ] `import_character_file` MCP tool registered and callable
- [ ] Both tools require an active campaign (error if none loaded)
- [ ] Imported character is saved to campaign storage
- [ ] Tools return a formatted import summary (mapped fields, warnings, character name)
- [ ] Error messages are clear and actionable (no campaign, fetch failed, mapping failed)
- [ ] `player_name` parameter correctly assigned to character

## Technical Details

### File: `src/dm20_protocol/main.py` (add tools)

**Tool 1: import_from_dndbeyond**
```python
@mcp.tool()
async def import_from_dndbeyond(
    url_or_id: str,
    player_name: str | None = None,
) -> str:
    """Import a public D&D Beyond character into the current campaign.

    Provide a D&D Beyond character URL (e.g., https://www.dndbeyond.com/characters/12345678)
    or just the numeric character ID. The character must be set to Public on D&D Beyond.

    Args:
        url_or_id: D&D Beyond character URL or numeric ID
        player_name: Optional player name to assign to the character
    """
```
- Check active campaign exists
- Call `fetcher.fetch_character(url_or_id)`
- Call `mapper.map_ddb_to_character(ddb_json, player_name)`
- Add character to campaign via storage
- Return formatted summary

**Tool 2: import_character_file**
```python
@mcp.tool()
async def import_character_file(
    file_path: str,
    player_name: str | None = None,
    source_format: str = "dndbeyond",
) -> str:
    """Import a character from a JSON file into the current campaign.

    Currently supports D&D Beyond JSON format. Save the JSON from your browser's
    developer tools (Network tab → character request → Response).

    Args:
        file_path: Path to the JSON file
        player_name: Optional player name to assign to the character
        source_format: Format of the JSON file (default: "dndbeyond")
    """
```
- Check active campaign exists
- Call `fetcher.read_character_file(file_path)`
- Call `mapper.map_ddb_to_character(ddb_json, player_name)`
- Add character to campaign via storage
- Return formatted summary

### Import summary format

```
Character imported: Thorin Ironforge

Summary:
  Class: Fighter 8 (Champion)
  Race: Mountain Dwarf
  HP: 76/76
  AC: 18

  Mapped: 42 fields
  Warnings: 2
    - Homebrew item "Axe of the Ancestors" imported with basic stats only
    - Custom feat "Dwarven Resilience+" not in SRD — imported as text

  Source: D&D Beyond (ID: 12345678)
```

### Integration with storage

- Use `storage.get_current_campaign()` to verify active campaign
- Add character via campaign's character dict
- Call `storage.save()` to persist
- Trigger character callbacks (for sheet sync if active)

### File: `src/dm20_protocol/importers/__init__.py` (update)

Wire the public API functions to the actual implementations:
```python
from .dndbeyond.fetcher import fetch_character, read_character_file
from .dndbeyond.mapper import map_ddb_to_character
```

## Dependencies

- [ ] #159 — Base models (ImportResult)
- [ ] #160 — Fetcher (fetch_character, read_character_file)
- [ ] #161 — Core mapper (map_ddb_to_character)
- [ ] `main.py` — Existing MCP tool registration patterns
- [ ] `storage.py` — Campaign storage for adding characters

## Effort Estimate

- Size: M
- Hours: 3
- Parallel: true (can run alongside #162 after #160 and #161 are done)

## Definition of Done

- [ ] Both MCP tools appear in tool listing
- [ ] URL import works end-to-end for a public DDB character
- [ ] File import works end-to-end for a saved DDB JSON file
- [ ] Character persisted in campaign storage
- [ ] Import summary is clear and informative
- [ ] Error messages guide user to resolution (e.g., "set character to Public")
