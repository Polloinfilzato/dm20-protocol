---
name: Implement summarize_session tool
status: completed
created: 2026-02-01T23:51:23Z
updated: 2026-02-02T11:30:00Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/7
depends_on: [5, 7]
parallel: false
conflicts_with: []
---

# Task: Implement summarize_session tool

## Description

Create a new MCP tool `summarize_session` that accepts a game session transcription and generates a structured `SessionNote` with events, NPC encounters, quest updates, and other relevant information.

## Acceptance Criteria

- [x] Accept `transcription: str` parameter (raw text or file path)
- [x] Accept `session_number: int` parameter
- [x] Accept `detail_level: str` parameter ("brief", "medium", "detailed")
- [x] Accept optional `speaker_map: dict[str, str]` for speaker label mapping
- [x] Load campaign context (characters, quests, locations) for reference
- [x] Filter irrelevant content (delegated to LLM via prompt instructions)
- [x] Extract roleplay-significant events (delegated to LLM via prompt)
- [x] Generate structured `SessionNote` output (via LLM prompt)
- [x] Returns prompt for LLM processing (tool generates prompt, not direct storage)
- [x] Handle Italian language transcriptions (language-agnostic implementation)
- [x] Implement chunking for large transcriptions (>200k chars / ~50k tokens)

## Technical Details

**New tool in `main.py`:**
```python
@server.tool()
async def summarize_session(
    transcription: str,
    session_number: int,
    detail_level: str = "medium",
    speaker_map: dict[str, str] | None = None
) -> str:
    ...
```

**Output structure (SessionNote):**
```json
{
  "session_number": 5,
  "title": "The Letter Revealed",
  "date": "2026-02-02T20:00:00Z",
  "summary": "Brief summary...",
  "events": ["Event 1", "Event 2"],
  "characters_present": ["Aldric", "Bramble"],
  "npcs_encountered": ["Rollo Goodbody"],
  "quest_updates": {"Quest Name": "Progress"},
  "combat_encounters": [],
  "loot_found": [],
  "experience_gained": 150,
  "notes": "DM notes"
}
```

**Chunking strategy:**
- If transcription > 50k tokens, split into chunks
- Process each chunk to extract events
- Merge results with deduplication

**Files affected:**
- `src/gamemaster_mcp/main.py`
- `src/gamemaster_mcp/models.py` (if SessionNote needs updates)

## Dependencies

- [ ] Task 5: Migrate storage.py to use split storage (for sessions/ directory)
- [ ] Task 7: Add format parameter to list tools (for TOON context loading)

## Effort Estimate

- Size: L
- Hours: 8-10
- Parallel: false (depends on Tasks 5 and 7)

## Definition of Done

- [x] Tool implemented and registered
- [x] Italian transcriptions handled (language-agnostic implementation)
- [x] Chunking for large transcriptions working (>200k chars with 40k chunk size, 4k overlap)
- [x] Returns prompt for LLM to generate SessionNote
- [x] Comprehensive unit tests passing (14 tests)
- [x] Existing tests still passing (35 passed, 1 skipped)

## Implementation Notes

The tool generates a structured prompt for an LLM to process, rather than directly
creating the SessionNote. This design:
- Allows the MCP client to use any LLM for summarization
- Provides context via TOON encoding for efficiency
- Includes detailed instructions for event extraction and deduplication
- Handles both small and large transcriptions appropriately

The SessionNote model was updated with new fields:
- `npcs_encountered`: Track NPCs met during session
- `quest_updates`: Map quest names to progress descriptions
- `combat_encounters`: List combat summaries
- `loot_found`: Alias for `treasure_found` (consistency)
