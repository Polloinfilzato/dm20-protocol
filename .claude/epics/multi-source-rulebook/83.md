---
name: FiveToolsSource Model Mapping
status: open
created: 2026-02-12T02:45:03Z
updated: 2026-02-12T02:48:11Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/84
depends_on: [82]
parallel: false
conflicts_with: [82]
---

# Task: FiveToolsSource Model Mapping

## Description

Implement the data parsing and model mapping layer of `FiveToolsSource`, converting 5etools JSON schema into dm20-protocol's Pydantic models. This includes handling 5etools' custom markup format (e.g., `{@dice 1d6}`, `{@spell fireball}`, `{@creature goblin}`) and implementing all query methods required by `RulebookSourceBase`.

## Acceptance Criteria

- [ ] Parse 5etools spell JSON → `SpellDefinition` models
- [ ] Parse 5etools monster/bestiary JSON → `MonsterDefinition` models
- [ ] Parse 5etools class JSON → `ClassDefinition` models
- [ ] Parse 5etools race JSON → `RaceDefinition` models
- [ ] Parse 5etools feat JSON → `FeatDefinition` models
- [ ] Parse 5etools item JSON → `ItemDefinition` models
- [ ] Parse 5etools background JSON → `BackgroundDefinition` models
- [ ] 5etools markup converter: `{@dice 1d6}` → `1d6`, `{@spell fireball}` → `fireball`, etc.
- [ ] `search()` method works across all content categories
- [ ] `content_counts()` returns accurate counts
- [ ] Individual parse failures don't block entire category (graceful degradation)
- [ ] Unit tests for each mapping function with real 5etools JSON samples
- [ ] Unit tests for markup converter covering all common tag types

## Technical Details

### File to modify
`src/dm20_protocol/rulebooks/sources/fivetools.py` (created in #82)

### 5etools markup conversion
5etools descriptions use a custom tag format. A converter is needed:

```python
def _convert_5etools_markup(self, text: str) -> str:
    """Convert 5etools markup tags to plain text."""
    # {@dice 1d6} → 1d6
    # {@damage 2d6} → 2d6
    # {@spell fireball} → fireball
    # {@creature goblin} → goblin
    # {@item longsword} → longsword
    # {@condition poisoned} → poisoned
    # {@skill Perception} → Perception
    # {@dc 15} → DC 15
    # {@hit 5} → +5
    # {@b bold text} → bold text
    # {@i italic text} → italic text
    import re
    text = re.sub(r'\{@\w+\s+([^}|]+?)(?:\|[^}]*)?\}', r'\1', text)
    return text
```

### Mapping challenges
- **Spells**: `level` is an int, `school` uses abbreviations (`"V"` = Evocation), components are structured differently
- **Monsters**: Rich stat blocks with `legendary`, `mythic`, `lair` actions. CR can be `{"cr": "1/4"}` or `{"cr": 30}`
- **Classes**: Deeply nested with `classFeature` arrays referencing external data
- **Races**: `ability` bonuses in different format, `traitTag` arrays

### Query method implementation
Same pattern as `SRDSource` and `CustomSource` — iterate internal dicts, match by query string, yield `SearchResult` objects.

## Dependencies

- [ ] Task #82 (FiveToolsSource Data Downloader) — provides the class structure and raw data

## Effort Estimate

- Size: M
- Hours: 4-6
- Parallel: false (must follow #82)
- Conflicts: #82 (same file)

## Definition of Done

- [ ] All 7 content types mapped from 5etools schema to dm20-protocol models
- [ ] Markup converter handles all common 5etools tags
- [ ] All `RulebookSourceBase` abstract methods implemented
- [ ] Unit tests with real 5etools JSON samples passing
- [ ] Manual smoke test: load 5etools source, query spells/monsters/classes
