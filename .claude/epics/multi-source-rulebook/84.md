---
name: Multi-Source Integration Tests
status: open
created: 2026-02-12T02:45:03Z
updated: 2026-02-12T02:48:11Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/85
depends_on: [80, 81, 82, 83]
parallel: false
conflicts_with: []
---

# Task: Multi-Source Integration Tests

## Description

Write end-to-end integration tests validating the complete multi-source rulebook workflow: loading multiple sources simultaneously, priority-based conflict resolution, cache persistence and offline loading, and MCP tool interaction. This is the final validation task ensuring all pieces work together correctly.

## Acceptance Criteria

- [ ] Test: Load SRD + Open5e simultaneously, verify combined search results
- [ ] Test: Load SRD + 5etools simultaneously, verify combined search results
- [ ] Test: Load all 3 sources, verify priority resolution (last loaded wins)
- [ ] Test: Same spell in multiple sources returns highest-priority version
- [ ] Test: `list_rulebooks` shows all loaded sources with correct counts
- [ ] Test: Unload a source, verify content removed from search results
- [ ] Test: Save manifest with multiple sources, reload from manifest
- [ ] Test: Cache-only load (no network) for both Open5e and 5etools
- [ ] Test: `load_rulebook` MCP tool with each source type
- [ ] Test: Error handling — load with network failure, partial source failure
- [ ] All existing rulebook tests pass unchanged (regression)

## Technical Details

### Test file
`tests/test_multi_source_integration.py`

### Test categories

**1. Multi-source loading**
```python
async def test_load_srd_and_open5e():
    manager = RulebookManager(tmp_campaign_dir)
    await manager.load_source(MockSRDSource())
    await manager.load_source(MockOpen5eSource())
    assert len(manager.sources) == 2
    # Verify combined search returns results from both
    results = manager.search("fireball")
    assert len(results) >= 1
```

**2. Priority resolution**
```python
async def test_priority_last_wins():
    manager = RulebookManager(tmp_campaign_dir)
    await manager.load_source(srd_with_fireball_v1)
    await manager.load_source(open5e_with_fireball_v2)
    spell = manager.get_spell("fireball")
    assert spell.source == "open5e"  # Last loaded wins
```

**3. Manifest persistence**
```python
async def test_manifest_roundtrip():
    manager = RulebookManager(tmp_campaign_dir)
    await manager.load_source(open5e_source)
    await manager.load_source(fivetools_source)
    # Verify manifest saved
    manifest_path = tmp_campaign_dir / "rulebooks" / "manifest.json"
    assert manifest_path.exists()
    # Reload from manifest
    manager2 = await RulebookManager.from_manifest(tmp_campaign_dir)
    assert set(manager2.source_ids) == {"open5e", "5etools"}
```

**4. Cache-only loading**
```python
async def test_offline_load():
    # Pre-populate cache
    ...
    # Load without network (mock httpx to raise)
    source = Open5eSource(cache_dir=pre_populated_cache)
    await source.load()  # Should succeed from cache
    assert source.content_counts().spells > 0
```

### Mock strategy
- Create lightweight mock sources with known test data (5-10 items each)
- Use `pytest` fixtures for temporary campaign directories
- Network tests gated behind `@pytest.mark.network` marker

## Dependencies

- [ ] Task #80 (Open5eSource) — needs working adapter
- [ ] Task #81 (MCP Tool integration) — needs working tool
- [ ] Task #82 + #83 (FiveToolsSource) — needs working adapter

## Effort Estimate

- Size: S
- Hours: 2-3
- Parallel: false (requires all other tasks complete)
- Conflicts: none (new test file only)

## Definition of Done

- [ ] All integration tests passing
- [ ] Existing rulebook test suite unchanged and passing
- [ ] Multi-source priority resolution verified
- [ ] Manifest persistence verified
- [ ] Cache-only loading verified
- [ ] MCP tool integration verified
