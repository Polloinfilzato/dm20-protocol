---
name: "Character Builder & Enhanced create_character"
status: open
created: 2026-02-12T18:15:41Z
updated: 2026-02-12T18:20:09Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/100
depends_on: [98]
parallel: true
conflicts_with: [100]
---

# Task: Character Builder & Enhanced create_character

## Description

Create a `CharacterBuilder` module that auto-populates a Character from RulebookManager data (ClassDefinition, RaceDefinition, BackgroundDefinition). Implement ability score methods (standard_array, point_buy, manual). Enhance the `create_character` MCP tool with new parameters. If no rulebook is loaded, return a clear error. For levels > 1, the builder delegates HP/feature progression to the Level-Up Engine (Task #100), but if that's not yet available, use a simplified internal calculation.

## Acceptance Criteria

- [ ] New `character_builder.py` module with `CharacterBuilder` class
- [ ] Builder reads ClassDefinition → hit die, saving throws, proficiencies, starting equipment, spellcasting info, level 1 features
- [ ] Builder reads RaceDefinition → speed, ability bonuses, languages, racial traits
- [ ] Builder reads BackgroundDefinition → proficiencies, languages, equipment, feature
- [ ] Ability score methods: `standard_array` ([15,14,13,12,10,8] assigned to chosen abilities), `point_buy` (27 points, PHB costs), `manual` (current behavior — user provides scores)
- [ ] Racial ability bonuses applied after base scores
- [ ] HP calculation: level 1 = max hit die + CON mod; levels 2+ = (hit die average + CON mod) per level
- [ ] Returns error with "load rulebook first" message if no rulebook loaded
- [ ] Enhanced `create_character` MCP tool with new params: `subclass`, `subrace`, `background` (now functional), `ability_method`, `ability_assignments`
- [ ] Created character has 20+ populated fields (vs current 6)
- [ ] Tests with SRD loaded: create Wood Elf Ranger level 3, verify all fields

## Technical Details

### New File
- `src/dm20_protocol/character_builder.py`

### CharacterBuilder Class
```python
class CharacterBuilder:
    def __init__(self, rulebook_manager: RulebookManager):
        self.rm = rulebook_manager

    def build(self, name, class_name, race_name, level,
              background=None, subclass=None, subrace=None,
              ability_method="manual", ability_assignments=None,
              **kwargs) -> Character:
        # 1. Validate rulebook is loaded
        # 2. Look up ClassDef, RaceDef, BackgroundDef
        # 3. Generate/assign ability scores
        # 4. Apply racial bonuses
        # 5. Build Character with all populated fields
        # 6. For levels > 1, apply progression
```

### Ability Score Methods
- **standard_array**: Validate 6 unique values from [15,14,13,12,10,8], assign to abilities
- **point_buy**: 27 points, costs: 8→0, 9→1, 10→2, 11→3, 12→4, 13→5, 14→7, 15→9
- **manual**: Pass through raw scores (current behavior)

### MCP Tool Changes (`main.py`)
Add parameters to `create_character`:
- `subclass: str | None = None`
- `subrace: str | None = None`
- `ability_method: str = "manual"` (standard_array, point_buy, manual)
- `ability_assignments: str | None = None` (JSON dict: {"strength": 15, ...})

When ability_method != "manual", use builder. When "manual" AND rulebook loaded, still use builder for auto-population of non-ability fields.

### Files Modified
- `src/dm20_protocol/character_builder.py` (new)
- `src/dm20_protocol/main.py` — enhanced create_character tool

## Dependencies

- [ ] Task #98 (Character Model Extension) — needs Feature model and new fields
- [ ] RulebookManager + SRD data (existing, read-only)

## Effort Estimate

- Size: L
- Hours: 6-8
- Parallel: true (can run parallel with Task #100, #101 after Task #98 completes)

## Definition of Done

- [ ] CharacterBuilder module implemented
- [ ] All 3 ability score methods working
- [ ] Enhanced create_character MCP tool with new parameters
- [ ] Unit tests for builder (each component)
- [ ] Integration test: create character with SRD → 20+ fields populated
- [ ] Test: creation without rulebook → clear error message
- [ ] Test: standard_array and point_buy validation
- [ ] All existing tests pass
- [ ] CHANGELOG.md updated
