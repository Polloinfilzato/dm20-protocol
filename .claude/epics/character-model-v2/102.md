---
name: "Extended update_character & Utility Tools"
status: open
created: 2026-02-12T18:15:41Z
updated: 2026-02-12T18:20:09Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/103
depends_on: [98]
parallel: true
conflicts_with: []
---

# Task: Extended update_character & Utility Tools

## Description

Extend the `update_character` MCP tool to support all new fields added in Task #98, plus list-type operations (add/remove proficiencies, conditions, features, spells, languages). Also add utility operations: spell slot usage/reset (long rest), and condition management. This task closes the gap where the DM currently has to use the `notes` field for structured data.

## Acceptance Criteria

- [ ] `update_character` supports new scalar fields: `experience_points`, `speed`
- [ ] `update_character` supports list add/remove for: `conditions`, `tool_proficiencies`, `skill_proficiencies`, `saving_throw_proficiencies`, `languages`, `features_and_traits`
- [ ] New params for add/remove pattern: `add_conditions`, `remove_conditions`, etc.
- [ ] Spell slot management: `use_spell_slot(character, level)` and `reset_spell_slots(character)` (long rest)
- [ ] `add_spell` and `remove_spell` operations for spells_known management
- [ ] Death save tracking: `add_death_save(character, success: bool)`
- [ ] All operations return clear confirmation messages
- [ ] Validation: can't remove a proficiency that doesn't exist, can't use a spell slot that's empty

## Technical Details

### Extended update_character Parameters (`main.py`)

Add to existing `update_character` tool:
```python
# New scalar fields
experience_points: int | None = None
speed: int | None = None

# List add/remove fields
add_conditions: str | None = None        # JSON list: ["poisoned", "prone"]
remove_conditions: str | None = None     # JSON list: ["poisoned"]
add_skill_proficiencies: str | None = None
remove_skill_proficiencies: str | None = None
add_tool_proficiencies: str | None = None
remove_tool_proficiencies: str | None = None
add_languages: str | None = None
remove_languages: str | None = None
add_saving_throw_proficiencies: str | None = None
remove_saving_throw_proficiencies: str | None = None
```

### Utility Operations (new MCP tools or additions to update_character)

**Option A — Separate tools (recommended for clarity):**
```python
@mcp.tool()
async def use_spell_slot(character_name_or_id: str, slot_level: int) -> str:
    # Increment spell_slots_used[level], validate against spell_slots[level]

@mcp.tool()
async def long_rest(character_name_or_id: str) -> str:
    # Reset spell_slots_used to all 0s
    # Restore hit_dice_remaining (half of total, minimum 1)
    # Reset death saves
    # Restore HP to max (optional, DM may want partial)

@mcp.tool()
async def short_rest(character_name_or_id: str, hit_dice_to_spend: int = 0) -> str:
    # Spend hit dice: roll + CON mod per die, add to current HP
    # Decrement hit_dice_remaining
```

### Files Modified
- `src/dm20_protocol/main.py` — extended update_character + new utility tools

### Considerations
- JSON parsing for list parameters (MCP tools receive strings, need to parse lists)
- Idempotency: adding a condition already present → no-op with info message
- Removing non-existent items → warning message, not error

## Dependencies

- [ ] Task #98 (Character Model Extension) — needs new fields
- [ ] Storage layer (existing, may need minor extensions for list operations)

## Effort Estimate

- Size: S-M
- Hours: 3-4
- Parallel: true (independent of Tasks #99, #100, #101)

## Definition of Done

- [ ] Extended update_character with all new fields
- [ ] List add/remove operations working for all list fields
- [ ] Spell slot use/reset tools implemented
- [ ] Long rest and short rest tools implemented
- [ ] Death save tracking working
- [ ] Unit tests for all new operations
- [ ] Unit tests for edge cases (remove non-existent, double-add, slot overflow)
- [ ] All existing tests pass
- [ ] CHANGELOG.md updated
