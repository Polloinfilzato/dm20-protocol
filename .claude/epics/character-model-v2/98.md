---
name: "Character Model Extension"
status: open
created: 2026-02-12T18:15:41Z
updated: 2026-02-12T18:20:09Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/99
depends_on: []
parallel: false
conflicts_with: []
---

# Task: Character Model Extension

## Description

Extend the Character model in `models.py` with missing D&D 5e fields and add a structured `Feature` model. This is the foundation task — all other tasks depend on this. The key insight is that most fields already exist; we only need to add ~6 truly missing fields and convert `proficiency_bonus` to a computed property.

## Acceptance Criteria

- [ ] New `Feature` model added with fields: name, source, description, level_gained
- [ ] `Character` model extended with: `experience_points` (int, default 0), `speed` (int, default 30), `conditions` (list[str], default []), `tool_proficiencies` (list[str], default []), `features` (list[Feature], default []), `hit_dice_type` (str, default "d8")
- [ ] `proficiency_bonus` becomes a computed property from level: `2 + (level - 1) // 4` (with option to override)
- [ ] `features_and_traits: list[str]` kept for backward compat alongside new `features: list[Feature]`
- [ ] Existing v1 characters load without errors (Pydantic defaults fill missing fields)
- [ ] All existing tests pass with zero regressions
- [ ] New unit tests for: Feature model creation, computed proficiency_bonus at levels 1-20, backward compat loading of v1 JSON

## Technical Details

### Files Modified
- `src/dm20_protocol/models.py` — Add Feature model, extend Character model

### New Feature Model
```python
class Feature(BaseModel):
    name: str                    # "Favored Enemy"
    source: str                  # "Ranger 1" or "Wood Elf"
    description: str = ""        # Full text
    level_gained: int = 1        # Level when acquired
```

### Character Model Changes
```python
# New fields (all with defaults for backward compat)
experience_points: int = 0
speed: int = 30
conditions: list[str] = Field(default_factory=list)
tool_proficiencies: list[str] = Field(default_factory=list)
features: list[Feature] = Field(default_factory=list)
hit_dice_type: str = "d8"  # Extracted from class hit_die for convenience
```

### Proficiency Bonus Computation
Convert `proficiency_bonus: int = 2` to a property that auto-calculates from `character_class.level`, but still allow manual override for edge cases. Consider using a `@computed_field` or a validator that sets the value based on level when not explicitly provided.

### Backward Compatibility
- All new fields have Pydantic defaults → old JSON loads without errors
- `features_and_traits` kept as-is (not removed, not migrated)
- No changes to storage layer or serialization format

## Dependencies

- [ ] None — this is the foundation task

## Effort Estimate

- Size: S
- Hours: 2-3
- Parallel: false (all other tasks depend on this)

## Definition of Done

- [ ] Code implemented in models.py
- [ ] Unit tests for Feature model
- [ ] Unit tests for proficiency_bonus computation (levels 1-20)
- [ ] Backward compat test: load v1 character JSON without errors
- [ ] All existing tests pass (zero regressions)
- [ ] CHANGELOG.md updated
