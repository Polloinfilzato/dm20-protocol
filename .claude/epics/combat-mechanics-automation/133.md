---
name: Concentration Tracking
status: open
created: 2026-02-16T23:30:33Z
updated: 2026-02-16T23:34:50Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/134
depends_on: [132]
parallel: false
conflicts_with: []
---

# Task: Concentration Tracking

## Description

Implement automatic concentration enforcement for spellcasters. This adds a `ConcentrationState` model to track which character is concentrating on which spell, prevents stacking concentration spells, triggers CON saving throws when a concentrating character takes damage, and cleans up associated active effects when concentration breaks.

Builds directly on the Active Effects System (#132).

## Acceptance Criteria

- [ ] `ConcentrationState` Pydantic model: spell_name, effect_ids (ActiveEffect IDs to remove on break), started_round
- [ ] New field on Character model: `concentration: ConcentrationState | None = None`
- [ ] `ConcentrationTracker.start_concentration(character, spell_name, effect_ids)` sets concentration state
- [ ] Starting new concentration while already concentrating: ends old concentration first (removes old effects), then starts new
- [ ] `ConcentrationTracker.check_concentration(character, damage_taken)` calculates DC = max(10, damage // 2), rolls CON save
- [ ] CON save uses character's CON modifier + proficiency if proficient in CON saves + any active effect modifiers (via EffectsEngine)
- [ ] On failed save: concentration breaks → all associated ActiveEffects removed → ConcentrationState cleared
- [ ] On successful save: concentration continues, return success result
- [ ] Concentration automatically breaks on: incapacitated condition, death (HP = 0), or character killed
- [ ] `get_character` output includes concentration info when active (spell name, rounds active)
- [ ] Backward compatible: characters without `concentration` field load as None
- [ ] Unit tests: start/break concentration, CON save mechanics, auto-break on conditions, effect cleanup

## Technical Details

### New files
- `src/dm20_protocol/combat/concentration.py` — ConcentrationTracker class

### Modified files
- `src/dm20_protocol/models.py` — Add `ConcentrationState` model; add `concentration` field to Character

### Key design decisions
- `ConcentrationTracker` uses `EffectsEngine` to calculate effective CON save bonus (base + effects)
- CON save roll uses the existing `roll_dice` utility internally
- When concentration breaks, `remove_effect()` is called for each effect_id in the ConcentrationState
- The tracker is called by the Combat Pipeline (#134) whenever damage is applied to a concentrating character

### Tests
- `tests/test_combat_concentration.py`

## Dependencies

- [ ] #132 (Active Effects System) — needs ActiveEffect model and EffectsEngine

## Effort Estimate

- Size: S
- Hours: 3-4
- Parallel: false (depends on #132)
