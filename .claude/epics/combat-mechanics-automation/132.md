---
name: Active Effects System
status: completed
created: 2026-02-16T23:30:33Z
updated: 2026-02-16T23:34:50Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/133
depends_on: []
parallel: true
conflicts_with: [133]
---

# Task: Active Effects System

## Description

Create the foundational Active Effects engine for dm20-protocol. This includes the `ActiveEffect` Pydantic model, the stateless `EffectsEngine` that calculates effective stats from base + modifiers, all 14 SRD condition definitions with mechanical effects, duration tracking with auto-expiration on turn/round advancement, and persistence via the existing campaign storage.

This is the foundation that Concentration Tracking (#133), Combat Pipeline (#134), and all downstream tasks depend on.

## Acceptance Criteria

- [ ] `ActiveEffect` Pydantic model with: id, name, source, modifiers, duration_type, duration_remaining, grants_advantage, grants_disadvantage, immunities, stackable
- [ ] `Modifier` model: stat (e.g., "attack_roll", "armor_class", "strength"), operation (add, set, dice), value (int or dice notation like "1d4")
- [ ] `EffectsEngine.effective_stat(character, stat_name)` returns base stat + all applicable modifiers
- [ ] `EffectsEngine.has_advantage(character, check_type)` / `has_disadvantage(character, check_type)` resolves from active effects
- [ ] `EffectsEngine.tick_effects(character, event="turn"|"round")` decrements durations and removes expired effects
- [ ] All 14 SRD conditions defined as predefined ActiveEffect templates: blinded, charmed, deafened, exhaustion, frightened, grappled, incapacitated, invisible, paralyzed, petrified, poisoned, prone, restrained, stunned
- [ ] `apply_effect(character, effect)` adds effect respecting stacking rules (same-name non-stackable effects don't duplicate)
- [ ] `remove_effect(character, effect_id)` removes specific effect by ID
- [ ] New field on Character model: `active_effects: list[ActiveEffect] = Field(default_factory=list)`
- [ ] Existing `conditions: list[str]` preserved for backward compatibility
- [ ] Effects persist via normal campaign save/load (Pydantic serialization)
- [ ] Campaigns without `active_effects` field load cleanly (default empty list)
- [ ] Unit tests: modifier stacking, duration expiration, SRD condition mechanics, advantage/disadvantage resolution, backward compat

## Technical Details

### New files
- `src/dm20_protocol/combat/__init__.py`
- `src/dm20_protocol/combat/effects.py` — ActiveEffect, Modifier, EffectsEngine, SRD_CONDITIONS dict

### Modified files
- `src/dm20_protocol/models.py` — Add `ActiveEffect`, `Modifier` models; add `active_effects` field to Character

### Key design decisions
- `EffectsEngine` is **stateless**: takes a Character, returns computed values. No caching, no mutable state.
- SRD conditions are stored as a `SRD_CONDITIONS: dict[str, ActiveEffect]` constant. When applying a condition, a copy is made with a unique ID.
- Advantage + disadvantage on the same roll cancel out (5e rule).
- `Modifier.operation` supports: `add` (additive), `set` (override to value), `dice` (roll extra dice, e.g., Bless +1d4).
- Duration types: `rounds` (tick on combatant's turn), `minutes` (tick on round), `concentration` (no auto-tick), `permanent` (never expires).

### Tests
- `tests/test_combat_effects.py`

## Dependencies

- None (this is the first task in the epic)

## Effort Estimate

- Size: L
- Hours: 8-10
- Parallel: true (can run alongside #135, #136)
