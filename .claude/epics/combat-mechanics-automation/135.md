---
name: Encounter Builder
status: completed
created: 2026-02-16T23:30:33Z
updated: 2026-02-16T23:34:50Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/136
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Encounter Builder

## Description

Implement a CR-based encounter building tool that calculates XP budgets, selects monsters from loaded rulebooks, applies group multipliers, and suggests balanced encounter compositions. Uses the standard 5e encounter building rules (DMG Chapter 3).

This task is fully independent of the Active Effects chain and can be developed in parallel.

## Acceptance Criteria

- [ ] XP threshold table per character level (1-20) for Easy, Medium, Hard, Deadly difficulties (from SRD/DMG)
- [ ] `calculate_xp_budget(party_levels: list[int], difficulty: str)` → total XP budget for the encounter
- [ ] Monster count multiplier table (1 monster = x1, 2 = x1.5, 3-6 = x2, 7-10 = x2.5, 11-14 = x3, 15+ = x4)
- [ ] `build_encounter(party_size, party_level, difficulty, filters)` → `EncounterSuggestion` with:
  - XP budget
  - 3 alternative monster compositions (varied tactical styles)
  - Adjusted XP and actual difficulty classification for each suggestion
- [ ] Monster selection queries loaded rulebooks via existing `search_rules(category="monster")`
- [ ] Filter monsters by: CR range, environment/terrain type, creature type (beast, undead, etc.)
- [ ] Each suggestion includes: monster names, count, individual CR, individual XP, total adjusted XP
- [ ] Difficulty classification: compare adjusted XP vs party thresholds → Easy/Medium/Hard/Deadly
- [ ] Handle edge cases: party of 1-2 (increase multiplier by one step), party of 6+ (decrease by one step)
- [ ] Works without loaded rulebooks: returns XP budget and thresholds only (no monster suggestions)
- [ ] Unit tests: XP budget calculation, multiplier application, difficulty classification, party size adjustments

## Technical Details

### New files
- `src/dm20_protocol/combat/encounter_builder.py` — XP tables, EncounterSuggestion, build_encounter()

### Modified files
- None

### Key design decisions
- XP threshold tables are hardcoded constants (they're small and never change within an edition)
- Monster selection is a best-fit algorithm: find combinations of monsters whose adjusted XP is closest to the budget without exceeding it
- The builder tries 3 strategies: (1) single powerful monster, (2) mixed group (1 leader + minions), (3) swarm of weaker creatures
- Uses existing `search_rules` infrastructure to query monster stat blocks — no new data layer needed
- Results are plain Pydantic models — no narrative generation

### Tests
- `tests/test_combat_encounter_builder.py`

## Dependencies

- None (fully independent — only needs existing rulebook search infrastructure)

## Effort Estimate

- Size: M
- Hours: 5-6
- Parallel: true (can run alongside any other task)
