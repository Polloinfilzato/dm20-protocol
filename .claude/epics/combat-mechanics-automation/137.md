---
name: ASCII Tactical Maps
status: completed
created: 2026-02-16T23:30:33Z
updated: 2026-02-16T23:34:50Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/138
depends_on: [136]
parallel: false
conflicts_with: []
---

# Task: ASCII Tactical Maps

## Description

Implement a text-based tactical map system that renders combat scenes as monospaced ASCII art. Includes a grid model with terrain features, token placement for combatants, movement validation with speed limits and difficult terrain, opportunity attack detection, and a `show_map` rendering function.

Builds on the Positioning & AoE Engine (#136) for coordinate data.

## Acceptance Criteria

- [ ] `TacticalGrid` model: width, height (in squares), 2D array of `Cell` objects
- [ ] `Cell` model: terrain (open, wall, door, difficult_terrain, obstacle, water), occupant (participant name or None)
- [ ] `AsciiMapRenderer.render(grid, participants, highlight_aoe=None)` → formatted string
- [ ] Token labels: `P1`-`P9` for players, `E1`-`E9` for enemies, `A1`-`A9` for allies (auto-assigned)
- [ ] Terrain symbols: `.` (open), `#` (wall), `D` (door), `~` (difficult terrain), `X` (obstacle), `≈` (water)
- [ ] Grid includes coordinate labels (A-Z columns, 1-N rows) for easy reference
- [ ] Legend included in output explaining all symbols present in current map
- [ ] `highlight_aoe` parameter overlays an AoE shape on the map (e.g., `*` for Fireball radius)
- [ ] Movement validation: `validate_move(participant, from_pos, to_pos, grid)` checks:
  - Distance <= speed (difficult terrain costs double)
  - Path not blocked by walls/obstacles
  - No walking through occupied squares (unless ally)
- [ ] Opportunity attack detection: `check_opportunity_attacks(mover, from_pos, to_pos, participants)` returns list of threatening combatants
- [ ] Grid can be manually defined (DM provides layout) or auto-generated (simple rectangle with random obstacles)
- [ ] Grid serializable for persistence across turns
- [ ] Unit tests: rendering, movement validation, opportunity attacks, terrain effects, AoE overlay

## Technical Details

### New files
- `src/dm20_protocol/combat/ascii_map.py` — TacticalGrid, Cell, AsciiMapRenderer, movement validation

### Modified files
- None (uses Position from positioning.py via imports)

### Key design decisions
- Renderer outputs a single string with newlines — suitable for chat/CLI display
- Grid is stored as a flat list (row-major) for efficient serialization, with accessor methods `grid.at(x, y)` and `grid.set(x, y, cell)`
- Default grid size: 20x20 (100ft x 100ft), configurable
- Movement uses simple line-of-sight: straight path checked for walls. No complex pathfinding (keep it simple for text-based play).
- Opportunity attacks use 5e rules: leaving a creature's 5ft reach without Disengage triggers OA
- Auto-generation: rectangular room, random 10-15% wall/obstacle coverage, guaranteed clear center for combat

### Example Output
```
    A  B  C  D  E  F  G  H
 1  #  #  #  #  #  D  #  #
 2  #  .  .  .  .  .  .  #
 3  #  .  P1 .  .  E1 .  #
 4  #  .  .  ~  ~  .  .  #
 5  #  .  P2 ~  ~  E2 .  #
 6  #  .  .  .  .  .  E3 #
 7  #  #  #  #  #  #  #  #

Legend: # Wall | D Door | ~ Difficult | P1 Aldric (Fighter) | P2 Lyra (Wizard) | E1 Goblin | E2 Goblin | E3 Hobgoblin
```

### Tests
- `tests/test_combat_ascii_map.py`

## Dependencies

- [ ] #136 (Positioning & AoE) — uses Position model and distance calculations

## Effort Estimate

- Size: M
- Hours: 5-7
- Parallel: false (depends on #136)
