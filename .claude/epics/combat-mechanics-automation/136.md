---
name: Positioning and AoE Engine
status: open
created: 2026-02-16T23:30:33Z
updated: 2026-02-16T23:34:50Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/137
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Positioning and AoE Engine

## Description

Implement a position tracking system for combat participants and an Area-of-Effect engine that calculates which creatures are affected by AoE spells/abilities. Includes standard 5e AoE shapes (sphere, cube, cone, line, cylinder) and a relative positioning fallback for when exact coordinates aren't available.

## Acceptance Criteria

- [ ] `Position(x: int, y: int)` model for grid-based coordinates (5ft per square)
- [ ] New optional field on Character: `position: Position | None = None`
- [ ] Combat participants can be assigned positions at combat start or during combat
- [ ] `distance(pos_a, pos_b)` calculates distance in feet (diagonal = 5ft per 5e variant, or Pythagorean)
- [ ] AoE shape definitions:
  - Sphere: origin point + radius → all positions within radius
  - Cube: origin point + size → all positions within cube
  - Cone: origin point + direction + length → positions in cone area
  - Line: origin point + direction + length + width → positions in line
  - Cylinder: origin point + radius + height → positions in cylinder
- [ ] `calculate_aoe_targets(shape, origin, participants)` → list of affected participant names
- [ ] Report affected targets before applying effects (return list for confirmation)
- [ ] **Relative positioning fallback**: when positions are None, use proximity tags:
  - `adjacent` (0-5ft), `nearby` (10-20ft), `far` (25-60ft), `distant` (60ft+)
  - AI DM assigns proximity tags; AoE uses them for rough target selection
- [ ] `set_positions(participants: dict[str, Position])` bulk-set positions for combat start
- [ ] `move_participant(name, new_position, speed)` validates movement against speed limit
- [ ] Unit tests: distance calculation, each AoE shape, relative fallback, movement validation

## Technical Details

### New files
- `src/dm20_protocol/combat/positioning.py` — Position, AoEShape, calculate_aoe_targets(), distance()

### Modified files
- `src/dm20_protocol/models.py` — Add `position: Position | None = None` to Character

### Key design decisions
- Grid uses 5ft squares (standard 5e). Position (0,0) is top-left of the battle area.
- AoE shapes are defined as abstract classes with a `contains(position)` method. Each shape (Sphere, Cube, Cone, Line, Cylinder) implements this.
- The relative positioning system uses an enum `Proximity` and simple rules: "adjacent" creatures are always in melee AoE, "nearby" are in 20ft radius AoE, etc.
- Positions are **optional** — the entire system degrades gracefully when positions are None.
- No coupling with ASCII maps (that's #137) — this task is pure geometry.

### Tests
- `tests/test_combat_positioning.py`

## Dependencies

- None (independent of Active Effects chain)

## Effort Estimate

- Size: M
- Hours: 5-7
- Parallel: true (can run alongside #132, #135)
