---
name: Combat Action Pipeline
status: open
created: 2026-02-16T23:30:33Z
updated: 2026-02-16T23:34:50Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/135
depends_on: [132]
parallel: false
conflicts_with: []
---

# Task: Combat Action Pipeline

## Description

Implement a single-call combat resolution pipeline that handles the full attack→hit/miss→damage→apply→trigger flow. This replaces the current multi-tool-call approach (roll_dice → check AC → roll damage → update_character) with one orchestrated `resolve_attack()` call that returns a structured `CombatResult`.

Supports melee attacks, ranged attacks, spell attacks (attack roll), and saving throw spells. Applies all relevant modifiers from active effects, handles advantage/disadvantage, critical hits, resistance/vulnerability/immunity.

## Acceptance Criteria

- [ ] `CombatResult` model: attacker, target, hit (bool), attack_roll, natural_roll, damage, damage_type, critical, effects_triggered, concentration_check (if applicable)
- [ ] `resolve_attack(attacker, target, weapon_or_spell, storage)` → `CombatResult` — full attack flow
- [ ] `resolve_save_spell(caster, targets, spell, save_ability, storage)` → list[`SpellSaveResult`] — saving throw spells
- [ ] Attack roll = d20 + ability mod + proficiency + effect modifiers (all via EffectsEngine)
- [ ] Advantage/disadvantage from active effects auto-detected and applied (roll 2d20, take best/worst)
- [ ] Advantage + disadvantage cancel out per 5e rules
- [ ] Natural 20 = critical hit (double damage dice, not modifiers)
- [ ] Natural 1 = auto-miss regardless of modifiers
- [ ] Damage roll includes weapon/spell base + ability mod + effect modifiers (e.g., Hunter's Mark +1d6)
- [ ] Resistance halves damage (rounded down), vulnerability doubles, immunity negates
- [ ] After damage applied: if target is concentrating, trigger ConcentrationTracker.check_concentration()
- [ ] If target drops to 0 HP: mark as unconscious (add incapacitated condition via effects system)
- [ ] Saving throw spells: target rolls save vs caster's spell save DC (8 + proficiency + spellcasting ability mod)
- [ ] On failed save: full damage/effect; on success: half damage (if applicable), no effect
- [ ] Pipeline returns structured data only — no narrative text generation
- [ ] Unit tests: full attack flow, crits, misses, saves, resistance, concentration trigger, advantage resolution

## Technical Details

### New files
- `src/dm20_protocol/combat/pipeline.py` — CombatResult, SpellSaveResult, resolve_attack(), resolve_save_spell()

### Modified files
- None directly (uses EffectsEngine and ConcentrationTracker via imports)

### Key design decisions
- Pipeline is **stateless functions** — takes character objects + storage reference, returns results
- Internally calls `roll_dice` for all rolls (leveraging existing dice engine)
- Does NOT call `update_character` — returns the damage/effect changes and lets the caller apply them. This keeps the pipeline pure and testable.
- Weapon stats come from Character.equipment["weapon_main"] (existing Item model, uses `properties` dict for damage dice, damage type, finesse flag, etc.)
- Spell attack vs save is determined by spell data (if spell has attack roll → resolve_attack path; if spell requires save → resolve_save_spell path)

### Tests
- `tests/test_combat_pipeline.py`

## Dependencies

- [ ] #132 (Active Effects System) — needs EffectsEngine for modifier calculation
- [ ] #133 (Concentration Tracking) — needs ConcentrationTracker for post-damage checks (can stub if #133 not done yet)

## Effort Estimate

- Size: L
- Hours: 8-10
- Parallel: false (depends on #132; can start before #133 by stubbing concentration)
