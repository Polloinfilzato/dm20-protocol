---
name: MCP Tools and Agent Integration
status: completed
created: 2026-02-16T23:30:33Z
updated: 2026-02-16T23:34:50Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/139
depends_on: [134, 135, 136]
parallel: false
conflicts_with: []
---

# Task: MCP Tools and Agent Integration

## Description

Register new MCP tools (`combat_action`, `build_encounter`, `show_map`, `apply_effect`, `remove_effect`) in `main.py` and wire the combat subsystems into the Claudmaster agent framework. The Arbiter agent uses the combat pipeline for NPC attack resolution, the Narrator agent receives structured CombatResult data for narration, and the turn_manager hooks into effect duration tick-down.

This is the integration layer that exposes all combat mechanics to users and AI agents.

## Acceptance Criteria

### MCP Tools
- [ ] `combat_action(attacker, target, action_type, weapon_or_spell)` — resolves a combat action via the pipeline, applies results to characters, returns structured outcome
- [ ] `build_encounter(party_size, party_level, difficulty, creature_type?, environment?)` — returns encounter suggestions with monster compositions
- [ ] `show_map(highlight_aoe?)` — renders current tactical map; returns "No tactical map active" if positions not set
- [ ] `apply_effect(character_name, effect_name, source?, duration?, custom_modifiers?)` — applies an ActiveEffect (SRD condition or custom)
- [ ] `remove_effect(character_name, effect_id_or_name)` — removes an active effect
- [ ] All tools return formatted strings suitable for chat display
- [ ] All tools handle missing data gracefully (no combat active, no rulebook loaded, etc.)

### Agent Integration
- [ ] Arbiter agent: `resolve_npc_action()` method uses combat pipeline for NPC attacks during combat
- [ ] Arbiter agent: receives CombatResult and formats mechanical summary
- [ ] Narrator agent: receives CombatResult and generates descriptive narration (leveraging existing combat_narrator.py damage severity)
- [ ] Turn manager: `next_turn()` calls `EffectsEngine.tick_effects()` for the character whose turn just ended
- [ ] Turn manager: round advancement ticks round-based effect durations
- [ ] Effect duration info included in turn transition messages (e.g., "Bless: 3 rounds remaining")

### Backward Compatibility
- [ ] Existing `start_combat`, `next_turn`, `end_combat`, `roll_dice` tools unchanged
- [ ] `combat_action` is a new tool — doesn't replace manual roll_dice workflow
- [ ] Campaigns without combat/ data load and work as before
- [ ] Integration tests: full combat round using new tools (start → combat_action → next_turn → effects tick → end)

## Technical Details

### Modified files
- `src/dm20_protocol/main.py` — Register 5 new MCP tools
- `src/dm20_protocol/claudmaster/agents/arbiter.py` — Add combat pipeline integration
- `src/dm20_protocol/claudmaster/combat_narrator.py` — Accept CombatResult input for narration
- `src/dm20_protocol/claudmaster/turn_manager.py` — Add effect tick-down hook on turn advancement
- `src/dm20_protocol/main.py` existing `next_turn()` function — call EffectsEngine.tick_effects()

### Key design decisions
- `combat_action` tool is the user-facing entry point. It calls the pipeline, applies results (update HP, add/remove effects), triggers concentration checks, and returns a formatted summary.
- The tool does NOT generate narrative — it returns mechanical results. The Narrator agent (called separately by the orchestrator) adds flavor.
- `apply_effect` is useful for manual DM overrides or custom homebrew effects outside of combat.
- `show_map` returns plain text — no special formatting beyond monospace.
- Arbiter integration is a method, not a standalone tool. The orchestrator calls the Arbiter, which internally uses the pipeline.

### Tests
- `tests/test_combat_integration.py` — End-to-end combat flow
- `tests/test_combat_tools.py` — MCP tool input/output validation

## Dependencies

- [ ] #134 (Combat Pipeline) — combat_action tool wraps the pipeline
- [ ] #135 (Encounter Builder) — build_encounter tool wraps the builder
- [ ] #136 (Positioning & AoE) — show_map tool wraps the renderer
- [ ] #132 (Active Effects) — apply_effect/remove_effect tools
- [ ] #133 (Concentration) — concentration checks triggered by combat_action

## Effort Estimate

- Size: M
- Hours: 5-6
- Parallel: false (final integration task — depends on all others)
