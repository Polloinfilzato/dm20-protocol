---
name: Rulebook Source Abstraction
status: completed
created: 2026-02-02T03:47:06Z
updated: 2026-02-02T03:47:06Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/13
depends_on: [12]
parallel: false
conflicts_with: []
---

# Task: Rulebook Source Abstraction

## Description

Create the abstract base class for rulebook sources and implement the CustomSource for loading local JSON/YAML files. This establishes the plugin architecture that allows different data sources (SRD API, Open5e, local files) to be used interchangeably.

## Acceptance Criteria

- [ ] Create `src/gamemaster_mcp/rulebooks/sources/base.py` with abstract `RulebookSource`
- [ ] Create `src/gamemaster_mcp/rulebooks/sources/custom.py` with `CustomSource` implementation
- [ ] Abstract base defines: `load()`, `get_class()`, `get_race()`, `get_spell()`, `get_monster()`, `search()`
- [ ] CustomSource loads JSON files from campaign's `rulebooks/custom/` directory
- [ ] CustomSource loads YAML files (requires pyyaml dependency)
- [ ] Schema validation for custom rulebook files
- [ ] Graceful error handling for malformed files
- [ ] Support partial rulebooks (e.g., file with only custom races)

## Technical Details

### File Structure
```
src/gamemaster_mcp/rulebooks/sources/
├── __init__.py
├── base.py      # Abstract RulebookSource
└── custom.py    # Local file loader
```

### Abstract Base Class

```python
from abc import ABC, abstractmethod
from typing import Iterator
from ..models import ClassDefinition, RaceDefinition, SpellDefinition, MonsterDefinition

class RulebookSource(ABC):
    """Abstract base class for rulebook data sources."""

    source_id: str  # e.g., "srd-2014", "open5e", "custom-homebrew"
    source_type: str  # "srd", "open5e", "custom"

    @abstractmethod
    async def load(self) -> None:
        """Load/refresh data from source."""
        pass

    @abstractmethod
    def get_class(self, index: str) -> ClassDefinition | None:
        """Get class by index (e.g., 'wizard')."""
        pass

    @abstractmethod
    def get_race(self, index: str) -> RaceDefinition | None:
        """Get race by index (e.g., 'elf')."""
        pass

    @abstractmethod
    def search(self, query: str, category: str | None = None) -> Iterator[dict]:
        """Search across all content."""
        pass
```

### Custom Rulebook Schema

```json
{
  "$schema": "gamemaster-mcp/rulebook-v1",
  "name": "My Homebrew",
  "version": "1.0",
  "content": {
    "classes": [...],
    "races": [...],
    "spells": [...],
    "monsters": [...],
    "feats": [...],
    "backgrounds": [...],
    "items": [...]
  }
}
```

### YAML Support

```yaml
# house_rules.yaml
$schema: gamemaster-mcp/rulebook-v1
name: House Rules
version: "1.0"
content:
  races:
    - name: Aetherborn
      ability_bonuses:
        charisma: 2
```

## Dependencies

- [ ] Task 11: Rulebook Data Models (must have models to instantiate)
- [ ] External: pyyaml>=6.0 (add to pyproject.toml)

## Effort Estimate

- Size: S
- Parallel: false (depends on models)

## Definition of Done

- [ ] Abstract base class with complete interface
- [ ] CustomSource loads JSON files correctly
- [ ] CustomSource loads YAML files correctly
- [ ] Schema validation rejects malformed files
- [ ] Unit tests for CustomSource with fixture files
- [ ] pyyaml added to dependencies
