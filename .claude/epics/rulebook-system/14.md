---
name: SRD API Client
status: completed
created: 2026-02-02T03:47:06Z
updated: 2026-02-02T05:30:00Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/14
depends_on: [12, 13]
parallel: false
conflicts_with: []
---

# Task: SRD API Client

## Description

Implement the SRD source that fetches data from the 5e-srd-api (https://www.dnd5eapi.co/). This client should cache responses locally for offline use and performance. Support both 2014 and 2024 SRD versions.

## Acceptance Criteria

- [x] Create `src/gamemaster_mcp/rulebooks/sources/srd.py` with `SRDSource` class
- [x] Use httpx for async HTTP requests
- [x] Fetch and parse all 12 SRD classes with full feature progression
- [x] Fetch and parse all 9 SRD races with traits and subraces
- [x] Fetch and parse all 319 SRD spells
- [x] Fetch and parse all SRD monsters (322 creatures)
- [x] Fetch and parse equipment, feats, backgrounds
- [x] Cache responses to `dnd_data/rulebook_cache/srd_{version}/`
- [x] Cache invalidation based on version/timestamp
- [x] Work fully offline when cache exists
- [x] Handle API rate limits (429 responses) with exponential backoff
- [x] Handle API errors gracefully (timeouts, 5xx errors)
- [x] Support version parameter: "2014" (default) or "2024"

## Technical Details

### API Endpoints

Base URL: `https://www.dnd5eapi.co/api/`

| Endpoint | Description |
|----------|-------------|
| `/classes` | List all classes |
| `/classes/{index}` | Class details |
| `/classes/{index}/levels` | Level-by-level features |
| `/races` | List all races |
| `/races/{index}` | Race details |
| `/spells` | List all spells |
| `/spells/{index}` | Spell details |
| `/monsters` | List all monsters |
| `/monsters/{index}` | Monster details |

### Caching Strategy

```python
class SRDSource(RulebookSource):
    def __init__(self, version: str = "2014", cache_dir: Path | None = None):
        self.version = version
        self.cache_dir = cache_dir or Path("dnd_data/rulebook_cache") / f"srd_{version}"
        self._client: httpx.AsyncClient | None = None

    async def _fetch_with_cache(self, endpoint: str) -> dict:
        cache_file = self.cache_dir / f"{endpoint.replace('/', '_')}.json"

        if cache_file.exists():
            return json.loads(cache_file.read_text())

        response = await self._client.get(f"{BASE_URL}{endpoint}")
        response.raise_for_status()
        data = response.json()

        cache_file.parent.mkdir(parents=True, exist_ok=True)
        cache_file.write_text(json.dumps(data))

        return data
```

### Rate Limit Handling

```python
async def _fetch_with_retry(self, endpoint: str, max_retries: int = 3) -> dict:
    for attempt in range(max_retries):
        try:
            return await self._fetch_with_cache(endpoint)
        except httpx.HTTPStatusError as e:
            if e.response.status_code == 429:
                wait = 2 ** attempt
                await asyncio.sleep(wait)
            else:
                raise
    raise Exception(f"Max retries exceeded for {endpoint}")
```

### Data Mapping

Map API responses to our Pydantic models:

```python
def _map_class(self, data: dict) -> ClassDefinition:
    return ClassDefinition(
        index=data["index"],
        name=data["name"],
        hit_die=data["hit_die"],
        proficiencies=[p["name"] for p in data["proficiencies"]],
        # ... etc
        source=f"srd-{self.version}"
    )
```

## Dependencies

- [x] Task 12: Rulebook Data Models
- [x] Task 13: Source Abstraction (base class)
- [x] External: httpx>=0.24 (add to pyproject.toml)

## Effort Estimate

- Size: M
- Parallel: false (depends on models and base class)

## Definition of Done

- [x] SRDSource implements full RulebookSource interface
- [x] All SRD content types can be fetched
- [x] Caching works correctly (second load is fast)
- [x] Offline mode works with existing cache
- [x] Rate limiting handled without crashes
- [x] httpx added to dependencies
- [x] Integration tests with mocked responses
- [x] One integration test with real API (marked slow)
