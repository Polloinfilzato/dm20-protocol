---
name: Character Validator
status: completed
created: 2026-02-02T03:47:06Z
updated: 2026-02-02T03:47:06Z
github: https://github.com/Polloinfilzato/dm20-protocol/issues/17
depends_on: [15]
parallel: true
conflicts_with: [15]
---

# Task: Character Validator

## Description

Implement validation logic that checks characters against loaded rulebooks. The validator produces detailed reports with errors, warnings, and suggestions. Validation is informational (warnings) not blocking.

## Acceptance Criteria

- [ ] Create `src/gamemaster_mcp/rulebooks/validators.py`
- [ ] Validate class exists in loaded rulebooks
- [ ] Validate subclass is valid for the class
- [ ] Validate race exists in loaded rulebooks
- [ ] Validate subrace is valid for the race (if applicable)
- [ ] Check ability score minimums for multiclass requirements
- [ ] Detect missing class features for character's level
- [ ] Return structured ValidationReport with errors, warnings, info
- [ ] Provide suggestions for fixing invalid configurations
- [ ] Handle characters with homebrew content gracefully

## Technical Details

### Validator Class

```python
from dataclasses import dataclass
from enum import Enum

class ValidationSeverity(Enum):
    ERROR = "error"      # Character cannot be rules-legal
    WARNING = "warning"  # Possible issue, but allowed
    INFO = "info"        # Informational note

@dataclass
class ValidationIssue:
    severity: ValidationSeverity
    type: str           # e.g., "invalid_subclass", "missing_feature"
    message: str        # Human-readable message
    field: str          # e.g., "character_class.subclass"
    suggestion: str | None = None

@dataclass
class ValidationReport:
    character_id: str
    valid: bool         # True if no errors (warnings OK)
    issues: list[ValidationIssue]

    @property
    def errors(self) -> list[ValidationIssue]:
        return [i for i in self.issues if i.severity == ValidationSeverity.ERROR]

    @property
    def warnings(self) -> list[ValidationIssue]:
        return [i for i in self.issues if i.severity == ValidationSeverity.WARNING]
```

### Validator Implementation

```python
class CharacterValidator:
    def __init__(self, manager: RulebookManager):
        self.manager = manager

    def validate(self, character: Character) -> ValidationReport:
        issues = []

        # Validate class
        issues.extend(self._validate_class(character))

        # Validate race
        issues.extend(self._validate_race(character))

        # Validate ability scores
        issues.extend(self._validate_ability_scores(character))

        # Validate features
        issues.extend(self._validate_features(character))

        return ValidationReport(
            character_id=character.id,
            valid=not any(i.severity == ValidationSeverity.ERROR for i in issues),
            issues=issues
        )

    def _validate_class(self, character: Character) -> list[ValidationIssue]:
        issues = []
        char_class = character.character_class

        if not char_class:
            return issues

        class_def = self.manager.get_class(char_class.name.lower())

        if not class_def:
            issues.append(ValidationIssue(
                severity=ValidationSeverity.WARNING,
                type="unknown_class",
                message=f"Class '{char_class.name}' not found in loaded rulebooks",
                field="character_class.name",
                suggestion="This may be homebrew content. Load a custom rulebook to validate."
            ))
        elif char_class.subclass:
            if char_class.subclass.lower() not in [s.lower() for s in class_def.subclasses]:
                issues.append(ValidationIssue(
                    severity=ValidationSeverity.ERROR,
                    type="invalid_subclass",
                    message=f"Subclass '{char_class.subclass}' is not valid for {char_class.name}",
                    field="character_class.subclass",
                    suggestion=f"Available subclasses: {', '.join(class_def.subclasses)}"
                ))

        return issues
```

### Multiclass Requirements

```python
MULTICLASS_REQUIREMENTS = {
    "barbarian": {"strength": 13},
    "bard": {"charisma": 13},
    "cleric": {"wisdom": 13},
    "druid": {"wisdom": 13},
    "fighter": {"strength": 13, "dexterity": 13},  # OR
    "monk": {"dexterity": 13, "wisdom": 13},
    "paladin": {"strength": 13, "charisma": 13},
    "ranger": {"dexterity": 13, "wisdom": 13},
    "rogue": {"dexterity": 13},
    "sorcerer": {"charisma": 13},
    "warlock": {"charisma": 13},
    "wizard": {"intelligence": 13},
}
```

### Validation Report Output

```json
{
  "character_id": "char_abc123",
  "valid": false,
  "issues": [
    {
      "severity": "error",
      "type": "invalid_subclass",
      "message": "Subclass 'Bladesinger' is not valid for Wizard",
      "field": "character_class.subclass",
      "suggestion": "Available subclasses in SRD: School of Evocation"
    },
    {
      "severity": "warning",
      "type": "missing_feature",
      "message": "Level 5 Wizard should have 'Arcane Recovery'",
      "field": "features_and_traits",
      "suggestion": "Add 'Arcane Recovery' to character features"
    }
  ]
}
```

## Dependencies

- [ ] Task 14: RulebookManager (needed to query rules)

## Effort Estimate

- Size: M
- Parallel: true (can run with Task 15)

## Definition of Done

- [ ] CharacterValidator class with full validation logic
- [ ] ValidationReport dataclass with structured output
- [ ] Class/subclass validation works
- [ ] Race/subrace validation works
- [ ] Ability score requirements checked
- [ ] Missing features detected
- [ ] Suggestions provided for errors
- [ ] Unit tests with various character configurations
- [ ] Test with SRD-legal and SRD-illegal characters
